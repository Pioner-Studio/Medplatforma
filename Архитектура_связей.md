# АРХИТЕКТУРА СВЯЗЕЙ МЕДПЛАТФОРМЫ

## ФИНАНСЫ (Finance)

### Файлы:
- **routes_finance.py** - основной модуль финансов
- **templates/finance/** - шаблоны (list.html, add.html, cashbox.html)

### Связи с другими модулями:
- **Пациенты**: patient_id в ledger → начисление бонусов рефералу
- **Услуги**: service_id в ledger → получение цены
- **Кассы**: source в ledger → обновление cashboxes.balance
- **Записи**: appointment_id → автоматическое создание ledger при записи

### База данных:
- **ledger** - основная таблица операций
  - Поля: ts, kind, source, amount, service_id, patient_id, cashier_id, split_payments
- **cashboxes** - балансы касс (alpha, sber, cash)
  - Поля: _id, name, balance, updated_at

### Роуты:
- GET /finance - список операций
- GET /finance/add - форма добавления
- POST /finance/add - сохранение операции
- GET /finance/report/cashbox - отчёт по кассам
- GET /finance/export/csv - экспорт в CSV

---

## ПАЦИЕНТЫ (Patients)

### Файлы:
- **main.py** (функции: patient_card_page, patients_list, add_patient)
- **templates/** (patient_card.html, patients.html, add_patient.html, patient_questionnaire.html)

### Связи:
- **Финансы**: patient_id в ledger → история платежей
- **Бонусы**: bonus_balance, referred_by_patient_id → реферальная система
- **Записи**: patient_id в appointments → история визитов
- **Услуги**: через appointments → список оказанных услуг

### База данных:
- **patients** - основная таблица
  - Поля: full_name, phone, email, card_no, bonus_balance, referred_by_patient_id, medical_questionnaire
- **bonus_history** - история бонусных операций
  - Поля: patient_id, operation, amount, ts

### Роуты:
- GET /patients - список пациентов
- GET /patients/<id> - карточка пациента (функция: patient_card_page, строка 552)
- POST /add_patient - создание пациента
- GET/POST /patients/<id>/questionnaire - медицинская анкета (функция: patient_questionnaire, строка 3863)
  - GET: отображение формы
  - POST: сохранение в medical_questionnaire (включая other_notes)

---

## ВРАЧИ (Doctors)

### Файлы:
- **main.py** (функции: doctors, add_doctor, doctor_card)
- **templates/** (doctors.html, doctor_card.html)

### Связи:
- **Записи**: doctor_id в appointments → расписание врача
- **Кабинеты**: через appointments → занятость кабинетов
- **Финансы**: через appointments → доходы по врачам

### База данных:
- **doctors** - основная таблица
  - Поля: full_name, specialization, is_active

### Роуты:
- GET /doctors - список врачей
- GET /doctor_card/<id> - карточка врача
- POST /add_doctor - создание врача

---

## УСЛУГИ (Services)

### Файлы:
- **main.py** (функции: services_list, add_service)
- **templates/** (services.html)

### Связи:
- **Финансы**: service_id в ledger → расчёт цены
- **Записи**: service_id в appointments → длительность и стоимость

### База данных:
- **services** - основная таблица
  - Поля: name, price, duration_min, is_active

### Роуты:
- GET /services - список услуг
- POST /add_service - создание услуги
- GET /api/services/<id> - получение услуги

---

## КАБИНЕТЫ (Rooms)

### Файлы:
- **main.py** (функции: rooms_list, add_room)
- **templates/** (rooms.html)

### Связи:
- **Записи**: room_id в appointments → занятость кабинета
- **Врачи**: через appointments → какой врач в каком кабинете

### База данных:
- **rooms** - основная таблица
  - Поля: name, is_active

### Роуты:
- GET /rooms - список кабинетов
- POST /add_room - создание кабинета
- GET /api/rooms/status_now - текущий статус кабинетов

---

## ЗАПИСИ (Appointments)

### Файлы:
- **main.py** (функции: add_event, calendar_view)
- **routes_schedule.py** - дополнительный модуль расписания
- **templates/** (calendar.html, add_event_modal.html)

### Связи:
- **ВСЕ МОДУЛИ** - центральная точка связи
- **Финансы**: создание ledger при записи
- **Пациенты**: patient_id → история визитов
- **Врачи**: doctor_id → расписание
- **Услуги**: service_id → цена и длительность
- **Кабинеты**: room_id → занятость

### База данных:
- **appointments** - основная таблица
  - Поля: start, end, patient_id, doctor_id, service_id, room_id, status

### Роуты:
- GET /calendar - календарь записей
- POST /add_event - создание записи
- POST /api/appointments/<id>/update - изменение записи

---

## БОНУСЫ (Bonus System)

### Файлы:
- **routes_bonus.py** - API управления бонусами
- **routes_finance.py** - автоначисление при оплате
- **templates/patient_card.html** - отображение в карточке

### Связи:
- **Пациенты**: bonus_balance, referred_by_patient_id
- **Финансы**: автоматическое начисление 10% при оплате

### База данных:
- **bonus_history** - история операций
  - Поля: patient_id, operation, amount, related_ledger_id, ts

### Роуты:
- POST /api/patients/<id>/bonus/add - начисление
- POST /api/patients/<id>/bonus/withdraw - списание
- GET /api/patients/<id>/bonus/history - история

---

## АУДИТ (Audit System)

### Файлы:
- **main.py** (функции: write_log, write_audit_log, audit_logs)
- **templates/** (audit_logs.html)

### Связи:
- **ВСЕ МОДУЛИ** - логирование всех действий

### База данных:
- **logs** - журнал действий
- **audit_logs** - детальный аудит
  - Поля: action, user, details, ts

### Роуты:
- GET /audit - просмотр логов
- GET /logs - журнал действий
- GET /logs/export - экспорт логов

---

## ДИАГРАММА ОСНОВНЫХ СВЯЗЕЙ

APPOINTMENTS (центр системы)
                        |
    +-------------------+-------------------+
    |                   |                   |
PATIENTS            DOCTORS            SERVICES
    |                   |                   |
    |                   |                   |
    +----------+--------+--------+----------+
               |                 |
            FINANCE          ROOMS
               |
    +----------+----------+
    |          |          |
LEDGER    CASHBOXES    BONUS


### Ключевые связи (стрелки данных):

### Ключевые связи:
1. **appointments → ledger** (автоматически при создании записи)
2. **ledger → cashboxes** (обновление балансов)
3. **ledger → bonus_history** (начисление рефералу)
4. **patients.referred_by_patient_id → patients._id** (реферальная цепочка)


**Appointments → всё остальное:**
- `appointments.patient_id → patients._id`
- `appointments.doctor_id → doctors._id`
- `appointments.service_id → services._id`
- `appointments.room_id → rooms._id`
- `appointments._id → ledger.appointment_id` (автосоздание)

**Finance (ledger) связи:**
- `ledger.service_id → services._id` (цена)
- `ledger.patient_id → patients._id` (история платежей)
- `ledger.source → cashboxes._id` (обновление баланса)
- `ledger._id → bonus_history.related_ledger_id` (начисление рефералу)

**Bonus система:**
- `patients.referred_by_patient_id → patients._id` (цепочка рефералов)
- `bonus_history.patient_id → patients._id` (история бонусов)

**Потоки данных при создании записи:**
1. POST /add_event → создаётся appointments
2. Автоматически создаётся ledger (если есть service_id)
3. Обновляется cashboxes.balance (по source)
4. Проверяется referred_by_patient_id → начисление бонусов рефералу
5. Запись в bonus_history





