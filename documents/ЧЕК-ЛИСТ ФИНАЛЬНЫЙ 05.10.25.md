ФИНАЛЬНЫЙ ЧЕК-ЛИСТ РАЗРАБОТКИ МЕДПЛАТФОРМЫ
*Дата: 05.10.2025*
*Согласовано с заказчиком*

---

## ТЕРМИНОЛОГИЯ (обновлено)

**Было → Стало:**
- Администратор → **Владелец** (Наконечная, Наконечный, Гогуева)
- Карточка пациента → **Карта пациента**
- Бонусы → **Баллы партнерской программы**
- Кассир → **Объединён с Администратором**
- Менеджер рассылок → **Куратор**

**Удалить:**
- Миргатия О.С. (в декрете)

---

## БЛОК 1: РОЛИ И ДОСТУПЫ (2-3 дня)

### 1.1 Обновить роли в БД
- [ ] Создать роль "owner" для троих (Наконечная, Наконечный, Гогуева)
- [ ] owner = все права (супер-администратор)
- [ ] Сохранить роль "admin" для будущих администраторов клиники
- [ ] Удалить Миргатия О.С. из db.users
- [ ] Обновить права: врачи видят цены

### 1.2 Обновить терминологию в коде
**Файлы:** main.py, все templates/
- [ ] "карточка пациента" → "карта пациента" (везде)
- [ ] "бонусы" → "баллы партнерской программы"
- [ ] Объединить функционал кассира с администратором
- [ ] Переименовать роль "менеджер рассылок" → "куратор"

### 1.3 UI обновления
- [ ] В меню: "Карта пациента" вместо "Карточка"
- [ ] Блок баллов: "Баллы партнерской программы"
- [ ] Роль в интерфейсе: показывать "Владелец" для троих

---

## БЛОК 2: СИСТЕМА СТАТУСОВ И ДОЛГОВ (3-4 часа) 🔴

### 2.1 Убрать автосоздание долга при записи
**Файл:** main.py, строка 1841
- [ ] Закомментировать блок создания ledger в add_event()
- [ ] Долг создается ТОЛЬКО при завершении приема

### 2.2 Статусы записей в БД
```javascript
appointments: {
  status: "scheduled" | "arrived" | "completed" | "cancelled" | "no_show" | "rescheduled",

  // Для комментариев к визитам
  visit_comment: String,          // Что сделано на визите
  visit_number: Number,            // 1, 2, 3...
  total_visits: Number,            // Из скольки (указывает врач)

  // Для связанных визитов
  related_appointment_id: ObjectId,

  // Для завершения
  completed_at: DateTime,
  completed_by: ObjectId,

  // Для отмены
  cancellation_reason: String,
  cancelled_by: ObjectId,
  cancelled_at: DateTime,

  // Для переноса
  original_appointment_id: ObjectId,
  rescheduled_to: ObjectId
}

 Миграция: обновить существующие записи (status: "scheduled")
 Добавить no_show_count в patients

2.3 Кнопки в календаре
Файл: templates/calendar.html
При клике на запись - показать модальное окно с кнопками:
Если status = "scheduled":

 "Пациент пришёл" → status = "arrived"
 "Перенести" → форма выбора даты
 "Не явился" → status = "no_show"

Если status = "arrived":

 "Завершить приём" → форма завершения:

 Комментарий к визиту (обязательное поле, textarea)
 Всего визитов: [ ] из [ ] (опционально)
 ☐ Требуется повторный визит
 Кнопка "Завершить"


 "Отменить" → форма причины

Если status = "completed":

 "Подробнее" (показать детали)
 "Записать повторно" (копировать на новую дату)

Цветовая индикация в календаре:

 scheduled → синий
 arrived → зелёный
 completed → серый
 cancelled → красный
 no_show → оранжевый

2.4 API роуты

 POST /appointments/<id>/arrive
 POST /appointments/<id>/complete (с автодолгом)
 POST /appointments/<id>/cancel
 POST /appointments/<id>/reschedule
 POST /appointments/<id>/no-show

2.5 Логика завершения приёма
Файл: main.py, новая функция appointment_complete()
pythondef appointment_complete(id):
    # 1. Получить запись, пациента, услугу
    # 2. Определить цену (льготная или обычная)
    # 3. Проверить депозит
    # 4. Рассчитать долг:
    #    if deposit >= price:
    #        deposit_used = price
    #        debt_created = 0
    #    else:
    #        deposit_used = deposit
    #        debt_created = price - deposit
    # 5. Обновить пациента (deposit_balance, debt_balance)
    # 6. Создать ledger: kind="service_completed"
    # 7. Обновить appointments: status, completed_at, visit_comment
    # 8. Если из плана → обновить план
    # 9. Логирование

 Реализовать функцию
 Протестировать с депозитом
 Протестировать без депозита (создание долга)

2.6 Повторные записи
Модальное окно при завершении (если отмечен чекбокс):
┌─────────────────────────────────┐
│ Повторная запись                │
├─────────────────────────────────┤
│ Пациент: [автозаполнено]        │
│ Врач: [текущий врач]            │
│                                 │
│ Услуга:                         │
│ ◉ Та же услуга                  │
│ ○ Выбрать другую [▼]            │
│                                 │
│ Номер визита: [2] из [3]        │
│                                 │
│ [Открыть расписание]            │
└─────────────────────────────────┘
Встроенный календарь расписания:
┌────────────────────────────────┐
│ Октябрь 2025                   │
│ Пн Вт Ср Чт Пт Сб Вс          │
│     1  2  3  4  5  6          │
│  7  8  9 10 11 12 13          │
│ 14 15 16 17 18 19 20          │
├────────────────────────────────┤
│ 15 октября (среда)             │
│ 🟢 09:00-10:00 Каб. №3        │
│ 🟢 10:00-11:00 Каб. №3 ← выбор│
│ 🔴 11:00-12:00 Занято         │
│ 🟢 14:00-15:00 Первый свободный│
└────────────────────────────────┘

 Форма повторной записи
 Встроенный календарь расписания врача
 Подсветка свободных слотов
 Выбор кабинета или "Первый свободный"
 Сохранение связи: related_appointment_id
 Нумерация: visit_number++

2.7 Кнопка "Записать повторно"
Для завершенных записей в календаре:

 Кнопка "Записать повторно"
 Копирование данных (пациент, врач, услуга)
 Открытие расписания
 Создание новой записи

2.8 Комментарии к визитам

 Поле visit_comment обязательное при завершении
 Видят все (владельцы, врачи, администраторы)
 Отображение в истории

2.9 История лечения в карте пациента
Новый блок: "Цепочка визитов"
┌─────────────────────────────────────────┐
│ 🦷 Лечение канала 2.6                   │
├─────────────────────────────────────────┤
│ 📅 01.10.2025 - Визит 1 из 3            │
│ 👨‍⚕️ Айвазян А.Г.                         │
│ 💬 Первичная обработка канала           │
│ ✅ Завершён                              │
├─────────────────────────────────────────┤
│ 📅 08.10.2025 - Визит 2 из 3            │
│ 💬 [No-Show] Не явился                  │
├─────────────────────────────────────────┤
│ 📅 15.10.2025 - Визит 2 из 3 (повтор)   │
│ 💬 Промежуточная обработка              │
│ ✅ Завершён                              │
├─────────────────────────────────────────┤
│ 📅 22.10.2025 - Визит 3 из 3            │
│ 🕐 Запланировано                         │
└─────────────────────────────────────────┘

 Группировка по related_appointment_id
 Показ всей цепочки визитов
 Статусы: завершён, запланирован, не явился
 Если No-Show → можно записать повторно (не прерывает цепочку)

2.10 Логика No-Show

 Если пациент не явился на визит 2 из 3:

Цепочка НЕ прерывается
Можно записать на визит 2 заново
Сохраняется история (показывать No-Show в цепочке)


 Счетчик no_show_count у пациента


БЛОК 3: ПАРТНЕРСКАЯ ПРОГРАММА - БАЛЛЫ (4-5 часов) 🟡
3.1 База данных
Переименовать:

 bonus_balance → points_balance в patients
 bonus_history → points_history

Структура points_history:
javascript{
  patient_id: ObjectId,
  operation: "referral_level1" | "referral_level2" | "withdrawal" | "manual_add",
  amount: Number,
  related_patient_id: ObjectId,  // Кто был приведён
  related_payment_id: ObjectId,  // Какая оплата
  ts: DateTime,
  description: String
}
Добавить в patients:
javascript{
  referred_by_patient_id: ObjectId,     // Уровень 1
  referred_by_level2_patient_id: ObjectId  // Уровень 2 (кто привёл того кто привёл)
}
3.2 Логика начисления
При ОПЛАТЕ реферала:
python# Пример: Сидоров оплатил 100,000₽
# Петров привёл Сидорова → Петров получает 10,000 баллов (10%)
# Иванов привёл Петрова → Иванов получает 3,000 баллов (3%)

def accrue_referral_points(payment):
    patient = db.patients.find_one(payment.patient_id)
    amount = payment.amount

    # Уровень 1: кто привёл (10%)
    if patient.referred_by_patient_id:
        level1_points = int(amount * 0.10)
        db.patients.update_one(
            {"_id": patient.referred_by_patient_id},
            {"$inc": {"points_balance": level1_points}}
        )
        # Запись в историю

    # Уровень 2: кто привёл того кто привёл (3%)
    if patient.referred_by_level2_patient_id:
        level2_points = int(amount * 0.03)
        db.patients.update_one(
            {"_id": patient.referred_by_level2_patient_id},
            {"$inc": {"points_balance": level2_points}}
        )
        # Запись в историю

 Реализовать функцию начисления
 Вызов при создании оплаты (ledger kind="income")
 НЕ начислять при оплате баллами
 Логирование в points_history

3.3 Использование баллов при оплате
В форме оплаты /finance/add:
Сумма к оплате: 50,000 ₽

Баллы партнерской программы:
Доступно: 12,000 баллов

Списать баллов: [____] (макс. 12,000)
                        [Списать все]

Итого к оплате: 50,000 - [____] = [____] ₽
Правила:

 1 балл = 1 рубль
 Можно списать не больше чем есть
 Баллы вечные (не сгорают)
 При списании: points_balance -= amount
 Добавить поле в форму оплаты
 Вычитать баллы из суммы
 Создать запись в points_history (withdrawal)
 Обновить patients.points_balance

3.4 UI в карте пациента
Новый блок: "Баллы партнерской программы"
┌─────────────────────────────────┐
│ 💎 Баллы партнерской программы  │
├─────────────────────────────────┤
│ Доступно: 12,000 баллов         │
│ (= 12,000 ₽)                    │
├─────────────────────────────────┤
│ История:                        │
│ 📅 01.10 +10,000 (Петров оплатил)│
│ 📅 15.10 +3,000 (Сидоров оплатил)│
│ 📅 20.10 -1,000 (Списано на оплату)│
└─────────────────────────────────┘

 Отображение баланса баллов
 История начисления/списания
 Кнопка "Использовать баллы" → переход к оплате

3.5 При создании пациента
Добавить поле:
Кто привёл пациента? [Поиск пациента ▼]
                     [или оставить пустым]
Логика:

 Если выбран реферал → сохранить referred_by_patient_id
 Автоматически найти уровень 2:

python  if referred_by:
      referrer = db.patients.find_one(referred_by)
      if referrer.referred_by_patient_id:
          # Это уровень 2
          new_patient.referred_by_level2_patient_id = referrer.referred_by_patient_id

БЛОК 4: РАСПИСАНИЕ ВРАЧЕЙ (6-8 часов) 🟡
4.1 База данных
javascriptdoctor_schedules: {
  doctor_id: ObjectId,
  date: Date,  // Конкретная дата или null (если шаблон)

  // Для шаблонов
  is_template: Boolean,
  template_day: "monday" | "tuesday" | ... | "sunday",

  // Слоты
  time_slots: [
    {
      start: "09:00",
      end: "10:00",
      room_id: ObjectId,  // или null (Первый свободный)
      status: "free" | "booked",
      appointment_id: ObjectId  // Если забронирован
    }
  ],

  created_by: ObjectId,
  updated_at: DateTime
}
4.2 Страница расписания
Новая страница: /schedule
Интерфейс:
┌─────────────────────────────────────────┐
│ Расписание врачей                       │
├─────────────────────────────────────────┤
│ Врач: [Айвазян ▼]  Период: [3 месяца ▼]│
├─────────────────────────────────────────┤
│   Октябрь 2025                          │
│ Пн  Вт  Ср  Чт  Пт  Сб  Вс             │
│  1   2   3   4   5   6   7             │
│  8   9  10  11  12  13  14  ← клик     │
├─────────────────────────────────────────┤
│ Понедельник, 14 октября                 │
│ 09:00-10:00  Каб. №3  [Свободно]       │
│ 10:00-11:00  Каб. №3  [Занято: Иванов] │
│ 11:00-12:00  Каб. №2  [Свободно]       │
│ ... обед ...                            │
│ 14:00-15:00  Первый свободный [Свободно]│
└─────────────────────────────────────────┘

[Создать шаблон недели]
[Скопировать месяц]
[Редактировать день]

 Календарь на 3+ месяца
 Выбор врача
 Показ слотов выбранного дня
 Кнопки управления

4.3 Недельные шаблоны
Функция: "Создать шаблон недели"
┌─────────────────────────────────┐
│ Шаблон рабочей недели           │
├─────────────────────────────────┤
│ Понедельник:                    │
│ Начало: [09:00]  Конец: [18:00] │
│ Обед: [13:00] - [14:00]         │
│ Кабинет: [№3 ▼]                 │
│                                 │
│ Вторник: [аналогично]           │
│ ...                             │
│ Суббота: ☐ Рабочий день         │
│ Воскресенье: ☐ Рабочий день     │
├─────────────────────────────────┤
│ Применить к периоду:            │
│ С [01.11.2025] По [30.11.2025]  │
│                                 │
│ [Отмена] [Создать расписание]   │
└─────────────────────────────────┘
Логика:

 Создать шаблон для каждого дня недели
 Применить к диапазону дат
 Генерация слотов по 30/60 минут (настройка врача)
 Учёт обеденного времени

4.4 Редактирование конкретного дня
Можно:

 Изменить время работы
 Добавить/удалить слоты
 Сменить кабинет
 Отметить как выходной

4.5 Копирование расписания
Функция: "Скопировать месяц"
Скопировать расписание:
Из: [Октябрь 2025 ▼]
В:  [Ноябрь 2025 ▼]

☐ Заменить существующее
☑ Только свободные дни

[Копировать]

 Копирование всех слотов врача
 Опция замены или добавления

4.6 Интеграция с записями
При создании записи:

 Показывать только свободные слоты
 Если слот занят → серый, нельзя выбрать
 После записи → помечать слот (status: "booked", appointment_id)

При отмене/переносе:

 Освобождать слот (status: "free", appointment_id: null)

4.7 Привязка к кабинетам
Опции:

 Конкретный кабинет (№1, №2, №3...)
 "Первый свободный" (система выберет при записи)

Логика "Первый свободный":

При записи проверить какие кабинеты свободны в это время
Выбрать первый из списка
Сохранить в appointments.room_id

4.8 Редактирование прошлых дат

 Можно редактировать (для исправлений)
 Предупреждение: "Это прошедшая дата"
 Логирование изменений


БЛОК 5: ПЛАНЫ ЛЕЧЕНИЯ - ДОРАБОТКА (2-3 часа) 🟢
5.1 Простой план без одобрения
Критерии автоутверждения:

Услуг ≤ 2
Сумма ≤ 30,000₽

Логика:
pythonif len(services) <= 2 and total_amount <= 30000:
    status = "approved"
    approved_by = doctor_id
    approved_at = now()
else:
    status = "pending_approval"

 Проверка при создании плана
 Автоутверждение простых планов
 Сложные → на согласование главврача

5.2 Запись из плана лечения
При создании записи - добавить:
☐ Услуга из плана лечения

[Если отмечено:]
План: [Выбрать план ▼]
Услуга: [Выбрать из плана ▼]
Сохранить в appointments:

 treatment_plan_id
 service_from_plan: true

5.3 Обновление плана при завершении
При завершении услуги из плана:
pythonif appointment.treatment_plan_id:
    plan = db.treatment_plans.find_one(appointment.treatment_plan_id)

    # Найти услугу в плане
    for i, service in enumerate(plan.services):
        if service.service_id == appointment.service_id and service.status == "planned":
            db.treatment_plans.update_one(
                {"_id": plan._id},
                {"$set": {
                    f"services.{i}.status": "completed",
                    f"services.{i}.completed_at": now(),
                    f"services.{i}.completed_by_doctor_id": doctor_id
                }}
            )
            break

 Автообновление статуса услуги в плане
 Отметка "Выполнено"
 Кто выполнил, когда

5.4 Автопредложение следующей услуги
При завершении услуги из плана:
Если есть следующая услуга (status="planned"):

 Автоматически предложить: "Записать на следующую услугу плана?"
 Подставить следующую услугу в форму повторной записи
 Связать записи через plan_id

5.5 Комплексный план (на будущее)
Отложить реализацию, но продумать:

Главврач создаёт "финальный план"
Может консолидировать планы от разных врачей
Кнопка "Утвердить финальный план"


БЛОК 6: ВНУТРЕННЯЯ РАССРОЧКА (5-6 часов) 🟢
6.1 База данных
javascriptinstallment_plans: {
  patient_id: ObjectId,
  total_amount: Number,
  paid_amount: Number,

  schedule: [
    {
      date: Date,
      amount: Number,
      status: "pending" | "paid",
      paid_at: DateTime,
      payment_id: ObjectId  // Ссылка на ledger
    }
  ],

  created_by: ObjectId,  // Владелец
  created_at: DateTime,
  notes: String,
  is_active: Boolean
}
6.2 Создание рассрочки
Страница: /patients/<id>/installment/new (только владельцы)
┌─────────────────────────────────┐
│ Создание рассрочки              │
├─────────────────────────────────┤
│ Пациент: Иванов Иван Иванович   │
│                                 │
│ Общая сумма: [300,000] ₽        │
│                                 │
│ График платежей:                │
│ [Добавить платеж]               │
│                                 │
│ 1. 15.11.2025 - 100,000 ₽       │
│ 2. 15.05.2026 - 100,000 ₽       │
│ 3. 15.11.2026 - 100,000 ₽       │
│                                 │
│ Итого: 300,000 ₽ ✓              │
│                                 │
│ Примечания:                     │
│ [_________________________]     │
│                                 │
│ [Отмена] [Создать рассрочку]    │
└─────────────────────────────────┘

 Форма создания
 Добавление платежей (дата + сумма)
 Проверка: сумма платежей = общая сумма
 Сохранение в БД

6.3 Отображение в карте пациента
Блок: "Рассрочка"
┌─────────────────────────────────────────┐
│ 💳 Рассрочка: 300,000 ₽                 │
├─────────────────────────────────────────┤
│ Оплачено: 100,000 ₽                     │
│ Осталось: 200,000 ₽                     │
├─────────────────────────────────────────┤
│ График платежей:                        │
│ ✅ 15.11.2025 - 100,000 ₽ (Оплачено)   │
│ ⏰ 15.05.2026 - 100,000 ₽ (Через 7 мес.)│
│ ⏰ 15.11.2026 - 100,000 ₽ (Через 13 мес.)│
└─────────────────────────────────────────┘

[Отметить платеж] [Редактировать график]

 Показ графика
 Прогресс-бар оплаты
 Ближайший платеж выделен

6.4 Оплата очередного платежа
При оплате:

 В /finance/add добавить опцию "Платеж по рассрочке"
 Выбор какой платеж закрывается
 Обновление: status="paid", paid_at, payment_id
 Обновление paid_amount

6.5 Напоминания (вручную куратор)
Страница для куратора: /installments/upcoming
Ближайшие платежи (30 дней):

📅 15.11.2025 - Иванов И.И. - 100,000 ₽
   [Отправить SMS] [Позвонить]

📅 20.11.2025 - Петров П.П. - 50,000 ₽
   [Отправить SMS] [Позвонить]

 Список платежей на ближайшие 30 дней
 Кнопки для напоминания (пока вручную)
 В будущем: автоматические SMS (опционально)


БЛОК 7: СТРАНИЦА ДОЛЖНИКОВ (30 мин) 🟡
Страница: /finance/debts
Функционал:

 Список пациентов с debt_balance > 0
 Сортировка по сумме (убыв/возр)
 Фильтр по сумме (от/до)
 Дата последнего завершённого приёма
 Кнопка "Погасить долг" → /finance/add

Роут:
python@app.route("/finance/debts")
@login_required
@role_required(["owner", "admin"])
def finance_debts():
    debtors = list(db.patients.find(
        {"debt_balance": {"$gt": 0}},
        {"full_name": 1, "phone": 1, "debt_balance": 1}
    ).sort("debt_balance", -1))

    for debtor in debtors:
        last_appt = db.appointments.find_one(
            {"patient_id": debtor["_id"], "status": "completed"},
            sort=[("completed_at", -1)]
        )
        debtor["last_visit"] = last_appt.get("completed_at") if last_appt else None

    return render_template("finance/debts.html", debtors=debtors)

БЛОК 8: ДОПОЛНИТЕЛЬНЫЕ УЛУЧШЕНИЯ (опционально)
8.1 Уведомления о записи

 SMS пациенту после записи
 Напоминание за день до приема
 Email с подтверждением

8.2 Аналитика

 Отчёт по врачам (выручка, количество приёмов)
 Отчёт по услугам (популярность)
 График No-Show по пациентам

8.3 Мобильная версия

 Адаптивная вёрстка
 Упрощённый интерфейс для врачей


⏱️ ИТОГОВАЯ ОЦЕНКА
БлокВремяПриоритет1. Роли и терминология2-3 дня🔴 Критично2. Статусы и долги8-10 часов🔴 Критично3. Партнерская программа4-5 часов🟡 Важно4. Расписание врачей6-8 часов🟡 Важно5. Планы лечения2-3 часа🟢 Можно отложить6. Рассрочка5-6 часов🟢 Можно отложить7. Страница должников30 мин🟡 Важно
Критично (старт): 10-13 часов
Важно (неделя 2): 11-14 часов
Опционально (неделя 3+): 7-9 часов
ИТОГО: 28-36 часов работы

🚀 ПЛАН РЕАЛИЗАЦИИ
НЕДЕЛЯ 1 (Критично)
День 1:

Обновить роли в БД
Удалить Миргатию
Обновить терминологию в коде

День 2-3:

Система статусов записей
Убрать автосоздание долга
Кнопки в календаре

День 4:

Функция завершения приёма с автодолгом
Повторные записи (основной функционал)

День 5:

История лечения (цепочка визитов)
Комментарии к визитам
Тестирование

НЕДЕЛЯ 2 (Важно)
День 1-2:

Партнерская программа (баллы)
Начисление и списание

День 3-5:

Расписание врачей
Шаблоны и редактирование
Страница должников

НЕДЕЛЯ 3-4 (Опционально)

Комплексные планы лечения
Внутренняя рассрочка
Дополнительные улучшения


✅ КРИТЕРИИ ГОТОВНОСТИ
Система готова к запуску когда:

 Блок 1 выполнен (роли)
 Блок 2 выполнен (статусы и долги)
 Блок 3 выполнен (баллы)
 Блок 4 выполнен (расписание)
 Блок 7 выполнен (должники)
 Протестировано на реальных данных
 Обучены сотрудники

Можно запускать без:

Комплексных планов (добавить позже)
Рассрочки (добавить при необходимости)


ЧЕК-ЛИСТ УТВЕРЖДЕН И ГОТОВ К РАБОТЕ ✅
'@ | Out-File -FilePath "documents\ЧЕК-ЛИСТ ФИНАЛЬНЫЙ.md" -Encoding utf8
Write-Host "n✅ ФИНАЛЬНЫЙ ЧЕК-ЛИСТ СОЗДАН!" -ForegroundColor Green Write-Host "Файл: documents\ЧЕК-ЛИСТ ФИНАЛЬНЫЙ.md" -ForegroundColor Cyan Write-Host "n📊 Итоговая оценка: 28-36 часов работы" -ForegroundColor Yellow
Write-Host "n🎯 ПЛАН:" -ForegroundColor Cyan Write-Host "  Неделя 1: Роли + Статусы/долги (критично)" -ForegroundColor White Write-Host "  Неделя 2: Баллы + Расписание (важно)" -ForegroundColor White   Write-Host "  Неделя 3-4: Планы + Рассрочка (опционально)" -ForegroundColor White Write-Host "n⚠️ ЧАТ ОЧЕНЬ ДЛИННЫЙ - рекомендую создать новый" -ForegroundColor Yellow
Write-Host "`nДля продолжения:" -ForegroundColor Cyan
Write-Host "1. Кнопка 'New Chat' (в том же проекте!)" -ForegroundColor White
Write-Host "2. Напишите: 'Начинаем по чек-листу'" -ForegroundColor White
Write-Host "3. Я загружу весь контекст автоматически" -ForegroundColor White
