# АРХИТЕКТУРА СВЯЗЕЙ МЕДПЛАТФОРМЫ

## ФИНАНСЫ (Finance)

**Файлы:** routes_finance.py, templates/finance/

**Связи:**
- Пациенты: patient_id → история платежей
- Услуги: service_id → получение цены (обычной или льготной)
- Кассы: source → обновление балансов
- Записи: appointment_id → автосоздание ledger

**База данных:**
- ledger: ts, kind, source, amount, service_id, patient_id, cashier_id, split_payments
- cashboxes: _id, name, balance, updated_at

**Роуты:**
- GET /finance - список операций
- POST /finance/add - создание операции (проверяет use_preferential_pricing)
- GET /finance/report/cashbox - отчёт по кассам

---

## ПАЦИЕНТЫ (Patients)

**Файлы:** main.py (patient_card, patients_list), templates/patient_card.html

**Связи:**
- Финансы: patient_id в ledger
- Бонусы: bonus_balance, referred_by_patient_id
- Записи: patient_id в appointments
- Льготный прайс: use_preferential_pricing → routes_finance

**База данных:**
- patients: full_name, phone, email, card_no, medical_questionnaire, use_preferential_pricing
- bonus_history: patient_id, operation, amount, ts

**Роуты:**
- GET /patients - список
- GET /patients/<id> - карточка (отображает медицинские заметки)
- GET/POST /patients/<id>/questionnaire - анкета
- POST /api/patients/<id>/update_info - обновление (включая use_preferential_pricing)

---

## УСЛУГИ (Services)

**Файлы:** main.py (services_list, add_service, edit_service), templates/add_service.html, templates/edit_service.html

**Связи:**
- Финансы: service_id → price или preferential_price
- Записи: service_id → длительность и стоимость

**База данных:**
- services: name, price, preferential_price, duration_min, is_active

**Роуты:**
- GET /services - список
- GET/POST /add_service - создание (с полем preferential_price)
- GET/POST /edit_service/<id> - редактирование

---

## ОБНОВЛЕНИЕ 27.09.2025: ЛЬГОТНЫЙ ПРАЙС

**Новые поля:**
- services.preferential_price (Number | null) - льготная цена
- patients.use_preferential_pricing (Boolean) - галочка в карточке

**Логика (routes_finance.py, строки 33-48):**
1. Получить patient_id из формы
2. Загрузить пациента из БД
3. Проверить use_preferential_pricing
4. Если true И есть preferential_price у услуги → применить льготную цену
5. Иначе → применить обычную цену

**Поток данных:**
Форма /finance/add (patient_id + service_id)
↓
routes_finance.add_post()
↓
Проверка patients.use_preferential_pricing
↓
Выбор services.preferential_price ИЛИ services.price
↓
Сохранение в ledger.amount
**Связи:**
- patients.use_preferential_pricing → routes_finance.add_post() → services.preferential_price → ledger.amount
