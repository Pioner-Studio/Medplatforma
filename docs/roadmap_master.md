# Medplatforma — roadmap_master.md (Стратегия 3–12 месяцев)
_Последнее обновление: 2025-10-07 08:26_

> **Назначение:** стратегический план развития. Этот файл **не переписывается** при операционных задачах — только дополняется и уточняется. Операционка — в `docs_bundle.md`.

---

## A) ВИЗИЯ И ЦЕЛИ
- Единая стоматологическая платформа: календарь, карта пациента, планы лечения, финансы, отчёты, коммуникации
- Прозрачность процессов для владельцев (дашборды), эффективность для врачей, удобство для пациентов

---

## B) МЕГА‑ЭПИКИ (DOMAINS)

### B1. Карта пациента 2.0
**Deliverables:**
- Расширенные вкладки: визиты, документы/файлы, снимки, финансы, планы лечения, история оплат, долги
- История лечения (цепочка визитов) и таймлайн вмешательств
**Техзадачи:**
- Хранилище файлов (GridFS/S3), превью изображений
- Индексы по `patient_id`, оптимизация выборок
**Критерии:**
- Отображение за <200 мс для пациента с 1000 записями
- Загрузка/скачивание файлов без ошибок
**Зависимости:** авторизация, аудит

### B2. План лечения 3‑года + мультиврач
**Deliverables:**
- Планы от терапевта/хирурга/ортодонта; страница согласования главврача
- Финальный годовой план (консолидация по статусам и стоимости)
**DB / API:**
- `treatment_plans` (сервис, цена, комментарий, статус, отметки завершения)
- `/chief/pending-plans`, `/plans/<id>/approve|reject|update`
**Критерии:**
- При завершении услуги из плана создаётся долг; статус услуги = `completed`

### B3. Коммуникации и ЛК пациента
**Deliverables:**
- Личный кабинет пациента (веб)
- Вход по телефону (OTP/SMS)
- Чат с пациентом (внутри ЛК), уведомления: SMS/WhatsApp/Email
**Интеграции:**
- SMS/WhatsApp провайдер; почтовый SMTP
**Критерии:**
- Двухфакторная проверка телефона; SLA доставки уведомлений ≥ 98%

### B4. Интеллектуальные функции (AI)
**Deliverables:**
- Голосовой ассистент для записи: «Запиши Петрова к Иванову на завтра 17:00»
- Анализ рентген‑снимков на кариес: подсветка подозрительных зон, отчёт врачу
**Техзадачи:**
- ASR (распознавание речи), NLU для извлечения {"пациент","врач","дата/время","услуга"}
- ML‑пайплайн: загрузка изображения → предобработка → инференс → heatmap → отчёт
**Критерии:**
- Точность NER ≥ 95% на тестовом наборе
- Для рентгенов — ROC‑AUC ≥ 0.90 на валид. выборке
**Юр./мед. замечания:**
- ИИ — как помощник, финальное решение за врачом; логировать предупреждения

### B5. Склад и инвентаризация
**Deliverables:**
- Учёт материалов по складам/кабинетам, списания на услуги, ревизии
**DB / API:**
- `inventory`, `stock_moves`; интеграция с `services`
**Критерии:**
- Отчёт по остаткам/списаниям; алерты по минимальным остаткам

### B6. Расписания и доступность
**Deliverables:**
- Шаблоны расписаний врачей; быстрые правки; первый свободный слот
**Критерии:**
- Создание/перенос/отмена корректно освобождают слоты; конфликтов нет

### B7. Отчёты и аналитика
**Deliverables:**
- Дашборд владельца/главврача
- Отчёт по врачам, по услугам, No‑Show, долги/авансы
**Техзадачи:**
- Агрегации MongoDB, кэширование, графики
**Критерии:**
- Время генерации отчёта < 2 с при 100k документах

### B8. Платежи и рассрочка
**Deliverables:**
- Комбинированные платежи, авансы (внесение/списание), внутренняя рассрочка
**Критерии:**
- Платёж виден в истории; корректные сальдо по пациенту

---

## C) ДОЛГОСРОЧНЫЙ СПИСОК (backlog 6–12 мес, без потерь)
- Полноценные **карты пациента** (файлы/документы/вкладки)
- **Чат** с пациентом в ЛК
- **План лечения на 3 года**
- **Зубная формула** (интерактивная)
- **Склад и инвентаризация**
- **SMS/WhatsApp уведомления**
- **ЛК пациента (вход по телефону)**
- **Ортодонтическая карта 043‑1/у**
- **ИИ‑внедрения**: голосовые команды записи; анализ рентгенов на кариес
- **Мобильная версия** (адаптив, упрощённый UI врача)
- **Дашборды и аналитика**
- **Домен/SSL/сервер и деплой** (VPS, nginx, Let’s Encrypt)

---

## D) ПОРЯДОК ВНЕДРЕНИЯ (release train)
1. Workflow (статусы, планы лечения, долги, оплаты) — 2 спринта
2. Расписания/шаблоны и страница должников — 1 спринт
3. Баллы/реферальная программа — 1 спринт
4. ЛК пациента (вход по телефону) + уведомления — 2 спринта
5. Склад/инвентаризация — 1–2 спринта
6. AI: голосовой ассистент — 1 спринт (MVP)
7. AI: рентген‑анализ — 2–3 спринта (PoC → MVP)

---

## E) ЗАВИСИМОСТИ И РИСКИ
- PII/мед.данные → безопасность, разграничение прав, журналы доступа
- AI‑модули → юридические дисклеймеры, контроль качества врачом
- Интеграции SMS/WhatsApp → надёжность поставщика, стоимость

---

## F) КРИТЕРИИ УСПЕХА (вехи)
- Через 10 дней: планы лечения создаются и согласуются; долги по завершённым услугам; оплаты принимаются
- Через 22 дня: комбинированные платежи, отчёты, авто‑backup
- Через 3 месяца: ЛК пациента, уведомления, расписания и должники
- Через 6 месяцев: склад, дашборды; AI‑голос (MVP)
- Через 12 месяцев: AI‑рентген (MVP), зубная формула, ортодонт.карта

---

## G) ИНФРА / ДЕПЛОЙ
- Домен: `clubstom-clinic.ru`, VPS (Timeweb), SSL: Let’s Encrypt, авто‑обновление
- Перенос на сервер: nginx, gunicorn/uwsgi, hardening


---

## B9. Интерактивная зубная формула (Dental Chart 1.0)
**Цель:** клиническая визуализация зубов пациента с пометками по поверхностям, связью со снимками и планом лечения.

**Модель данных (MongoDB):**
- Коллекция: `dental_charts`
```json
{
  "_id": "<ObjectId>",
  "patient_id": "<ObjectId>",
  "schema": "FDI",  // 11–48 (взрослая), опционально 51–85 (молочные)
  "teeth": {
    "11": {
      "status": "present|missing|implant|crown|bridge_abutment",
      "surfaces": {
        "M": "healthy|caries|filling|defect|fracture",
        "D": "healthy|caries|filling|defect|fracture",
        "O": "healthy|caries|filling|inlay|onlay",
        "B": "healthy|caries|filling|defect",
        "L": "healthy|caries|filling|defect",
        "I": "healthy|wear|crack"
      },
      "notes": "свободный текст",
      "last_updated": "2025-10-07T12:00:00Z"
    },
    "...": { }
  },
  "images": [{ "image_id": "<ObjectId>", "type": "rx_bitewing|rx_periapical|photo", "annot_mask_id": "<ObjectId>" }],
  "created_at": "2025-10-07T12:00:00Z",
  "updated_at": "2025-10-07T12:00:00Z"
}
```

**Интеракции (UI):**
- Клик по зубу/поверхности → контекстное меню: _пометить статус_ / _создать задачу плана лечения_ / _открыть снимок_.
- Цвета поверхностей по статусу (legend): healthy, caries, filling, implant, crown и т.д.
- Фильтры: “Проблемы”, “Пломбы”, “Импланты”, “Планируемые вмешательства”.

**API:**
```
GET /api/patients/<id>/dental-chart
PATCH /api/patients/<id>/dental-chart       // патчи по surfaces и статусам
POST /api/patients/<id>/dental-chart/image  // привязка снимка/маски
```
**Критерии приёмки:**
- Обновление статуса поверхности сохраняется <200 мс.
- Создание услуги плана из выделенных поверхностей заполняет `tooth`/`surfaces` в черновике.

---

## B2+. План лечения — подробная спецификация (Treatment Plans 1.0)
**Цель:** стандартизировать создание/согласование/выполнение планов, учёт стоимости и долгов, мультиврачи, финальный план главврача.

### Сущности
- Коллекция: `treatment_plans`
```json
{
  "_id": "<ObjectId>",
  "patient_id": "<ObjectId>",
  "created_by": "<doctor_id>",
  "scope": "discipline|multi",
  "status": "draft|pending_review|approved|rejected|in_progress|closed|archived",
  "title": "План от терапевта на 6 месяцев",
  "comment": "кариес 1.6, 2.6; реставрации",
  "services": [{ 
      "service_id": "<ObjectId>",
      "label": "Терапия кариеса 1.6",
      "tooth": 16,
      "surfaces": ["M","O"],
      "planned_date": "2025-10-15",
      "duration_min": 40,
      "price": 6500,
      "currency": "RUB",
      "discount": 0,
      "status": "planned|in_progress|completed|cancelled",
      "created_by": "<doctor_id>",
      "performed_by": "<doctor_id>",
      "appointments": ["<appt_id>"],
      "completed_at": "2025-10-20T10:30:00Z",
      "billing": {
        "debt_id": "<ObjectId>",
        "invoice_id": "<ObjectId>",
        "payment_status": "unpaid|partial|paid"
      },
      "notes": "изолятор, цвет A2"
  }],
  "approvals": [{ "role": "chief_doctor", "user_id": "<id>", "decision": "approved|rejected", "comment": "", "ts": "..." }],
  "version": 3,
  "supersedes": "<plan_id>" ,
  "created_at": "2025-10-07T12:00:00Z",
  "updated_at": "2025-10-07T12:00:00Z"
}
```

### Статусы (state machine)
- План: `draft → pending_review → approved → in_progress → closed` (или `rejected|archived`).
- Услуга в плане: `planned → in_progress → completed` (или `cancelled`).

**Правила:**
- `approved` даёт право запись/выполнение; `in_progress` — когда первая услуга начата; `closed` — когда все услуги в состоянии `completed|cancelled`.
- У завершённой услуги создаётся запись долга (`debts`), если оплата не проведена сразу.
- Простые планы (≤2 услуги и ≤30 000 ₽) — авто‑одобрение (auto‑approve).

### Потоки событий
- Из календаря врача → “Сформировать план из текущей записи” (preliminary).
- Из карты пациента → “Новый план” (ручной).
- Согласование главврачом: `/chief/pending-plans` (approve/reject; правка цены/назначения).
- Выполнение: при завершении услуги — фиксируем в `services[i]`, создаём/обновляем `debts` и историю оплат.
- Продолжение лечения сегодня: добавление услуги из плана в текущий приём (без переноса даты).

### API (минимум)
```
POST /api/patients/<id>/plans                  // создать draft
GET  /api/patients/<id>/plans?status=...       // список
GET  /api/plans/<plan_id>                      
PATCH/PUT /api/plans/<plan_id>                 // обновления полей/услуг
POST /api/plans/<plan_id>/submit               // → pending_review
POST /api/plans/<plan_id>/approve              // роль chief_doctor
POST /api/plans/<plan_id>/reject
POST /api/plans/<plan_id>/services             // add service
PATCH /api/plans/<plan_id>/services/<i>        // update service (статус/цена/...)
POST /api/plans/<plan_id>/services/<i>/complete  // завершить + биллинг
```
**Критерии приёмки:**
- Создание/согласование/редактирование плана → отражается в истории, аудите.
- Завершение услуги создаёт долг/или помечает оплату, меняет статус услуги на `completed`.

