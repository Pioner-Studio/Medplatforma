# DENTAL_CHART_SPEC.md — Интерактивная зубная формула (v1)
_Обновлено: 2025-10-07 08:41_

## 1. Цели и масштаб
- Визуально фиксировать клиническое состояние зубов и **поверхностей** (по FDI).
- Быстро создавать **пункты плана лечения** из выделенных поверхностей/зубов.
- Связывать зуб/поверхности со **снимками** (рентген/фото) и **масками** разметки.
- Поддерживать версионирование, аудит и высокую производительность.

---

## 2. Нумерация и поверхности (FDI)
- **FDI-взрослые:** 11–18, 21–28, 31–38, 41–48.  
- **FDI-молочные (опционально):** 51–55, 61–65, 71–75, 81–85.
- **Поверхности:** `M` (мезиальная), `D` (дистальная), `O` (окклюзионная, для премоляров/моляров), `B` (буккальная/внешняя), `L` (лингвальная/нёбная), `I` (инцизальная, для резцов/клыков).

> Примечание: в данных допускаем все коды, но в UI показываем **релевантные**: для моляров `O`, для фронтальных — `I`.

---

## 3. Состояния (enums) и цветовая легенда
### 3.1 Состояние **зуба**
- `present` (есть) — #E0E7FF  
- `missing` (удалён) — #CBD5E1  
- `impacted` (ретенция) — #F59E0B  
- `implant` (имплант) — #22C55E  
- `crown` (коронка) — #60A5FA  
- `bridge_abutment` (опора моста) — #38BDF8  
- `pontic` (промежуточная часть) — #67E8F9

### 3.2 Состояние **поверхности**
- `healthy` — #10B981  
- `caries` — #EF4444  
- `filling` — #3B82F6  
- `defect` (дефект/вторичный кариес) — #F97316  
- `fracture` — #FB7185  
- `sealant` — #93C5FD  
- `endo_needed` — #A78BFA  
- `endo_done` — #7C3AED

> Цвета не «жёсткие»: при необходимости подберём в стиле UI. Важно сохранить **контраст** и читабельность.

---

## 4. Модель данных (MongoDB)
Коллекция: **`dental_charts`**
```json
{
  "_id": "<ObjectId>",
  "patient_id": "<ObjectId>",
  "schema": "FDI",
  "teeth": {
    "11": {
      "tooth_status": "present|missing|implant|crown|bridge_abutment|pontic|impacted",
      "surfaces": {
        "M": "healthy|caries|filling|defect|fracture|sealant|endo_needed|endo_done",
        "D": "healthy|caries|filling|defect|fracture|sealant|endo_needed|endo_done",
        "O": "healthy|caries|filling|defect|fracture|sealant",
        "B": "healthy|caries|filling|defect|fracture|sealant",
        "L": "healthy|caries|filling|defect|fracture|sealant",
        "I": "healthy|wear|crack|filling|fracture"
      },
      "notes": "свободный текст",
      "last_updated": "2025-10-07T10:00:00Z",
      "updated_by": "<user_id>"
    }
  },
  "images": [{ 
    "file_id": "<ObjectId>", 
    "type": "rx_bitewing|rx_periapical|cbct|photo", 
    "tooth": 16,
    "surfaces": ["M","O"],
    "mask_file_id": "<ObjectId>", 
    "created_at": "2025-10-07T10:05:00Z"
  }],
  "version": 3,
  "created_at": "2025-10-01T09:00:00Z",
  "updated_at": "2025-10-07T10:30:00Z"
}
```

**Индексы:**
```javascript
db.dental_charts.createIndex({ patient_id: 1 });
db.dental_charts.createIndex({ "images.file_id": 1 });
```

---

## 5. API (v1)
```
GET    /api/patients/<id>/dental-chart            // получить
POST   /api/patients/<id>/dental-chart            // создать (если нет)
PATCH  /api/patients/<id>/dental-chart            // частичные изменения (surfaces, tooth_status, notes)
POST   /api/patients/<id>/dental-chart/image      // привязать снимок/маску
DELETE /api/patients/<id>/dental-chart/image/<fid>// отвязать снимок
GET    /api/dental-legend                         // получить легенду цветов/статусов
```

**PATCH — пример тела:**
```json
{
  "teeth": {
    "16": {
      "surfaces": { "M": "caries", "O": "filling" },
      "notes": "проверить контактный пункт"
    }
  }
}
```

---

## 6. UI/UX (компоненты)
- **Панель легенды** (цвета, чекбоксы-фильтры: проблемы/пломбы/импланты/планируемые).
- **Режим выделения**: клики по зубам/поверхностям добавляют/снимают отметки, Shift — мультивыбор.
- **Контекстное меню**: _Пометить_, _Создать пункт плана_, _Открыть снимок_, _Привязать снимок_.
- **Связь с планом лечения**: при выборе поверхностей → кнопка «Добавить в план» создаёт черновик `services[]` с `tooth`/`surfaces`.

**Клавиши:**
- `Z` — отмена последнего редактирования (локально),  
- `Ctrl+S` — сохранить,  
- `F` — фильтр по состояниям.

---

## 7. Версионирование и аудит
- Поля `version`, `updated_at`, `updated_by` в документе.
- Журнал `audit_logs` на PATCH/POST/DELETE (кто/что/когда/до/после).
- Возможность **снапшотов**: `dental_charts_history` (раз в день/по кнопке).

---

## 8. Права доступа
- `doctor`/`chief_doctor` — **просмотр и редактирование**.
- `registrar` — просмотр (без редактирования).
- `owner/admin` — полный доступ.
- Пациент — нет доступа (только через ЛК в виде read-only, позже).

---

## 9. Производительность
- Ленивые обновления: PATCH только изменённых поверхностей.
- Ограничение частоты: не чаще 5 PATCH/сек на пользователя.
- Кэш легенды (`/api/dental-legend`) на 1 день.

---

## 10. Тесты (критерии приёмки)
- Выделение 10 поверхностей подряд сохраняется без потерь.
- Привязанный снимок открывается и отображает маску поверх зубной формулы.
- Создание пункта плана из выделенных поверхностей заполняет `tooth`/`surfaces` корректно.
- Откат последнего изменения (локально) работает.

---

## 11. V2 (последующие фазы)
- Пародонтологическая запись (PPD, BOP, рецессии) — отдельные слои.
- Шаблоны состояния для первичного осмотра (быстрые проставления).
- Экспорт в PDF/изображение для врачебной комиссии.
