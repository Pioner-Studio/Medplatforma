    1: import importlib
    2: import importlib.metadata
    3: import os
    4: import pathlib
    5: import subprocess
    6: 
    7: import pytest
    8: 
    9: import numpy as np
   10: import numpy._core.include
   11: import numpy._core.lib.pkgconfig
   12: from numpy.testing import IS_EDITABLE, IS_INSTALLED, IS_WASM, NUMPY_ROOT
   13: 
   14: INCLUDE_DIR = NUMPY_ROOT / '_core' / 'include'
   15: PKG_CONFIG_DIR = NUMPY_ROOT / '_core' / 'lib' / 'pkgconfig'
   16: 
   17: 
   18: @pytest.mark.skipif(not IS_INSTALLED, reason="`numpy-config` not expected to be installed")
   19: @pytest.mark.skipif(IS_WASM, reason="wasm interpreter cannot start subprocess")
   20: class TestNumpyConfig:
   21:     def check_numpyconfig(self, arg):
   22:         p = subprocess.run(['numpy-config', arg], capture_output=True, text=True)
   23:         p.check_returncode()
   24:         return p.stdout.strip()
   25: 
   26:     def test_configtool_version(self):
   27:         stdout = self.check_numpyconfig('--version')
   28:         assert stdout == np.__version__
   29: 
   30:     def test_configtool_cflags(self):
   31:         stdout = self.check_numpyconfig('--cflags')
   32:         assert f'-I{os.fspath(INCLUDE_DIR)}' in stdout
   33: 
   34:     def test_configtool_pkgconfigdir(self):
   35:         stdout = self.check_numpyconfig('--pkgconfigdir')
   36:         assert pathlib.Path(stdout) == PKG_CONFIG_DIR
   37: 
   38: 
   39: @pytest.mark.skipif(not IS_INSTALLED, reason="numpy must be installed to check its entrypoints")
   40: def test_pkg_config_entrypoint():
   41:     (entrypoint,) = importlib.metadata.entry_points(group='pkg_config', name='numpy')
   42:     assert entrypoint.value == numpy._core.lib.pkgconfig.__name__
   43: 
   44: 
   45: @pytest.mark.skipif(not IS_INSTALLED, reason="numpy.pc is only available when numpy is installed")
   46: @pytest.mark.skipif(IS_EDITABLE, reason="editable installs don't have a numpy.pc")
   47: def test_pkg_config_config_exists():
   48:     assert PKG_CONFIG_DIR.joinpath('numpy.pc').is_file()
