    1: # Copyright 2024-present MongoDB, Inc.
    2: #
    3: # Licensed under the Apache License, Version 2.0 (the "License");
    4: # you may not use this file except in compliance with the License.
    5: # You may obtain a copy of the License at
    6: #
    7: # http://www.apache.org/licenses/LICENSE-2.0
    8: #
    9: # Unless required by applicable law or agreed to in writing, software
   10: # distributed under the License is distributed on an "AS IS" BASIS,
   11: # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   12: # See the License for the specific language governing permissions and
   13: # limitations under the License.
   14: 
   15: """GCP helpers."""
   16: from __future__ import annotations
   17: 
   18: from typing import Any
   19: 
   20: 
   21: def _get_gcp_response(resource: str, timeout: float = 5) -> dict[str, Any]:
   22:     from urllib.request import Request, urlopen
   23: 
   24:     url = "http://metadata/computeMetadata/v1/instance/service-accounts/default/identity"
   25:     url += f"?audience={resource}"
   26:     headers = {"Metadata-Flavor": "Google"}
   27:     request = Request(url, headers=headers)  # noqa: S310
   28:     try:
   29:         with urlopen(request, timeout=timeout) as response:  # noqa: S310
   30:             status = response.status
   31:             body = response.read().decode("utf8")
   32:     except Exception as e:
   33:         msg = "Failed to acquire IMDS access token: %s" % e
   34:         raise ValueError(msg) from None
   35: 
   36:     if status != 200:
   37:         msg = "Failed to acquire IMDS access token."
   38:         raise ValueError(msg)
   39: 
   40:     return dict(access_token=body)
