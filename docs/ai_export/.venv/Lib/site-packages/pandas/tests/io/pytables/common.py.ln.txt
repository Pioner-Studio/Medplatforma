    1: from collections.abc import Generator
    2: from contextlib import contextmanager
    3: import pathlib
    4: import tempfile
    5: 
    6: import pytest
    7: 
    8: from pandas.io.pytables import HDFStore
    9: 
   10: tables = pytest.importorskip("tables")
   11: # set these parameters so we don't have file sharing
   12: tables.parameters.MAX_NUMEXPR_THREADS = 1
   13: tables.parameters.MAX_BLOSC_THREADS = 1
   14: tables.parameters.MAX_THREADS = 1
   15: 
   16: 
   17: def safe_close(store):
   18:     try:
   19:         if store is not None:
   20:             store.close()
   21:     except OSError:
   22:         pass
   23: 
   24: 
   25: # contextmanager to ensure the file cleanup
   26: @contextmanager
   27: def ensure_clean_store(
   28:     path, mode="a", complevel=None, complib=None, fletcher32=False
   29: ) -> Generator[HDFStore, None, None]:
   30:     with tempfile.TemporaryDirectory() as tmpdirname:
   31:         tmp_path = pathlib.Path(tmpdirname, path)
   32:         with HDFStore(
   33:             tmp_path,
   34:             mode=mode,
   35:             complevel=complevel,
   36:             complib=complib,
   37:             fletcher32=fletcher32,
   38:         ) as store:
   39:             yield store
   40: 
   41: 
   42: def _maybe_remove(store, key):
   43:     """
   44:     For tests using tables, try removing the table to be sure there is
   45:     no content from previous tests using the same table name.
   46:     """
   47:     try:
   48:         store.remove(key)
   49:     except (ValueError, KeyError):
   50:         pass
