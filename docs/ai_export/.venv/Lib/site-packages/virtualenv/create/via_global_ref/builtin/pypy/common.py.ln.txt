    1: from __future__ import annotations
    2: 
    3: import abc
    4: from pathlib import Path
    5: 
    6: from virtualenv.create.via_global_ref.builtin.ref import PathRefToDest, RefMust, RefWhen
    7: from virtualenv.create.via_global_ref.builtin.via_global_self_do import ViaGlobalRefVirtualenvBuiltin
    8: 
    9: 
   10: class PyPy(ViaGlobalRefVirtualenvBuiltin, abc.ABC):
   11:     @classmethod
   12:     def can_describe(cls, interpreter):
   13:         return interpreter.implementation == "PyPy" and super().can_describe(interpreter)
   14: 
   15:     @classmethod
   16:     def _executables(cls, interpreter):
   17:         host = Path(interpreter.system_executable)
   18:         targets = sorted(f"{name}{PyPy.suffix}" for name in cls.exe_names(interpreter))
   19:         yield host, targets, RefMust.NA, RefWhen.ANY
   20: 
   21:     @classmethod
   22:     def executables(cls, interpreter):
   23:         yield from super().sources(interpreter)
   24: 
   25:     @classmethod
   26:     def exe_names(cls, interpreter):
   27:         return {
   28:             cls.exe_stem(),
   29:             "python",
   30:             f"python{interpreter.version_info.major}",
   31:             f"python{interpreter.version_info.major}.{interpreter.version_info.minor}",
   32:         }
   33: 
   34:     @classmethod
   35:     def sources(cls, interpreter):
   36:         yield from cls.executables(interpreter)
   37:         for host in cls._add_shared_libs(interpreter):
   38:             yield PathRefToDest(host, dest=lambda self, s: self.bin_dir / s.name)
   39: 
   40:     @classmethod
   41:     def _add_shared_libs(cls, interpreter):
   42:         # https://bitbucket.org/pypy/pypy/issue/1922/future-proofing-virtualenv
   43:         python_dir = Path(interpreter.system_executable).resolve().parent
   44:         yield from cls._shared_libs(python_dir)
   45: 
   46:     @classmethod
   47:     def _shared_libs(cls, python_dir):
   48:         raise NotImplementedError
   49: 
   50: 
   51: __all__ = [
   52:     "PyPy",
   53: ]
