{% extends "_layout.html" %}
{% block content %}

<h1 class="cs-h1">Финансы</h1>

<!-- Верхняя панель действий: скачать/импорт -->
<div class="cs-toolbar" style="margin:8px 0; display:flex; gap:12px; align-items:center;">
  <!-- Экспорт (учитываем текущие фильтры) -->
  <a class="cs-link" href="/finance/export/csv?type={{ f_type }}&source={{ f_source }}&category={{ f_category }}">Скачать CSV</a>
  <a class="cs-link" href="/finance/export/json?type={{ f_type }}&source={{ f_source }}&category={{ f_category }}">Скачать JSON</a>

  <!-- Импорт JSON -->
  <form method="post" action="/finance/import/json" enctype="multipart/form-data" style="display:flex; gap:6px;">
    <input type="file" name="file" accept="application/json" class="cs-input" required>
    <button class="cs-btn">Импорт JSON</button>
  </form>
</div>

<!-- МЕТРИКИ -->
<div class="cs-cards">
  <div class="cs-card"><div class="cs-metric-label">Доходы</div><div class="cs-metric-value">{{ income|default(0) }} ₽</div></div>
  <div class="cs-card"><div class="cs-metric-label">Расходы</div><div class="cs-metric-value">{{ expense|default(0) }} ₽</div></div>

  <div class="cs-card">
    <div class="cs-metric-label">Поступления по источникам</div>
    <ul class="cs-ul">
      <li><span class="cs-pill">alpha</span> {{ by_source.alpha|default(0) }} ₽</li>
      <li><span class="cs-pill">sber</span>  {{ by_source.sber|default(0)  }} ₽</li>
      <li><span class="cs-pill">cash</span>  {{ by_source.cash|default(0)  }} ₽</li>
    </ul>
  </div>
</div>

<!-- === ФИЛЬТРЫ (ОТДЕЛЬНАЯ ФОРМА!) === -->
<form method="get" action="/finance" class="cs-toolbar">
  <!-- Тип -->
  <select name="type" class="cs-input" title="Тип">
    <option value="">Все типы</option>
    <option value="income"   {{ 'selected' if f_type=='income'   else '' }}>Доход</option>
    <option value="expense"  {{ 'selected' if f_type=='expense'  else '' }}>Расход</option>
    <option value="deposit"  {{ 'selected' if f_type=='deposit'  else '' }}>Депозит</option>
    <option value="salary"   {{ 'selected' if f_type=='salary'   else '' }}>ЗП</option>
    <option value="purchase" {{ 'selected' if f_type=='purchase' else '' }}>Закупка</option>
  </select>

  <!-- Категория расхода -->
  <select name="category" class="cs-input" title="Категория">
    <option value="">Любая категория</option>
    <option value="purchase"  {{ 'selected' if f_category=='purchase'  else '' }}>Закупка</option>
    <option value="rent"      {{ 'selected' if f_category=='rent'      else '' }}>Аренда</option>
    <option value="marketing" {{ 'selected' if f_category=='marketing' else '' }}>Маркетинг</option>
    <option value="dividends" {{ 'selected' if f_category=='dividends' else '' }}>Дивиденды</option>
  </select>

  <!-- Источник -->
  <select name="source" class="cs-input" title="Источник">
    <option value="">Любой источник</option>
    <option value="alpha" {{ 'selected' if f_source=='alpha' else '' }}>Альфа</option>
    <option value="sber"  {{ 'selected' if f_source=='sber'  else '' }}>Сбер</option>
    <option value="cash"  {{ 'selected' if f_source=='cash'  else '' }}>Нал</option>
  </select>

  <button type="submit" class="cs-btn">Фильтр</button>

  <span style="margin-left:8px">Быстрые операции:</span>
  <a class="cs-link" href="/finance/add?type=expense&category=rent">Аренда</a>
  <a class="cs-link" href="/finance/add?type=expense&category=marketing">Маркетинг</a>
  <a class="cs-link" href="/finance/add?type=expense&category=dividends">Дивиденды</a>
  <a class="cs-link" href="/finance/add?type=purchase">Касса</a>
</form>

<!-- ТАБЛИЦА -->
<div class="cs-table-wrap">
  <table class="cs-table">
    <thead>
      <tr>
        <th>Время</th><th>Тип</th><th>Источник</th><th>Сумма</th><th>Услуга</th><th>Категория</th><th>Комментарий</th>
      </tr>
    </thead>
    <tbody>
      {% set CAT_RU = {"purchase":"Закупка","marketing":"Маркетинг","dividends":"Дивиденды","rent":"Аренда"} %}
      {% for it in (items or []) %}
      <tr>
        <td>{{ it.ts }}</td>
        <td>{{ it.type }}</td>
        <td>{{ it.source }}</td>
        <td>{{ it.amount }} ₽</td>
        <td>{{ it.service_name }}</td>
        <td>{{ CAT_RU.get(it.category, '—') }}</td>
        <td>{{ it.note }}</td>
      </tr>
      {% else %}
      <tr><td colspan="7" class="cs-empty">Записей нет</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}
