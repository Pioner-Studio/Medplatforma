{% extends "base.html" %}
{% block content %}

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
  <h1 class="cs-h1" style="margin: 0;">–§–∏–Ω–∞–Ω—Å—ã</h1>
  <div style="display: flex; gap: 12px;">
    <a href="/finance/add" class="cs-btn" style="background: #2e6cff; color: #fff; padding: 12px 24px; border-radius: 10px; text-decoration: none; font-weight: 600;">
      + –î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é
    </a>
    <a href="/finance/report/cashbox" class="btn btn-info ms-2">
      <i class="fa fa-chart-bar"></i> –û—Ç—á—ë—Ç –ø–æ –∫–∞—Å—Å–∞–º
    </a>
    <a href="/finance/transfer" class="cs-btn" style="background: #28a745; color: #fff; padding: 12px 24px; border-radius: 10px; text-decoration: none; font-weight: 600;">
      ‚ÜîÔ∏è –ü–µ—Ä–µ–≤–æ–¥—ã
    </a>
  </div>
</div>

<!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π: —Å–∫–∞—á–∞—Ç—å/–∏–º–ø–æ—Ä—Ç -->
<div class="cs-toolbar" style="margin:8px 0; display:flex; gap:12px; align-items:center;">
  <!-- –≠–∫—Å–ø–æ—Ä—Ç (—É—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã) -->
  <a class="cs-link" href="/finance/export/csv?type={{ f_type }}&source={{ f_source }}&category={{ f_category }}">–°–∫–∞—á–∞—Ç—å CSV</a>
  <a class="cs-link" href="/finance/export/json?type={{ f_type }}&source={{ f_source }}&category={{ f_category }}">–°–∫–∞—á–∞—Ç—å JSON</a>

  <!-- –ò–º–ø–æ—Ä—Ç JSON -->
  <form method="post" action="/finance/import/json" enctype="multipart/form-data" style="display:flex; gap:6px;">
    <input type="file" name="file" accept="application/json" class="cs-input" required>
    <button class="cs-btn">–ò–º–ø–æ—Ä—Ç JSON</button>
  </form>
</div>

<!-- –ú–ï–¢–†–ò–ö–ò -->
<div class="cs-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 20px 0;">
  <div class="cs-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px;">
    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">–î–æ—Ö–æ–¥—ã</div>
    <div style="font-size: 28px; font-weight: 700;">{{ income|default(0) }} ‚ÇΩ</div>
  </div>

  <div class="cs-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 12px;">
    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">–†–∞—Å—Ö–æ–¥—ã</div>
    <div style="font-size: 28px; font-weight: 700;">{{ expense|default(0) }} ‚ÇΩ</div>
  </div>

<!-- –ö–∞—Ä—Ç–∞ –î–æ–ª–∂–Ω–∏–∫–∏ -->
  <div class="cs-card" style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; padding: 20px; border-radius: 12px;">
    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">–î–æ–ª–∂–Ω–∏–∫–∏</div>
    <div style="font-size: 28px; font-weight: 700;">{{ debtors_count|default(0) }}</div>
    <div style="font-size: 14px; opacity: 0.85; margin-top: 4px;">
      –°—É–º–º–∞: {{ debtors_sum|default(0) }} ‚ÇΩ
    </div>
    <a href="/patients/debtors" style="
      display: inline-block;
      margin-top: 12px;
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 6px 14px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      transition: background 0.2s;
    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
      –°–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ ‚Üí
    </a>
  </div>

  <div class="cs-card" style="background: #fff; border: 2px solid #e9ecef; padding: 20px; border-radius: 12px;">
    <div style="font-size: 14px; color: #6c757d; margin-bottom: 12px; font-weight: 600;">–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</div>
    <div style="display: flex; flex-direction: column; gap: 6px; font-size: 14px;">
      <div><span style="background: #e3f2fd; padding: 2px 8px; border-radius: 4px; margin-right: 8px;">ALPHA</span>{{ by_source.alpha|default(0) }} ‚ÇΩ</div>
      <div><span style="background: #e8f5e9; padding: 2px 8px; border-radius: 4px; margin-right: 8px;">SBER</span>{{ by_source.sber|default(0) }} ‚ÇΩ</div>
      <div><span style="background: #fff3e0; padding: 2px 8px; border-radius: 4px; margin-right: 8px;">CASH</span>{{ by_source.cash|default(0) }} ‚ÇΩ</div>
    </div>
  </div>
</div>

<!-- === –§–ò–õ–¨–¢–†–´ (–û–¢–î–ï–õ–¨–ù–ê–Ø –§–û–†–ú–ê!) === -->
<form method="get" action="/finance" class="cs-toolbar">
  <!-- –¢–∏–ø -->
  <select name="type" class="cs-input" title="–¢–∏–ø">
    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
    <option value="income"   {{ 'selected' if f_type=='income'   else '' }}>–î–æ—Ö–æ–¥</option>
    <option value="expense"  {{ 'selected' if f_type=='expense'  else '' }}>–†–∞—Å—Ö–æ–¥</option>
    <option value="deposit"  {{ 'selected' if f_type=='deposit'  else '' }}>–î–µ–ø–æ–∑–∏—Ç</option>
    <option value="salary"   {{ 'selected' if f_type=='salary'   else '' }}>–ó–ü</option>
    <option value="purchase" {{ 'selected' if f_type=='purchase' else '' }}>–ó–∞–∫—É–ø–∫–∞</option>
  </select>

  <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–∞ -->
  <select name="category" class="cs-input" title="–ö–∞—Ç–µ–≥–æ—Ä–∏—è">
    <option value="">–õ—é–±–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</option>
    <option value="purchase"  {{ 'selected' if f_category=='purchase'  else '' }}>–ó–∞–∫—É–ø–∫–∞</option>
    <option value="rent"      {{ 'selected' if f_category=='rent'      else '' }}>–ê—Ä–µ–Ω–¥–∞</option>
    <option value="marketing" {{ 'selected' if f_category=='marketing' else '' }}>–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</option>
    <option value="dividends" {{ 'selected' if f_category=='dividends' else '' }}>–î–∏–≤–∏–¥–µ–Ω–¥—ã</option>
    <option value="other"     {{ 'selected' if f_category=='other'     else '' }}>–î—Ä—É–≥–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</option>
  </select>

  <!-- –ò—Å—Ç–æ—á–Ω–∏–∫ -->
  <select name="source" class="cs-input" title="–ò—Å—Ç–æ—á–Ω–∏–∫">
    <option value="">–õ—é–±–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫</option>
    <option value="alpha" {{ 'selected' if f_source=='alpha' else '' }}>–ê–ª—å—Ñ–∞</option>
    <option value="sber"  {{ 'selected' if f_source=='sber'  else '' }}>–°–±–µ—Ä</option>
    <option value="cash"  {{ 'selected' if f_source=='cash'  else '' }}>–ù–∞–ª</option>
  </select>

  <button type="submit" class="cs-btn">–§–∏–ª—å—Ç—Ä</button>

  <div style="margin-left: auto; display: flex; gap: 8px;">
    <span style="color: #6c757d; font-size: 14px; margin-right: 8px;">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:</span>
    <a href="/finance/add?type=expense&category=rent" style="padding: 6px 12px; background: #f8f9fa; border-radius: 6px; text-decoration: none; color: #495057; font-size: 13px;">üí∏ –ê—Ä–µ–Ω–¥–∞</a>
    <a href="/finance/add?type=expense&category=marketing" style="padding: 6px 12px; background: #f8f9fa; border-radius: 6px; text-decoration: none; color: #495057; font-size: 13px;">üì¢ –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</a>
    <a href="/finance/add?type=salary" style="padding: 6px 12px; background: #f8f9fa; border-radius: 6px; text-decoration: none; color: #495057; font-size: 13px;">üí∞ –ó–ü</a>
  </div>
</form>

<!-- –¢–ê–ë–õ–ò–¶–ê -->
<div class="cs-table-wrap">
  <table class="cs-table">
    <thead>
      <tr>
        <th>–í—Ä–µ–º—è</th><th>–¢–∏–ø</th><th>–ò—Å—Ç–æ—á–Ω–∏–∫</th><th>–°—É–º–º–∞</th><th>–£—Å–ª—É–≥–∞</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–ö–∞—Å—Å–∏—Ä</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody>
      {% set CAT_RU = {"purchase":"–ó–∞–∫—É–ø–∫–∞","marketing":"–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥","dividends":"–î–∏–≤–∏–¥–µ–Ω–¥—ã","rent":"–ê—Ä–µ–Ω–¥–∞"} %}
      {% for it in (items or []) %}
      <tr data-type="{{ it.type }}">
        <td>{{ it.ts }}</td>
        <td>{{ it.type }}</td>
        <td>{{ it.source }}</td>
        <td>{{ it.amount }} ‚ÇΩ</td>
        <td>{{ it.service_name }}</td>
        <td>{{ CAT_RU.get(it.category, '‚Äî') }}</td>
        <td>{{ it.cashier }}</td>
        <td>{{ it.note }}</td>
        <td>
          {% if not it.appointment_id %}
          <a
            href="/finance/delete/{{ it.id }}"
            onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –Ω–∞ {{ it.amount }} ‚ÇΩ –∏–∑ {{ it.source }}? –ë–∞–ª–∞–Ω—Å –∫–∞—Å—Å—ã –±—É–¥–µ—Ç –æ—Ç–∫–∞—Ç–∞–Ω.')"
            class="btn btn-sm btn-danger"
            style="text-decoration: none; color: white;"
          >
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
          </a>
          {% else %}
          <span style="color: #999; font-size: 12px;">–ê–≤—Ç–æ</span>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="9" class="cs-empty">–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<style>
/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ —Ç–∞–±–ª–∏—Ü—ã */
.cs-table-wrap {
  background: #fff;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.cs-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
}

.cs-table thead th {
  background: #f8f9fa;
  padding: 12px;
  text-align: left;
  font-weight: 600;
  color: #495057;
  border-bottom: 2px solid #dee2e6;
  position: sticky;
  top: 0;
  z-index: 10;
}

.cs-table tbody tr {
  border-bottom: 1px solid #f1f3f5;
  transition: background 0.15s;
}

.cs-table tbody tr:hover {
  background: #f8f9fa;
}

.cs-table td {
  padding: 12px;
  vertical-align: middle;
}

/* –¶–≤–µ—Ç–∞ –¥–ª—è —Ç–∏–ø–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π */
.cs-table td:nth-child(2) {
  font-weight: 500;
}

.cs-table tbody tr[data-type="income"] td:nth-child(4) {
  color: #28a745;
  font-weight: 600;
}

.cs-table tbody tr[data-type="expense"] td:nth-child(4),
.cs-table tbody tr[data-type="purchase"] td:nth-child(4),
.cs-table tbody tr[data-type="salary"] td:nth-child(4) {
  color: #dc3545;
  font-weight: 600;
}

/* –ë–µ–π–¥–∂–∏ –¥–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ */
.cs-table td:nth-child(3) {
  text-transform: uppercase;
  font-size: 0.85em;
  font-weight: 600;
  color: #6c757d;
}
</style>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
  <div style="background: white; padding: 24px; border-radius: 12px; max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
    <h3 style="margin: 0 0 16px 0; color: #dc3545;">‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
    <p id="deleteMessage" style="margin: 0 0 20px 0; color: #495057;"></p>
    <div style="display: flex; gap: 12px; justify-content: flex-end;">
      <button onclick="closeDeleteModal()" class="cs-btn" style="background: #6c757d;">–û—Ç–º–µ–Ω–∞</button>
      <button onclick="executeDelete()" class="cs-btn" style="background: #dc3545; color: white;">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
let deleteOperationId = null;

function confirmDelete(id, amount, source) {
  deleteOperationId = id;
  const sourceNames = {
    'alpha': '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫',
    'sber': '–°–±–µ—Ä–±–∞–Ω–∫',
    'cash': '–ù–∞–ª–∏—á–Ω—ã–µ',
    'split': '–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞'
  };
  const sourceName = sourceNames[source] || source;

  document.getElementById('deleteMessage').textContent =
    `–£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –Ω–∞ —Å—É–º–º—É ${amount} ‚ÇΩ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ "${sourceName}"? –ë–∞–ª–∞–Ω—Å –∫–∞—Å—Å—ã –±—É–¥–µ—Ç –æ—Ç–∫–∞—Ç–∞–Ω.`;

  const modal = document.getElementById('deleteModal');
  modal.style.display = 'flex';
}

function closeDeleteModal() {
  document.getElementById('deleteModal').style.display = 'none';
  deleteOperationId = null;
}

function executeDelete() {
  if (!deleteOperationId) return;

  fetch(`/finance/delete/${deleteOperationId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      window.location.reload();
    } else {
      alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      closeDeleteModal();
    }
  })
  .catch(error => {
    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error);
    closeDeleteModal();
  });
}
</script>

{% endblock %}
