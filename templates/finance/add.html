{% extends "base.html" %} {% block content %}

<div style="max-width: 1200px; margin: 0 auto; padding: 20px">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
  <div
    style="
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    "
  >
    <h1 style="margin: 0; font-size: 28px; font-weight: 600; color: #1f2937">
      –í–Ω–µ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏—é
    </h1>
    <div style="display: flex; gap: 12px">
      <a
        href="/finance"
        style="
          background: #6b7280;
          color: white;
          padding: 10px 16px;
          border-radius: 8px;
          text-decoration: none;
          font-weight: 500;
        "
        >–ö —Ñ–∏–Ω–∞–Ω—Å–∞–º</a
      >
    </div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ -->
  <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 32px">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –§–æ—Ä–º–∞ -->
    <div
      style="
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 24px;
      "
    >
    <!-- –ë–ª–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–æ–∫ -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div style="margin-bottom: 20px">
  {% for category, message in messages %}
  <div style="
    background: #fee2e2;
    border: 1px solid #fecaca;
    color: #b91c1c;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    font-size: 14px;
  ">
    {{ message }}
  </div>
  {% endfor %}
</div>
{% endif %}
{% endwith %}

      <form method="post" action="/finance/add" id="financeAddForm">
        <!-- –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
        <div style="margin-bottom: 20px">
          <label
            style="
              display: block;
              margin-bottom: 6px;
              font-weight: 500;
              color: #374151;
            "
            >–¢–∏–ø</label
          >
          <select
            name="type"
            id="typeSel"
            required
            style="
              width: 100%;
              padding: 12px;
              border: 1px solid #d1d5db;
              border-radius: 8px;
              font-size: 14px;
              background: white;
            "
          >
            <option value="income" {% if not form_type or form_type == "income" %}selected{% endif %}>–î–æ—Ö–æ–¥ (–æ–ø–ª–∞—Ç–∞ —É—Å–ª—É–≥–∏)</option>
            <option value="expense" {% if form_type == "expense" %}selected{% endif %}>–†–∞—Å—Ö–æ–¥</option>
            <option value="deposit" {% if form_type == "deposit" %}selected{% endif %}>–î–µ–ø–æ–∑–∏—Ç</option>
            <option value="salary" {% if form_type == "salary" %}selected{% endif %}>–ó–ü</option>
            <option value="purchase" {% if form_type == "purchase" %}selected{% endif %}>–î–µ–Ω—å–≥–∏ –Ω–∞ –∑–∞–∫—É–ø–∫—É</option>
          </select>
        </div>

        <!-- –î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
        <div style="margin-bottom: 20px">
          <label
            style="
              display: block;
              margin-bottom: 6px;
              font-weight: 500;
              color: #374151;
            "
            >–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏</label
          >
          <input
            type="date"
            name="operation_date"
            value="{{ form_operation_date or today }}"
            max="{{ today }}"
            required
            style="
              width: 100%;
              padding: 12px;
              border: 1px solid #d1d5db;
              border-radius: 8px;
              font-size: 14px;
            "
          />
          <div style="margin-top: 4px; font-size: 12px; color: #6b7280">
            –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - —Å–µ–≥–æ–¥–Ω—è. –ú–æ–∂–Ω–æ –≤–Ω–µ—Å—Ç–∏ –∑–∞–¥–Ω–∏–º —á–∏—Å–ª–æ–º.
          </div>
        </div>

        <!-- –°—É–º–º–∞ -->
        <div id="amountRow" style="margin-bottom: 20px">
          <label
            style="
              display: block;
              margin-bottom: 6px;
              font-weight: 500;
              color: #374151;
            "
            >–°—É–º–º–∞</label
          >
          <input
            type="number"
            min="0"
            step="1"
            name="amount"
            id="amountInput"
            value="{{ form_amount or '' }}"
            placeholder="0"
            style="
              width: 100%;
              padding: 12px;
              border: 1px solid #d1d5db;
              border-radius: 8px;
              font-size: 14px;
            "
          />
        </div>

        <!-- –ò—Å—Ç–æ—á–Ω–∏–∫ -->
        <div style="margin-bottom: 20px">
          <label
            style="
              display: block;
              margin-bottom: 6px;
              font-weight: 500;
              color: #374151;
            "
            >–ò—Å—Ç–æ—á–Ω–∏–∫</label
          >
          <select
            name="source"
            id="sourceSelect"
            style="
              width: 100%;
              padding: 12px;
              border: 1px solid #d1d5db;
              border-radius: 8px;
              font-size: 14px;
              background: white;
            "
          >
            <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ ‚Äî</option>
            <option value="alpha" {% if selected_source == "alpha" %}selected{% endif %}>–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫</option>
            <option value="sber" {% if selected_source == "sber" %}selected{% endif %}>–°–±–µ—Ä–±–∞–Ω–∫</option>
            <option value="cash" {% if selected_source == "cash" %}selected{% endif %}>–ù–∞–ª–∏—á–Ω—ã–µ</option>
          </select>
        </div>

        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è (–¥–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤) -->
        <div id="categoryBlock" style="display: none; margin-bottom: 20px">
          <label
            style="
              display: block;
              margin-bottom: 6px;
              font-weight: 500;
              color: #374151;
            "
            >–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label
          >
          <select
            name="category"
            id="categorySelect"
            style="
              width: 100%;
              padding: 12px;
              border: 1px solid #d1d5db;
              border-radius: 8px;
              font-size: 14px;
              background: white;
            "
          >
            <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ‚Äî</option>
            <option value="rent" {% if form_category == "rent" %}selected{% endif %}>–ê—Ä–µ–Ω–¥–∞</option>
            <option value="purchase" {% if form_category == "purchase" %}selected{% endif %}>–ó–∞–∫—É–ø–∫–∞</option>
            <option value="marketing" {% if form_category == "marketing" %}selected{% endif %}>–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</option>
            <option value="dividends" {% if form_category == "dividends" %}selected{% endif %}>–î–∏–≤–∏–¥–µ–Ω–¥—ã</option>
          </select>
        </div>

        <!-- –ö–∞—Å—Å–∏—Ä -->
        <div style="margin-bottom: 20px">
          <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">
            –ö–∞—Å—Å–∏—Ä (–∫—Ç–æ –≤–Ω–æ—Å–∏—Ç)
          </label>
          <div style="position: relative;">
            <input
            type="text"
            class="form-control"
            value="{{ session.get('user', {}).get('full_name', '') }}"
            readonly
            style="background-color: #f3f4f6; padding-right: 35px;"
            >
            <i class="fa fa-lock" style="position: absolute; right: 12px; top: 12px; color: #9ca3af;"></i>
          </div>
          <input type="hidden" name="cashier_id" value="{{ current_cashier_id }}">
        </div>

        <!-- –£—Å–ª—É–≥–∞ -->
        <div id="serviceBlock" style="margin-bottom: 20px">
          <label
            style="
              display: block;
              margin-bottom: 6px;
              font-weight: 500;
              color: #374151;
            "
            >–£—Å–ª—É–≥–∞ (—Ü–µ–Ω–∞ —Å—Ç—Ä–æ–≥–æ –∏–∑ –ø—Ä–∞–π—Å–∞)</label
          >
          <select
            name="service_id"
            id="serviceSelect"
            style="
              width: 100%;
              padding: 12px;
              border: 1px solid #d1d5db;
              border-radius: 8px;
              font-size: 14px;
              background: white;
            "
          >
            <option value="">‚Äî</option>
            {% for service in services %}
            <option value="{{ service._id }}"
                    data-price="{{ service.price }}"
                    {% if selected_service_id and selected_service_id == service._id|string %}selected{% endif %}>
              {{ service.name }}
            </option>
            {% endfor %}
          </select>
        </div>

        <!-- –ü–∞—Ü–∏–µ–Ω—Ç -->
        <div style="margin-bottom: 20px">
          <label
            style="
              display: block;
              margin-bottom: 6px;
              font-weight: 500;
              color: #374151;
            "
            >–ü–∞—Ü–∏–µ–Ω—Ç</label
          >
          <select
            name="patient_id"
            id="patientSelect"
            style="
              width: 100%;
              padding: 12px;
              border: 1px solid #d1d5db;
              border-radius: 8px;
              font-size: 14px;
              background: white;
            "
          >
            <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ‚Äî</option>
            {% for patient in patients %}
            <option value="{{ patient._id }}"
                    {% if selected_patient_id and selected_patient_id == patient._id|string %}selected{% endif %}>
              {{ patient.full_name }}
            </option>
            {% endfor %}
          </select>
        </div>

        <!-- –ë–ª–æ–∫ –±–∞–ª–ª–Ω–æ–π –æ–ø–ª–∞—Ç—ã -->
        <div
          id="bonusBlock"
          style="
            display: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 12px;
            "
          >
            <h4 style="margin: 0; color: white; font-size: 16px">
              üéÅ –ë–∞–ª–ª—ã –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞
            </h4>
            <span
              id="bonusBalance"
              style="color: white; font-weight: bold; font-size: 18px"
              >0 ‚ÇΩ</span
            >
          </div>

          <label
            style="
              display: flex;
              align-items: center;
              gap: 8px;
              color: white;
              margin-bottom: 12px;
            "
          >
            <input
              type="checkbox"
              name="use_bonus"
              id="useBonuses"
              style="width: 16px; height: 16px; accent-color: white"
            />
            –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∞–ª–ª—ã –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã
          </label>

          <div id="bonusPaymentControls" style="display: none">
            <div style="display: flex; gap: 8px; margin-bottom: 8px">
              <button
                type="button"
                id="useAllBonuses"
                style="
                  background: rgba(255, 255, 255, 0.2);
                  color: white;
                  border: 1px solid rgba(255, 255, 255, 0.3);
                  padding: 6px 12px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 12px;
                "
              >
                –í—Å–µ –±–∞–ª–ª—ã –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
              </button>
              <button
                type="button"
                id="useMaxBonuses"
                style="
                  background: rgba(255, 255, 255, 0.2);
                  color: white;
                  border: 1px solid rgba(255, 255, 255, 0.3);
                  padding: 6px 12px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 12px;
                "
              >
                –ú–∞–∫—Å–∏–º—É–º
              </button>
            </div>
            <input
              type="number"
              id="bonusAmount"
              name="bonus_amount"
              value="{{ form_bonus_amount or '' }}"
              placeholder="–°—É–º–º–∞ –±–∞–ª–ª–æ–≤"
              min="0"
              style="
                width: 100%;
                padding: 8px;
                border: none;
                border-radius: 6px;
                margin-bottom: 8px;
              "
            />
            <div
              id="bonusInfo"
              style="color: rgba(255, 255, 255, 0.9); font-size: 12px"
            ></div>
          </div>
        </div>

        <!-- –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞ -->
        <div style="margin-bottom: 20px">
          <label
            style="
              display: flex;
              align-items: center;
              gap: 8px;
              font-weight: 500;
              color: #374151;
            "
          >
            <input
              type="checkbox"
              name="split_payment"
              id="splitPayment"
              style="width: 16px; height: 16px; accent-color: #3b82f6"
            />
            –†–∞–∑–¥–µ–ª–∏—Ç—å –æ–ø–ª–∞—Ç—É (–Ω–µ—Å–∫–æ–ª—å–∫–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)
          </label>
        </div>

        <!-- –ë–ª–æ–∫ —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω–æ–π –æ–ø–ª–∞—Ç—ã -->
        <div
          id="splitPaymentBlock"
          style="
            display: none;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
          "
        >
          <h4 style="margin: 0 0 12px 0; color: #374151">–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã</h4>
          <div id="splitItems">
            <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
          </div>
          <button
            type="button"
            id="addSplitItem"
            style="
              background: #e5e7eb;
              color: #374151;
              border: none;
              padding: 8px 16px;
              border-radius: 6px;
              cursor: pointer;
              margin-top: 8px;
            "
          >
            + –î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫
          </button>
          <div
            id="splitTotal"
            style="margin-top: 12px; font-weight: 500; color: #374151"
          ></div>
        </div>

        <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
        <div style="margin-bottom: 24px">
          <label
            style="
              display: block;
              margin-bottom: 6px;
              font-weight: 500;
              color: #374151;
            "
            >–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label
          >
          <textarea
            name="comment"
            rows="3"
            placeholder="–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"
            style="
              width: 100%;
              padding: 12px;
              border: 1px solid #d1d5db;
              border-radius: 8px;
              font-size: 14px;
              resize: vertical;
            "
          >{{ form_note or '' }}</textarea>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div style="display: flex; gap: 12px">
          <button
            type="submit"
            style="
              background: #3b82f6;
              color: white;
              padding: 12px 24px;
              border: none;
              border-radius: 8px;
              font-weight: 500;
              cursor: pointer;
              flex: 1;
            "
          >
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
          <a
            href="/finance"
            style="
              background: #f3f4f6;
              color: #374151;
              padding: 12px 24px;
              border-radius: 8px;
              text-decoration: none;
              text-align: center;
              font-weight: 500;
              border: 1px solid #d1d5db;
            "
            >–û—Ç–º–µ–Ω–∞</a
          >
        </div>
      </form>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ -->
    <div>
      <!-- –ë–∞–ª–∞–Ω—Å –∫–∞—Å—Å -->
      <div
        style="
          background: white;
          border-radius: 12px;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
          padding: 20px;
          margin-bottom: 20px;
        "
      >
        <h3 style="margin: 0 0 16px 0; color: #374151; font-size: 16px">
          –¢–µ–∫—É—â–∏–µ –±–∞–ª–∞–Ω—Å—ã
        </h3>
        <div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
              border-bottom: 1px solid #f3f4f6;
            "
          >
            <span style="color: #6b7280">–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫</span>
            <span style="font-weight: 500" id="alphaBalance">‚Äî</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
              border-bottom: 1px solid #f3f4f6;
            "
          >
            <span style="color: #6b7280">–°–±–µ—Ä–±–∞–Ω–∫</span>
            <span style="font-weight: 500" id="sberBalance">‚Äî</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
            "
          >
            <span style="color: #6b7280">–ù–∞–ª–∏—á–Ω—ã–µ</span>
            <span style="font-weight: 500" id="cashBalance">‚Äî</span>
          </div>
        </div>
      </div>

      <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ -->
      <div
        style="
          background: #f0f9ff;
          border: 1px solid #0ea5e9;
          border-radius: 12px;
          padding: 20px;
        "
      >
        <h3 style="margin: 0 0 12px 0; color: #0c4a6e; font-size: 16px">
          –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
        </h3>
        <ul
          style="
            margin: 0;
            padding-left: 16px;
            color: #0c4a6e;
            font-size: 14px;
            line-height: 1.6;
          "
        >
          <li>–î–æ—Ö–æ–¥—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∏ –∑–∞–ø–∏—Å–∏</li>
          <li>–ú–æ–∂–Ω–æ –≤–Ω–æ—Å–∏—Ç—å –æ–ø–ª–∞—Ç—ã –∑–∞–¥–Ω–∏–º —á–∏—Å–ª–æ–º</li>
          <li>–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç—å —Å—É–º–º—É</li>
          <li>–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç –±–∞–ª–∞–Ω—Å—ã –∫–∞—Å—Å</li>
          <li>–ë–∞–ª–ª—ã –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–ø–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
  document.getElementById("typeSel").addEventListener("change", function () {
    const categoryBlock = document.getElementById("categoryBlock");
    if (this.value === "expense") {
      categoryBlock.style.display = "block";
    } else {
      categoryBlock.style.display = "none";
    }
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥–∏ - –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã
  document
    .getElementById("serviceSelect")
    .addEventListener("change", function () {
      const selectedOption = this.options[this.selectedIndex];
      const price = selectedOption.getAttribute("data-price");
      if (price) {
        document.getElementById("amountInput").value = price;
        calculateBonusPayment();
      }
    });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É–º–º—ã
  document.getElementById("amountInput").addEventListener("input", function () {
    calculateBonusPayment();
    updateSplitTotal();
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ–ø–ª–∞—Ç—ã
  document
    .getElementById("splitPayment")
    .addEventListener("change", function () {
      const splitBlock = document.getElementById("splitPaymentBlock");
      const sourceSelect = document.getElementById("sourceSelect");

      if (this.checked) {
        splitBlock.style.display = "block";
        sourceSelect.style.display = "none";
        addSplitItem();
      } else {
        splitBlock.style.display = "none";
        sourceSelect.style.display = "block";
        document.getElementById("splitItems").innerHTML = "";
      }
    });

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω–æ–π –æ–ø–ª–∞—Ç—ã
  let splitItemCount = 0;
  function addSplitItem() {
    splitItemCount++;
    const splitItems = document.getElementById("splitItems");
    const item = document.createElement("div");
    item.style.cssText =
      "display: flex; gap: 12px; margin-bottom: 12px; align-items: center;";
    item.innerHTML = `
    <select name="split_source_${splitItemCount}" style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
      <option value="">–ò—Å—Ç–æ—á–Ω–∏–∫</option>
      <option value="alpha">–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫</option>
      <option value="sber">–°–±–µ—Ä–±–∞–Ω–∫</option>
      <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
    </select>
    <input type="number" name="split_amount_${splitItemCount}" placeholder="–°—É–º–º–∞" min="0" style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" oninput="updateSplitTotal()">
    <button type="button" onclick="removeSplitItem(this)" style="background: #ef4444; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer;">√ó</button>
  `;
    splitItems.appendChild(item);
    updateSplitTotal();
  }

  function removeSplitItem(button) {
    button.parentElement.remove();
    updateSplitTotal();
  }

  function updateSplitTotal() {
    const amounts = document.querySelectorAll('input[name^="split_amount_"]');
    let total = 0;
    amounts.forEach((input) => {
      if (input.value) total += parseFloat(input.value);
    });

    const bonusAmount =
      parseFloat(document.getElementById("bonusAmount").value) || 0;
    const useBonuses = document.getElementById("useBonuses").checked;

    if (useBonuses && bonusAmount > 0) {
      total += bonusAmount;
    }

    const totalAmount =
      parseFloat(document.getElementById("amountInput").value) || 0;
    const remaining = totalAmount - total;

    let splitHtml = `–†–∞–∑–¥–µ–ª–µ–Ω–æ: ${total} ‚ÇΩ –∏–∑ ${totalAmount} ‚ÇΩ<br>`;

    if (useBonuses && bonusAmount > 0) {
      const otherSources = total - bonusAmount;
      splitHtml += `–ë–∞–ª–ª—ã –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã: ${bonusAmount} ‚ÇΩ, –¥—Ä—É–≥–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏: ${otherSources} ‚ÇΩ<br>`;
    }

    splitHtml += `–û—Å—Ç–∞—Ç–æ–∫: <span style="color: ${
      remaining === 0 ? "#22c55e" : "#ef4444"
    }">${remaining} ‚ÇΩ</span>`;

    document.getElementById("splitTotal").innerHTML = splitHtml;
  }

  document
    .getElementById("addSplitItem")
    .addEventListener("click", addSplitItem);

  // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–æ–≤ –∫–∞—Å—Å
  async function loadCashboxBalances() {
    try {
      document.getElementById("alphaBalance").textContent = "656,900 ‚ÇΩ";
      document.getElementById("sberBalance").textContent = "795,000 ‚ÇΩ";
      document.getElementById("cashBalance").textContent = "63,500 ‚ÇΩ";
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–æ–≤:", error);
    }
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener("DOMContentLoaded", function () {
    loadCashboxBalances();

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞ - –∑–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–ª–æ–≤
    document
      .getElementById("patientSelect")
      .addEventListener("change", loadPatientBonuses);

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞–ª–ª–Ω–æ–π –æ–ø–ª–∞—Ç—ã
    document
      .getElementById("useBonuses")
      .addEventListener("change", toggleBonusPayment);
    document
      .getElementById("bonusAmount")
      .addEventListener("input", calculateBonusPayment);
    document
      .getElementById("useAllBonuses")
      .addEventListener("click", useAllBonuses);
    document
      .getElementById("useMaxBonuses")
      .addEventListener("click", useMaxBonuses);
  });

  let currentPatientBonuses = 0;
  let currentTotalAmount = 0;

  // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–ª–æ–≤ –ø–∞—Ü–∏–µ–Ω—Ç–∞
  async function loadPatientBonuses() {
    const patientId = document.getElementById("patientSelect").value;
    const bonusBlock = document.getElementById("bonusBlock");

    if (!patientId) {
      bonusBlock.style.display = "none";
      currentPatientBonuses = 0;
      return;
    }

    try {
      const response = await fetch(`/api/patients/${patientId}/bonus`);
      const data = await response.json();

      if (data.success) {
        currentPatientBonuses = data.bonus_balance || 0;

        if (currentPatientBonuses > 0) {
          bonusBlock.style.display = "block";
          document.getElementById("bonusBalance").textContent =
            currentPatientBonuses + " ‚ÇΩ";
        } else {
          bonusBlock.style.display = "none";
        }
      }
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–ª–æ–≤:", error);
      bonusBlock.style.display = "none";
    }
  }

  function toggleBonusPayment() {
    const useBonuses = document.getElementById("useBonuses").checked;
    const controls = document.getElementById("bonusPaymentControls");

    if (useBonuses) {
      controls.style.display = "block";
      calculateBonusPayment();
    } else {
      controls.style.display = "none";
      document.getElementById("bonusAmount").value = "";
      calculateBonusPayment();
    }
  }

  function calculateBonusPayment() {
    const bonusAmount =
      parseFloat(document.getElementById("bonusAmount").value) || 0;
    const totalAmount =
      parseFloat(document.getElementById("amountInput").value) || 0;
    const bonusInfo = document.getElementById("bonusInfo");

    currentTotalAmount = totalAmount;

    if (bonusAmount > currentPatientBonuses) {
      bonusInfo.innerHTML = `‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ (–¥–æ—Å—Ç—É–ø–Ω–æ: ${currentPatientBonuses} ‚ÇΩ)`;
      bonusInfo.style.color = "#fecaca";
      return;
    }

    if (bonusAmount > totalAmount) {
      bonusInfo.innerHTML = `‚ùå –°—É–º–º–∞ –±–∞–ª–ª–æ–≤ –±–æ–ª—å—à–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —É—Å–ª—É–≥–∏`;
      bonusInfo.style.color = "#fecaca";
      return;
    }

    const remainder = totalAmount - bonusAmount;

    if (remainder === 0) {
      bonusInfo.innerHTML = `‚úÖ –ü–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –±–∞–ª–ª–∞–º–∏`;
      bonusInfo.style.color = "#bbf7d0";
    } else {
      bonusInfo.innerHTML = `üí∞ –ë–∞–ª–ª—ã –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã: ${bonusAmount} ‚ÇΩ, –¥–æ–ø–ª–∞—Ç–∞: ${remainder} ‚ÇΩ`;
      bonusInfo.style.color = "rgba(255,255,255,0.9)";
    }

    updateSplitTotal();
  }

  function useAllBonuses() {
    document.getElementById("bonusAmount").value = currentPatientBonuses;
    calculateBonusPayment();
  }

  function useMaxBonuses() {
    const totalAmount =
      parseFloat(document.getElementById("amountInput").value) || 0;
    const maxBonuses = Math.min(currentPatientBonuses, totalAmount);
    document.getElementById("bonusAmount").value = maxBonuses;
    calculateBonusPayment();
  }

// ========== –ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ò–ó –ó–ê–ü–ò–°–ò –ö–ê–õ–ï–ù–î–ê–†–Ø ==========
  {% if appointment_data %}
  document.addEventListener('DOMContentLoaded', function() {
    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞
    const patientSelect = document.getElementById('patientSelect');
    if (patientSelect && '{{ appointment_data.patient_id }}') {
      patientSelect.value = '{{ appointment_data.patient_id }}';
      loadPatientBonuses(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–ª—ã –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞
    }

    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —É—Å–ª—É–≥–∏
    const serviceSelect = document.getElementById('serviceSelect');
    if (serviceSelect && '{{ appointment_data.service_id }}') {
      serviceSelect.value = '{{ appointment_data.service_id }}';
      // –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ change –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω—ã
      serviceSelect.dispatchEvent(new Event('change'));
    }

    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—É–º–º—ã
    const amountInput = document.getElementById('amountInput');
    if (amountInput && {{ appointment_data.amount }}) {
      amountInput.value = {{ appointment_data.amount }};
    }

    console.log('–§–æ—Ä–º–∞ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –∏–∑ –∑–∞–ø–∏—Å–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è');
  });
  {% endif %}

</script>

{% endblock %}
