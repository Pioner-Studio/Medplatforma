{% extends "base.html" %} {% block content %}

<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px">
  <button
    id="btnAdd"
    class="btn"
    style="
      background: #1976d2;
      color: #fff;
      border-radius: 8px;
      padding: 8px 16px;
    "
  >
    Добавить запись
  </button>
  <span id="legend" style="opacity: 0.6"
    >Клик по пустой ячейке — создать • Перетаскивание — перенос • Клик по записи
    — редактировать</span
  >
</div>

<div
  id="calendar"
  style="
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 1px 8px #e3eaf9b7;
    padding: 8px;
    min-height: 72vh;
  "
></div>

<!-- Модал: новая запись -->
<div
  id="mCreate"
  style="
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.35);
    z-index: 9999;
  "
>
  <div
    style="
      background: #fff;
      max-width: 560px;
      margin: 7vh auto;
      padding: 16px;
      border-radius: 12px;
    "
  >
    <h3 style="margin: 0 0 10px">Новая запись</h3>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
      <label
        >Начало
        <input
          id="c_start"
          type="datetime-local"
          step="300"
          style="width: 100%"
        />
      </label>
      <label
        >Окончание
        <input
          id="c_end"
          type="datetime-local"
          step="300"
          style="width: 100%"
        />
      </label>

      <label
        >Врач
        <select id="c_doctor" style="width: 100%"></select>
      </label>
      <label
        >Пациент
        <select id="c_patient" style="width: 100%"></select>
      </label>

      <label
        >Услуга
        <select id="c_service" style="width: 100%"></select>
        <small id="c_service_hint" style="opacity: 0.7"></small>
      </label>
      <label
        >Кабинет
        <select id="c_room" style="width: 100%"></select>
      </label>
    </div>

    <div style="display: flex; gap: 8px; align-items: center; margin: 10px 0">
      <button type="button" class="btn" data-s="+15">+15</button>
      <button type="button" class="btn" data-s="+30">+30</button>
      <button type="button" class="btn" data-s="+60">+60</button>
      <button type="button" class="btn" id="c_tomorrow">Завтра</button>
      <button type="button" class="btn" id="c_firstfree">
        Первый свободный слот
      </button>
      <small
        id="c_warn"
        style="color: #b45309; display: none; margin-left: 8px"
      ></small>
    </div>

    <div style="display: flex; gap: 8px; justify-content: flex-end">
      <button id="c_save" class="btn btn-primary">Создать</button>
      <button id="c_close" class="btn">Отмена</button>
    </div>
  </div>
</div>

<!-- Модал: быстрое редактирование -->
<div
  id="mQuick"
  style="
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.35);
    z-index: 9999;
  "
>
  <div
    style="
      background: #fff;
      max-width: 520px;
      margin: 10vh auto;
      padding: 16px;
      border-radius: 12px;
    "
  >
    <h3 style="margin: 0 0 10px">Редактировать запись</h3>
    <input type="hidden" id="q_id" />
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
      <label
        >Начало
        <input
          id="q_start"
          type="datetime-local"
          step="300"
          style="width: 100%"
        />
      </label>
      <label
        >Окончание
        <input
          id="q_end"
          type="datetime-local"
          step="300"
          style="width: 100%"
        />
      </label>
    </div>

    <div style="display: flex; gap: 8px; align-items: center; margin: 10px 0">
      <button type="button" class="btn" data-q="+15">+15</button>
      <button type="button" class="btn" data-q="+30">+30</button>
      <button type="button" class="btn" data-q="+60">+60</button>
      <small
        id="q_warn"
        style="color: #b45309; display: none; margin-left: 8px"
      ></small>
    </div>

    <div style="display: flex; gap: 8px; justify-content: flex-end">
      <button
        id="q_delete"
        class="btn"
        style="background: #fee2e2; border: 1px solid #fecaca"
      >
        Удалить
      </button>
      <button id="q_save" class="btn btn-primary">Сохранить</button>
      <button id="q_close" class="btn">Отмена</button>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<link
  href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css"
  rel="stylesheet"
/>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // ------------- helpers -------------
    const $ = (s) => document.querySelector(s);
    const pad = (n) => String(n).padStart(2, "0");
    const addMin = (d, m) => new Date(d.getTime() + m * 60000);
    const fmtISO = (d) =>
      `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(
        d.getHours()
      )}:${pad(d.getMinutes())}`;

    let dicts = null;
    async function loadDicts() {
      if (dicts) return dicts;
      const r = await fetch("/api/dicts");
      const j = await r.json();
      if (!j.ok) throw new Error("dicts failed");
      dicts = j;
      return j;
    }
    function fillOptions(el, arr) {
      el.innerHTML = (arr || [])
        .map((x) => `<option value="${x.id}">${x.name}</option>`)
        .join("");
    }

    // ------------- CREATE modal -------------
    const mC = $("#mCreate");
    const c_start = $("#c_start"),
      c_end = $("#c_end");
    const c_doctor = $("#c_doctor"),
      c_patient = $("#c_patient"),
      c_service = $("#c_service"),
      c_room = $("#c_room");
    const c_hint = $("#c_service_hint"),
      c_warn = $("#c_warn");

    async function openCreateAt(dateStr) {
      const d = await loadDicts();
      fillOptions(c_doctor, d.doctors);
      fillOptions(c_patient, d.patients);
      fillOptions(c_service, d.services);
      fillOptions(c_room, d.rooms);

      c_start.value = fmtISO(new Date(dateStr));
      // авто-длительность по услуге
      const svc = d.services.find((s) => s.id === c_service.value);
      const dur = parseInt(svc?.duration_min ?? 30, 10);
      c_end.value = fmtISO(addMin(new Date(c_start.value), dur));
      c_hint.textContent = `Длительность услуги: ${dur} мин.`;

      c_service.onchange = () => {
        const s = d.services.find((s) => s.id === c_service.value);
        const dd = parseInt(s?.duration_min ?? 30, 10);
        c_end.value = fmtISO(addMin(new Date(c_start.value), dd));
        c_hint.textContent = `Длительность услуги: ${dd} мин.`;
      };

      mC.style.display = "block";
    }
    function closeCreate() {
      mC.style.display = "none";
    }

    $("#c_close").onclick = closeCreate;
    document.querySelectorAll("#mCreate [data-s]").forEach((b) => {
      b.onclick = () => {
        const m = parseInt(b.getAttribute("data-s").replace("+", ""), 10);
        const s = new Date(c_start.value);
        const e = new Date(c_end.value || s);
        const dur = Math.max(5, Math.round((e - s) / 60000));
        const ns = addMin(s, m);
        c_start.value = fmtISO(ns);
        c_end.value = fmtISO(addMin(ns, dur));
      };
    });
    $("#c_tomorrow").onclick = () => {
      const s = new Date(c_start.value);
      s.setDate(s.getDate() + 1);
      c_start.value = fmtISO(s);
      const svc = dicts.services.find((x) => x.id === c_service.value);
      const dur = parseInt(svc?.duration_min ?? 30, 10);
      c_end.value = fmtISO(addMin(s, dur));
    };
    $("#c_firstfree").onclick = async () => {
      const roomId = c_room.value;
      const start = new Date(c_start.value);
      const day = `${start.getFullYear()}-${pad(start.getMonth() + 1)}-${pad(
        start.getDate()
      )}`;
      const r = await fetch(
        `/api/rooms/busy?room_id=${encodeURIComponent(roomId)}&date=${day}`
      );
      const j = await r.json();
      if (!j.ok) return alert("Не удалось проверить занятость");
      const svc = dicts.services.find((x) => x.id === c_service.value);
      const dur = parseInt(svc?.duration_min ?? 30, 10);

      const busy = (j.items || [])
        .map((i) => {
          const [sh, sm] = i.start.split(":").map(Number);
          const [eh, em] = i.end.split(":").map(Number);
          return { s: sh * 60 + sm, e: eh * 60 + em };
        })
        .sort((a, b) => a.s - b.s);

      let cursor = start.getHours() * 60 + start.getMinutes();
      const endDay = 21 * 60;
      while (cursor + dur <= endDay) {
        const overlap = busy.some(
          (b) => !(cursor + dur <= b.s || cursor >= b.e)
        );
        if (!overlap) {
          const base = new Date(start);
          base.setHours(Math.floor(cursor / 60), cursor % 60, 0, 0);
          c_start.value = fmtISO(base);
          c_end.value = fmtISO(addMin(base, dur));
          return;
        }
        cursor += 5;
      }
      alert("Свободных слотов сегодня нет");
    };

    $("#c_save").onclick = async () => {
      const body = {
        start: c_start.value,
        end: c_end.value,
        doctor_id: c_doctor.value || null,
        patient_id: c_patient.value || null,
        service_id: c_service.value || null,
        room_id: c_room.value,
        note: "",
      };
      const r = await fetch("/schedule/api/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const j = await r.json();
      if (!j.ok) {
        alert(j.error || "Не удалось создать");
        return;
      }
      calendar.refetchEvents();
      closeCreate();
    };

    // ------------- QUICK modal -------------
    const mQ = $("#mQuick");
    const q_id = $("#q_id"),
      q_start = $("#q_start"),
      q_end = $("#q_end"),
      q_warn = $("#q_warn");
    function openQuick(id, startStr, endStr) {
      q_id.value = id;
      q_start.value = fmtISO(new Date(startStr));
      q_end.value = fmtISO(new Date(endStr));
      q_warn.style.display = "none";
      mQ.style.display = "block";
    }
    function closeQuick() {
      mQ.style.display = "none";
    }
    $("#q_close").onclick = closeQuick;
    document.querySelectorAll("#mQuick [data-q]").forEach((b) => {
      b.onclick = () => {
        const m = parseInt(b.getAttribute("data-q").replace("+", ""), 10);
        const s = new Date(q_start.value);
        const e = new Date(q_end.value || s);
        const dur = Math.max(5, Math.round((e - s) / 60000));
        const ns = addMin(s, m);
        q_start.value = fmtISO(ns);
        q_end.value = fmtISO(addMin(ns, dur));
      };
    });
    $("#q_save").onclick = async () => {
      const body = { id: q_id.value, start: q_start.value, end: q_end.value };
      const r = await fetch("/schedule/api/move", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const j = await r.json();
      if (!j.ok) {
        alert(j.error || "Не удалось сохранить");
        return;
      }
      calendar.refetchEvents();
      closeQuick();
    };
    $("#q_delete").onclick = async () => {
      if (!confirm("Удалить запись?")) return;
      const r = await fetch("/schedule/api/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: q_id.value }),
      });
      const j = await r.json();
      if (!j.ok) {
        alert(j.error || "Не удалось удалить");
        return;
      }
      calendar.refetchEvents();
      closeQuick();
    };

    // ------------- FullCalendar -------------
    const calEl = document.getElementById("calendar");
    const calendar = new FullCalendar.Calendar(calEl, {
      initialView: "timeGridWeek",
      locale: "ru",
      timeZone: "local",
      firstDay: 1,
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay",
      },
      slotDuration: "00:15:00",
      snapDuration: "00:15:00",
      slotMinTime: "09:00:00",
      slotMaxTime: "21:00:00",
      businessHours: {
        daysOfWeek: [1, 2, 3, 4, 5, 6],
        startTime: "09:00",
        endTime: "21:00",
      },
      selectable: true,
      editable: true,
      eventOverlap: true,

      select: (info) => {
        // открыть модал создания
        openCreateAt(info.startStr);
        calendar.unselect();
      },

      events: (fetchInfo, success, failure) => {
        const params = new URLSearchParams({
          start: fetchInfo.startStr,
          end: fetchInfo.endStr,
        });
        fetch("/api/events?" + params.toString())
          .then((r) => r.json())
          .then(success)
          .catch(failure);
      },

      eventClick: (info) => {
        info.jsEvent.preventDefault();
        openQuick(info.event.id, info.event.startStr, info.event.endStr);
      },

      eventDrop: async (info) => {
        const body = {
          id: info.event.id,
          start: info.event.startStr,
          end: info.event.endStr,
        };
        const r = await fetch("/schedule/api/move", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const j = await r.json();
        if (!j.ok) {
          alert(j.error || "Конфликт/ошибка");
          info.revert();
        }
      },

      eventResize: async (info) => {
        const body = {
          id: info.event.id,
          start: info.event.startStr,
          end: info.event.endStr,
        };
        const r = await fetch("/schedule/api/move", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const j = await r.json();
        if (!j.ok) {
          alert(j.error || "Конфликт/ошибка");
          info.revert();
        }
      },
    });
    calendar.render();

    // «Плюс» сверху
    $("#btnAdd").onclick = () => openCreateAt(new Date().toISOString());
  });
</script>
{% endblock %}
