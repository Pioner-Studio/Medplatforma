{% extends 'base.html' %}
{% block title %}Календарь{% endblock %}
{% block head %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<style>
    #calendar { max-width: 1100px; margin: 30px auto; background: #fff; border-radius: 22px; box-shadow: 0 6px 32px rgba(20,40,80,.08); padding: 30px;}
</style>
{% endblock %}
{% block content %}
<div id="calendar"></div>

<!-- Модалка просмотра приёма -->
<div id="appointmentModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(40,50,80,0.23); z-index:99; justify-content:center; align-items:center;">
  <div style="background:#fff; border-radius:20px; max-width:460px; width:94%; padding:32px 32px 24px 32px; box-shadow:0 6px 36px rgba(20,40,80,0.13); position:relative;">
    <button onclick="closeAppointmentModal()" style="position:absolute; right:18px; top:18px; background:none; border:none; font-size:1.2rem; color:#888; cursor:pointer;">✖</button>
    <div id="modalContent"></div>
  </div>
</div>

<!-- Модалка добавления приёма -->
<div id="addEventModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(40,50,80,0.18); z-index:99; justify-content:center; align-items:center;">
  <div style="background:#fff; border-radius:18px; max-width:420px; width:94%; padding:28px 28px 20px 28px; box-shadow:0 6px 24px rgba(20,40,80,0.13); position:relative;">
    <button onclick="closeAddEventModal()" style="position:absolute; right:16px; top:16px; background:none; border:none; font-size:1.1rem; color:#888; cursor:pointer;">✖</button>
    <form method="POST" action="/add_event">
        <input type="hidden" name="datetime" id="addEventDate">
        <div style="font-weight:600; font-size:1.12rem; margin-bottom:8px;">Добавить приём</div>
        <div style="margin-bottom:8px;">
            <label>Врач:</label>
            <select name="doctor_id" required style="width:100%; padding:8px; border-radius:7px; border:1px solid #ccd;">
                {% for doc in doctors %}
                <option value="{{ doc._id }}">{{ doc.full_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div style="margin-bottom:8px;">
            <label>Пациент:</label>
            <select name="patient_id" required style="width:100%; padding:8px; border-radius:7px; border:1px solid #ccd;">
                {% for pat in patients %}
                <option value="{{ pat._id }}">{{ pat.full_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div style="margin-bottom:8px;">
            <label>Услуга:</label>
            <input type="text" name="service" required style="width:100%; padding:8px; border-radius:7px; border:1px solid #ccd;">
        </div>
        <div style="margin-bottom:8px;">
            <label>Сумма:</label>
            <input type="number" name="sum" min="0" step="0.01" style="width:100%; padding:8px; border-radius:7px; border:1px solid #ccd;">
        </div>
        <div style="margin-bottom:12px;">
            <label>Комментарий:</label>
            <input type="text" name="comment" style="width:100%; padding:8px; border-radius:7px; border:1px solid #ccd;">
        </div>
        <button type="submit" style="background:#445be2; color:#fff; border:none; border-radius:8px; padding:9px 19px; font-weight:600;">Добавить</button>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridDay',
            locale: 'ru',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            buttonText: {
                today:    'Сегодня',
                month:    'Месяц',
                week:     'Неделя',
                day:      'День',
                list:     'Список'
            },
            allDayText: "Весь день",
            events: {{ events | tojson }},
            height: 700,
            eventClick: function(info) {
                fetch('/api/event/' + info.event.id)
                    .then(response => response.json())
                    .then(data => {
                        showAppointmentModal(data);
                    });
            },
            dateClick: function(info) {
                showAddEventModal(info.dateStr);
            }
        });
        calendar.render();
    });

    function showAppointmentModal(data) {
        document.getElementById('modalContent').innerHTML = `
            <div style="font-weight:700; font-size:1.18rem; margin-bottom:10px;">Детали приёма</div>
            <div style="margin-bottom:10px;"><b>Пациент:</b> <a href="/patient/${data.patient_id}" style="color:#2236a7;">${data.patient_name}</a></div>
            <div style="margin-bottom:10px;"><b>Врач:</b> <a href="/doctor/${data.doctor_id}" style="color:#2236a7;">${data.doctor_name}</a></div>
            <div style="margin-bottom:10px;"><b>Дата и время:</b> ${data.datetime}</div>
            <div style="margin-bottom:10px;"><b>Услуга:</b> ${data.service}</div>
            <div style="margin-bottom:10px;"><b>Стоимость:</b> ${data.sum} ₽</div>
            ${data.comment ? `<div style="margin-bottom:10px;"><b>Комментарий:</b> ${data.comment}</div>` : ''}
            <button onclick="window.location.href='/edit_event/${data._id}'" style="background:#445be2; color:#fff; border:none; border-radius:10px; padding:9px 18px; font-weight:600; margin-top:8px;">Редактировать</button>
        `;
        document.getElementById('appointmentModal').style.display = 'flex';
    }
    function closeAppointmentModal() {
        document.getElementById('appointmentModal').style.display = 'none';
    }
    function showAddEventModal(dateStr) {
        document.getElementById('addEventDate').value = dateStr;
        document.getElementById('addEventModal').style.display = 'flex';
    }
    function closeAddEventModal() {
        document.getElementById('addEventModal').style.display = 'none';
    }
</script>
{% endblock %}
