{% extends "base.html" %} {% block title %}Планы на согласовании{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="row mb-4">
    <div class="col">
      <h2>Планы лечения на согласовании</h2>
      <p class="text-muted">Ожидают вашего утверждения</p>
    </div>
  </div>

  {% if plans %}
  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Дата отправки</th>
          <th>Пациент</th>
          <th>Врач</th>
          <th>Количество услуг</th>
          <th>Сумма</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        {% for plan in plans %}
        <tr>
          <td>
            {{ plan.submitted_to_chief_at.strftime("%d.%m.%Y %H:%M") if
            plan.submitted_to_chief_at else "-" }}
          </td>
          <td>
            <a
              href="/patients/{{ plan.patient_id }}"
              class="text-decoration-none"
            >
              {{ plan.patient_name }}
            </a>
          </td>
          <td>{{ plan.doctor_name }}</td>
          <td>{{ plan.services|length }} услуг(и)</td>
          <td>
            <strong
              >{{ "{:,}".format(plan.total_amount).replace(",", " ") }}
              ₽</strong
            >
          </td>
          <td>
            <button
              class="btn btn-sm btn-info"
              onclick="showPlanDetails('{{ plan._id }}')"
            >
              <i class="bi bi-eye"></i> Подробнее
            </button>
            {% if session.get('user') and session.user.role == 'chief_doctor' %}
            <button
              class="btn btn-sm btn-success"
              onclick="approvePlan('{{ plan._id }}')"
            >
              <i class="bi bi-check-circle"></i> Утвердить
            </button>
            <button
              class="btn btn-sm btn-warning"
              onclick="showRevisionModal('{{ plan._id }}')"
            >
              <i class="bi bi-pencil-square"></i> Запросить изменения
            </button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="alert alert-info">
    <i class="bi bi-info-circle"></i> Нет планов на согласовании
  </div>
  {% endif %}
</div>

<!-- Модальное окно "Подробнее" -->
<div class="modal fade" id="planDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Детали плана лечения</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body" id="planDetailsContent">Загрузка...</div>
    </div>
  </div>
</div>

<!-- Модальное окно запроса изменений -->
<div class="modal fade" id="revisionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Запросить изменения плана</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <p>Укажите что необходимо изменить в плане лечения:</p>
        <textarea
          id="revisionComment"
          class="form-control"
          rows="4"
          placeholder="Например: Замените имплант на более дешевый вариант..."
        ></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Отмена
        </button>
        <button
          type="button"
          class="btn btn-warning"
          onclick="requestRevision()"
        >
          Отправить на доработку
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let currentPlanId = null;

  function showPlanDetails(planId) {
    fetch(`/chief/plan-details/${planId}`)
      .then((r) => r.json())
      .then((data) => {
        document.getElementById("planDetailsContent").innerHTML = `
        <h6>Пациент: ${data.patient_name}</h6>
        <h6>Врач: ${data.doctor_name}</h6>
        <hr>
        <h6>Услуги:</h6>
        <table class="table table-sm">
          <thead><tr><th>Услуга</th><th>Цена</th><th>Комментарий</th></tr></thead>
          <tbody>
            ${data.services
              .map(
                (s) => `
              <tr>
                <td>${s.service_name}</td>
                <td>${s.price.toLocaleString()} ₽</td>
                <td>${s.comment || "-"}</td>
              </tr>
            `
              )
              .join("")}
          </tbody>
        </table>
        <h5 class="mt-3">Итого: ${data.total_amount.toLocaleString()} ₽</h5>
        ${
          data.notes
            ? `<p class="mt-3"><strong>Примечания:</strong><br>${data.notes}</p>`
            : ""
        }
      `;
        new bootstrap.Modal(document.getElementById("planDetailsModal")).show();
      });
  }

  function approvePlan(planId) {
    if (!confirm("Утвердить этот план лечения?")) return;

    fetch(`/chief/approve-plan/${planId}`, { method: "POST" })
      .then((r) => r.json())
      .then((data) => {
        if (data.success) {
          alert("План утверждён!");
          location.reload();
        } else {
          alert("Ошибка: " + data.error);
        }
      });
  }

  function showRevisionModal(planId) {
    currentPlanId = planId;
    document.getElementById("revisionComment").value = "";
    new bootstrap.Modal(document.getElementById("revisionModal")).show();
  }

  function requestRevision() {
    const comment = document.getElementById("revisionComment").value.trim();

    if (!comment) {
      alert("Укажите что необходимо изменить");
      return;
    }

    fetch(`/chief/request-revision/${currentPlanId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ comment: comment }),
    })
      .then((r) => r.json())
      .then((data) => {
        if (data.success) {
          location.reload();
        } else {
          alert("Ошибка: " + data.error);
        }
      });
  }
</script>
{% endblock %}
