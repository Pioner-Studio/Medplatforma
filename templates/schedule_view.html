<!-- Version: 2.0 - 06.10.2025 -->
{% extends "base.html" %}
{% block content %}

<!-- –ú–µ—Ç—Ä–∏–∫–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
<div
  style="
    display: flex;
    align-items: center;
    gap: 22px;
    padding: 6px 0 6px 12px;
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 1px 8px #e3eaf9b7;
    margin-bottom: 10px;
  "
>
  <span title="–í—Å–µ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–æ–≤">
    <i class="fa-solid fa-house-chimney-medical" style="color: #467fe3"></i>
    <b>{{ metrics.total_rooms }}</b>
  </span>
  <span title="–°–≤–æ–±–æ–¥–Ω—ã–µ">
    <i class="fa-solid fa-circle-check" style="color: #21ba45"></i>
    <b>{{ metrics.free_rooms }}</b>
  </span>
  <span style="margin-left: auto; display: flex; gap: 12px">
    <a
      href="{{ url_for('add_event') }}"
      class="btn-main"
      style="
        background: #1976d2;
        color: #fff;
        font-weight: 600;
        border-radius: 8px;
        padding: 8px 22px;
        font-size: 1.07em;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
      "
    >
      <i class="fa-solid fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
    </a>
    <a
      href="{{ url_for('export_calendar') }}"
      class="btn-main btn-export"
      style="
        background: #fff;
        color: #3185cb;
        border: 1.5px solid #dbeafd;
        font-weight: 600;
        border-radius: 8px;
        padding: 8px 18px;
        font-size: 1.07em;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
      "
    >
      <i class="fa-solid fa-file-arrow-down"></i> –í—ã–≥—Ä—É–∑–∫–∞
    </a>
  </span>
</div>

<!-- –ö–∞–±–∏–Ω–µ—Ç—ã –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å -->
<div
  id="roomsBar"
  style="display: flex; gap: 36px; margin: 14px 0 12px 8px; flex-wrap: wrap"
>
  {% for cab in cabinets %} {% set info = room_info.get(cab) if room_info else
  None %}
  <span
    data-room-name="{{ cab }}"
    style="font-size: 1.12em; font-weight: 600; cursor: default"
  >
    {{ cab }} ‚Äî
    <b
      class="room-status-text"
      style="color:{{ info.color if info else 'inherit' }}"
    >
      {{ info.text if info else '‚Äî' }}
    </b>
    <span
      class="room-next"
      style="opacity: 0.7; font-weight: 500; margin-left: 8px"
    >
      {% if info and info.state == 'available' and info.next %} {% set t =
      info.next.start.split('T')[1] if info.next.start else '' %} –ë–ª–∏–∂–∞–π—à–∏–π: {{
      t }} {% if info.next.in_minutes is not none %} (—á–µ—Ä–µ–∑ {% if
      info.next.in_minutes < 0 %}0 –º–∏–Ω {% elif info.next.in_minutes < 60 %}{{
      info.next.in_minutes }} –º–∏–Ω {% else %}{{ (info.next.in_minutes // 60)|int
      }} —á {{ (info.next.in_minutes % 60)|int }} –º–∏–Ω {% endif %} ) {% endif %}
      {% if info.next.service or info.next.patient %} ‚Ä¢ {{ info.next.service
      }}{% if info.next.service and info.next.patient %} ‚Äî {% endif %}{{
      info.next.patient }} {% endif %} {% endif %}
    </span>
  </span>
  {% endfor %}
</div>

<div
  class="calendar-filters"
  style="display: flex; gap: 12px; align-items: center; margin-bottom: 18px"
>
  <select id="doctorFilter" class="filter-select">
    <option value="">–í—Å–µ –≤—Ä–∞—á–∏</option>
    {% for doc in doctors %}
    <option value="{{ doc._id }}">{{ doc.full_name }}</option>
    {% endfor %}
  </select>

  <!-- –ü–û–ò–°–ö –ü–ê–¶–ò–ï–ù–¢–ê (—É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π) -->
  <div class="ps-wrap" style="position: relative; max-width: 320px">
    <input
      id="psInput"
      class="form-control"
      type="text"
      autocomplete="off"
      placeholder="–ü–æ–∏—Å–∫ –ø–∞—Ü–∏–µ–Ω—Ç–∞."
    />
    <div
      id="psDrop"
      class="ps-drop"
      style="
        display: none;
        position: absolute;
        left: 0;
        right: 0;
        top: 100%;
        z-index: 4000;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-top: 0;
        max-height: 280px;
        overflow: auto;
        border-radius: 0 0 8px 8px;
      "
    ></div>
  </div>

  <input type="hidden" id="psSelectedId" value="" />

  <select id="serviceFilter" class="filter-select">
    <option value="">–í—Å–µ —É—Å–ª—É–≥–∏</option>
    {% for service in services %}
    <option value="{{ service._id }}">{{ service.name }}</option>
    {% endfor %}
  </select>

  <select id="cabinetFilter" class="filter-select">
    <option value="">–í—Å–µ –∫–∞–±–∏–Ω–µ—Ç—ã</option>
    {% for cab in cabinets %}
    <option value="{{ cab }}">{{ cab }}</option>
    {% endfor %}
  </select>

  <button id="btnResetFilters" class="btn btn-outline-secondary">
    –°–±—Ä–æ—Å–∏—Ç—å
  </button>
</div>

<!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
<div
  id="calendar"
  style="
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 1px 8px #e3eaf9b7;
    padding: 8px;
    min-height: 72vh;
  "
></div>

<!-- –ú–æ–¥–∞–ª–∫–∞ -->
<div
  id="quickModal"
  style="
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.35);
    z-index: 9999;
  "
>
  <div
    style="
      background: #fff;
      max-width: 680px;
      margin: 7vh auto;
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 8px 28px rgba(0, 0, 0, 0.08);
    "
  >
    <div
      style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px"
    >
      <h3 style="margin: 0; flex: 1">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å</h3>
      <button
        id="qmClose"
        type="button"
        style="
          border: none;
          background: #eee;
          border-radius: 8px;
          padding: 6px 10px;
          cursor: pointer;
        "
      >
        √ó
      </button>
    </div>

    <form
      id="qmForm"
      style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px"
    >
      <input type="hidden" id="qm_id" />

      <label
        >–í—Ä–∞—á
        <select
          id="qm_doctor"
          class="filter-select"
          required
          style="width: 100%"
        ></select>
      </label>

      <label
        >–ü–∞—Ü–∏–µ–Ω—Ç
        <div style="display: flex; gap: 8px; align-items: center; width: 100%">
          <select
            id="qm_patient"
            class="filter-select"
            required
            style="width: 100%"
          ></select>
          <!-- ==== CONTACT BAR (–Ω–∞–¥ –∫–∞–ª–µ–Ω–¥–∞—Ä—ë–º) ==== -->
          <div class="btn-group" role="group" aria-label="–ö–æ–Ω—Ç–∞–∫—Ç—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞">
            {% if patient is defined and patient %}
            <button
              type="button"
              class="btn btn-light"
              title="–ü–æ–∑–≤–æ–Ω–∏—Ç—å"
              onclick="mpOpenContact('tel')"
            >
              üìû
            </button>
            <button
              type="button"
              class="btn btn-light"
              title="WhatsApp"
              onclick="mpOpenContact('wa')"
            >
              üü¢
            </button>
            <button
              type="button"
              class="btn btn-light"
              title="Telegram"
              onclick="mpOpenContact('tg')"
            >
              ‚úàÔ∏è
            </button>
            <button
              type="button"
              class="btn btn-light"
              title="E-mail"
              onclick="mpOpenContact('mail')"
            >
              ‚úâÔ∏è
            </button>
            <button
              type="button"
              class="btn btn-light"
              title="Max"
              onclick="mpOpenContact('max')"
            >
              ‚ìÇÔ∏è
            </button>
            {% endif %}
          </div>
          <!-- ======================================= -->

          <button
            type="button"
            id="qm_patient_add"
            class="btn"
            style="white-space: nowrap"
          >
            + –ù–æ–≤—ã–π
          </button>
        </div>

        <!-- –∏–Ω–ª–∞–π–Ω-—Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞ -->
        <div
          id="qm_patient_new"
          style="display: none; margin-top: 8px; width: 100%"
        >
          <div class="qm-patient-grid">
            <input
              id="qm_new_full_name"
              type="text"
              placeholder="–§–ò–û –ø–æ–ª–Ω–æ—Å—Ç—å—é"
              autocomplete="name"
            />
            <input
              id="qm_new_phone"
              type="tel"
              inputmode="tel"
              pattern="[\+\d\s\-\(\)]{6,}"
              title="+7 999 123-45-67"
              placeholder="+7 999 123-45-67"
            />
            <input id="qm_new_birth" type="date" placeholder="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è" />
            <div class="qm-patient-actions">
              <button
                type="button"
                id="qm_patient_save"
                class="btn btn-primary"
              >
                –°–æ–∑–¥–∞—Ç—å
              </button>
              <button type="button" id="qm_patient_cancel" class="btn">
                –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        </div>
        <!-- –ü–∞–Ω–µ–ª—å –±—ã—Å—Ç—Ä—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
        <div
          id="qm_contact_bar"
          style="
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 6px 0 2px 0;
          "
        >
          <a
            id="cb_tel"
            class="btn"
            target="_blank"
            rel="noopener"
            title="–ü–æ–∑–≤–æ–Ω–∏—Ç—å"
            style="padding: 4px 8px"
            >üìû Tel</a
          >
          <a
            id="cb_wa"
            class="btn"
            target="_blank"
            rel="noopener"
            title="WhatsApp"
            style="padding: 4px 8px"
            >üü¢ WA</a
          >
          <a
            id="cb_tg"
            class="btn"
            target="_blank"
            rel="noopener"
            title="Telegram"
            style="padding: 4px 8px"
            >üîµ TG</a
          >
          <a
            id="cb_max"
            class="btn"
            target="_blank"
            rel="noopener"
            title="Max"
            style="padding: 4px 8px"
            >üü£ Max</a
          >
          <a
            id="cb_email"
            class="btn"
            target="_blank"
            rel="noopener"
            title="Email"
            style="padding: 4px 8px"
            >‚úâÔ∏è Mail</a
          >
          <small id="cb_hint" style="opacity: 0.7; margin-left: 6px"></small>
        </div>
      </label>
      <label
        >–£—Å–ª—É–≥–∞
        <select
          id="qm_service"
          class="filter-select"
          required
          style="width: 100%"
        ></select>
        <small id="qm_service_hint" style="opacity: 0.7"></small>
      </label>

      <label
        >–ö–∞–±–∏–Ω–µ—Ç
        <select
          id="qm_room"
          class="filter-select"
          required
          style="width: 100%"
        ></select>
      </label>

      <label
        >–ù–∞—á–∞–ª–æ
        <input
          type="datetime-local"
          id="qm_start"
          required
          step="300"
          style="width: 100%"
        />
      </label>

      <label
        >–û–∫–æ–Ω—á–∞–Ω–∏–µ
        <input
          type="datetime-local"
          id="qm_end"
          step="300"
          style="width: 100%"
        />
      </label>

      <label
        >–°—Ç–∞—Ç—É—Å
        <select
          id="qm_status"
          class="filter-select"
          required
          style="width: 100%"
        >
          <option value="scheduled">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω</option>
          <option value="arrived">–ü—Ä–∏–±—ã–ª</option>
          <option value="done">–ó–∞–≤–µ—Ä—à—ë–Ω</option>
          <option value="cancelled">–û—Ç–º–µ–Ω—ë–Ω</option>
        </select>
      </label>

      <label style="grid-column: 1 / -1"
        >–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        <textarea id="qm_comment" rows="3" style="width: 100%"></textarea>
      </label>

      <div
        style="
          grid-column: 1/-1;
          display: flex;
          gap: 8px;
          align-items: center;
          margin-top: -4px;
        "
      >
        <button
          type="button"
          class="btn"
          id="btn_plus_15"
          style="
            border: 1px solid #dbeafd;
            border-radius: 8px;
            padding: 6px 10px;
          "
        >
          +15 –º–∏–Ω
        </button>
        <button
          type="button"
          class="btn"
          id="btn_plus_30"
          style="
            border: 1px solid #dbeafd;
            border-radius: 8px;
            padding: 6px 10px;
          "
        >
          +30 –º–∏–Ω
        </button>
        <button
          type="button"
          class="btn"
          id="btn_plus_60"
          style="
            border: 1px solid #dbeafd;
            border-radius: 8px;
            padding: 6px 10px;
          "
        >
          +60 –º–∏–Ω
        </button>
        <span style="opacity: 0.6; margin: 0 6px">|</span>
        <button
          type="button"
          class="btn"
          id="btn_move_tomorrow"
          style="
            border: 1px solid #dbeafd;
            border-radius: 8px;
            padding: 6px 10px;
          "
        >
          –ù–∞ –∑–∞–≤—Ç—Ä–∞ (—Ç–æ –∂–µ –≤—Ä–µ–º—è)
        </button>
        <span style="opacity: 0.6; margin: 0 6px">|</span>
        <button
          type="button"
          class="btn"
          id="btn_first_free"
          style="
            border: 1px solid #dbeafd;
            border-radius: 8px;
            padding: 6px 10px;
          "
        >
          –ü–µ—Ä–≤—ã–π —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç (–∫–∞–±–∏–Ω–µ—Ç)
        </button>
      </div>
      <small
        id="qm_warn"
        style="grid-column: 1/-1; color: #b45309; display: none"
        >–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</small
      >

      <div
        style="
          grid-column: 1/-1;
          display: flex;
          justify-content: flex-end;
          gap: 8px;
        "
      >
        <button
          type="button"
          id="qmDelete"
          class="btn"
          style="background: #fee2e2; border: 1px solid #fecaca"
        >
          –£–¥–∞–ª–∏—Ç—å
        </button>
        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<!-- Toasts -->
<div
  id="toastStack"
  style="
    position: fixed;
    right: 16px;
    top: 16px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 8px;
  "
></div>

{% endblock %}
{% block scripts %}
{{ super() }}

<script>
  // –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –ø—Ä–∞–≤–¥—ã –¥–ª—è –≤—Å–µ—Ö API-—ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤.
  window.ROUTES = {
    dictsApi: "/api/dicts",
    patientsApi: "/api/patients",
    contactsApi: "/api/contacts",
    doctorSchedule: "/api/doctor_schedule",
    eventsApi: "/api/events",
    freeSlots: "/api/free_slots",
    roomsStatusNow: "/api/rooms/status_now",
    roomsBusy: "/api/rooms/busy",
    todayDetailsApi: "/api/rooms/today_details",
    appointments: "/api/appointments",
    appointmentsCreate: "/api/appointments/create",
    appointmentsUpdateTime: "/api/appointments/update_time",
    appointmentsDelete: "/api/appointments/delete",
  };
</script>

<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
/>
<link
  href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css"
  rel="stylesheet"
/>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales-all.global.min.js"></script>

<script>
  // –¢–æ—á–∫–∏ API –¥–ª—è —Ç—É–ª—Ç–∏–ø–∞ ¬´—Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã¬ª –∏ –ø–æ–ø–∞–ø–∞ ¬´... ‚Äî —Å–µ–≥–æ–¥–Ω—è¬ª
  const ROUTES = {
    freeSlots: "/api/free_slots",
    todayDetailsApi: "/api/rooms/today_details",
  };
</script>

<style>
  /* —Ñ–æ—Ä–º–∞ –Ω–æ–≤–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–æ, –±–µ–∑ ¬´–≤—ã–ª–∞–∑–æ–≤¬ª */
  #quickModal .qm-patient-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    align-items: center;
  }
  #quickModal .qm-patient-grid input {
    width: 100%;
    height: 36px;
    padding: 8px 10px;
    border: 1px solid #dbeafd;
    border-radius: 8px;
    box-sizing: border-box;
  }
  #quickModal .qm-patient-grid input:focus {
    outline: none;
    border-color: #a5c5ff;
    box-shadow: 0 0 0 3px rgba(73, 133, 255, 0.12);
  }
  #quickModal .qm-patient-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-start;
  }
  @media (min-width: 740px) {
    #quickModal .qm-patient-grid {
      grid-template-columns: 1fr 1fr;
    }
    #quickModal .qm-patient-grid > :first-child {
      grid-column: 1 / -1;
    } /* –§–ò–û */
    #quickModal .qm-patient-actions {
      grid-column: 1 / -1;
    }
  }
  @media (min-width: 900px) {
    #quickModal .qm-patient-grid {
      grid-template-columns: 1fr 180px;
    }
  }

  /* PATCH: –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
  .ps-room-clickable {
    cursor: pointer;
  }
  .ps-free-hint,
  [data-free-hint] {
    pointer-events: auto;
  }
  [data-room],
  .ps-room,
  .room,
  .ps-rooms-item,
  [data-open-room] {
    cursor: pointer;
  }
</style>

<script>
  // --- –ø—Ä–æ—Å—Ç–æ–π toast ---
  function showToast(msg, type = "info", ms = 2200) {
    const stack = document.getElementById("toastStack");
    if (!stack) {
      alert(msg);
      return;
    }
    const el = document.createElement("div");
    el.textContent = msg;
    el.style.cssText = `
      background:${
        type === "error" ? "#fee2e2" : type === "ok" ? "#e6ffed" : "#eef2ff"
      };
      color:${
        type === "error" ? "#991b1b" : type === "ok" ? "#065f46" : "#1e40af"
      };
      border:1px solid ${
        type === "error" ? "#fecaca" : type === "ok" ? "#bbf7d0" : "#c7d2fe"
      };
      box-shadow:0 6px 18px rgba(0,0,0,.08);padding:10px 14px;border-radius:10px;font-weight:600;max-width:420px`;
    stack.appendChild(el);
    setTimeout(() => {
      el.style.transition = "opacity .25s";
      el.style.opacity = "0";
      setTimeout(() => el.remove(), 260);
    }, ms);
  }
</script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // ---------- helpers ----------
    const $ = (s) => document.querySelector(s);
    const addMin = (d, m) => new Date(d.getTime() + m * 60000);
    const pad2 = (n) => String(n).padStart(2, "0");
    const fmtISO = (d) =>
      `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}T${pad2(
        d.getHours()
      )}:${pad2(d.getMinutes())}`;

    // –∫—ç—à —Å–ª–æ–≤–∞—Ä–µ–π
    window.__DICT_CACHE__ = window.__DICT_CACHE__ || null;

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∑–∞–ª–∏–≤–∫–∞ options
    function fillOptions(selectEl, items, selectedId = "") {
      if (!selectEl) return;
      const toId = (x) => x._id ?? x.id ?? "";
      const toName = (x) => x.full_name ?? x.name ?? "";
      const html = (items || [])
        .map((x) => {
          const id = toId(x),
            name = toName(x);
          return `<option value="${id}">${name}</option>`;
        })
        .join("");
      selectEl.innerHTML = html;
      if (selectedId) selectEl.value = selectedId;
      if (!selectEl.value || selectEl.value === "undefined") {
        const first = selectEl.querySelector("option")?.value || "";
        selectEl.value = first;
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤–∞—Ä–µ–π (–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è)
    async function loadDictsOnce() {
      if (window.__DICT_CACHE__) return window.__DICT_CACHE__;
      const r = await fetch(
        (window.ROUTES && window.ROUTES.dictsApi) || "/api/dicts"
      );
      const raw = await r.json();
      if (!raw?.ok) throw new Error("dicts load failed");

      const norm = (arr) =>
        (arr || []).map((x) => ({
          id: x._id ?? x.id ?? "",
          name: x.full_name ?? x.name ?? "",
          duration_min: x.duration_min,
        }));
      const data = {
        ok: true,
        doctors: norm(raw.doctors),
        patients: norm(raw.patients),
        rooms: norm(raw.rooms),
        services: norm(raw.services).map((s) => ({
          ...s,
          duration_min: s.duration_min ?? 30,
        })),
      };
      window.__DICT_CACHE__ = data;
      return data;
    }

    // ---------- —ç–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª–∫–∏ ----------
    const qm = {
      modal: $("#quickModal"),
      close: $("#qmClose"),
      form: $("#qmForm"),
      id: $("#qm_id"),
      doctor: $("#qm_doctor"),
      patient: $("#qm_patient"),
      service: $("#qm_service"),
      serviceHint: $("#qm_service_hint"),
      room: $("#qm_room"),
      start: $("#qm_start"),
      end: $("#qm_end"),
      status: $("#qm_status"),
      comment: $("#qm_comment"),
      warn: $("#qm_warn"),
      btnDel: $("#qmDelete"),
      btnPlus15: document.querySelector("#quickModal #btn_plus_15"),
      btnPlus30: document.querySelector("#quickModal #btn_plus_30"),
      btnPlus60: document.querySelector("#quickModal #btn_plus_60"),
      btnTomorrow: document.querySelector("#quickModal #btn_move_tomorrow"),
      btnFirstFree: document.querySelector("#quickModal #btn_first_free"),

      // –±–ª–æ–∫ ¬´–ù–æ–≤—ã–π –ø–∞—Ü–∏–µ–Ω—Ç¬ª
      patientAddBtn: document.getElementById("qm_patient_add"),
      patientNewRow: document.getElementById("qm_patient_new"),
      newFullName: document.getElementById("qm_new_full_name"),
      newPhone: document.getElementById("qm_new_phone"),
      newBirth: document.getElementById("qm_new_birth"),
      patientSaveBtn: document.getElementById("qm_patient_save"),
      patientCancelBtn: document.getElementById("qm_patient_cancel"),
    };

    function hideNewPatientRow() {
      if (!qm) return;
      if (qm.patientNewRow) qm.patientNewRow.style.display = "none";
      if (qm.newFullName) qm.newFullName.value = "";
      if (qm.newPhone) qm.newPhone.value = "";
      if (qm.newBirth) qm.newBirth.value = "";
    }

    // --- contacts bar (Tel/WA/TG/Max/Mail) ---------------------------------
    function setDisabledAnchor(a, disabled) {
      if (!a) return;
      if (disabled) {
        a.setAttribute("aria-disabled", "true");
        a.style.opacity = ".5";
        a.style.pointerEvents = "none";
        a.removeAttribute("href");
      } else {
        a.removeAttribute("aria-disabled");
        a.style.opacity = "1";
        a.style.pointerEvents = "auto";
      }
    }
    function onlyDigits(s) {
      return String(s || "").replace(/\D+/g, "");
    }

    async function fillContactBar(patientId) {
      const tel = document.getElementById("cb_tel");
      const wa = document.getElementById("cb_wa");
      const tg = document.getElementById("cb_tg");
      const mx = document.getElementById("cb_max");
      const em = document.getElementById("cb_email");
      const hint = document.getElementById("cb_hint");

      [tel, wa, tg, mx, em].forEach((a) => setDisabledAnchor(a, true));
      if (hint) hint.textContent = "";
      if (!patientId) return;

      try {
        const r = await fetch(
          `/api/patients/${encodeURIComponent(patientId)}/contacts`
        );
        const data = await r.json();
        if (!r.ok || !data.ok) return;

        const c = data.contacts || {};
        const phonePlus = (c.phone || "").trim();
        const phone = onlyDigits(phonePlus);
        const waNum = onlyDigits(c.whatsapp || c.phone || "");
        const mail = (c.email || "").trim();
        const tgHandle = (c.telegram || "").replace(/^@/, "").trim();

        if (phonePlus) {
          tel.href = `tel:${phonePlus}`;
          setDisabledAnchor(tel, false);
        }
        if (waNum) {
          wa.href = `https://wa.me/${waNum}`;
          setDisabledAnchor(wa, false);
        }
        if (tgHandle) {
          tg.href = `https://t.me/${tgHandle}`;
          setDisabledAnchor(tg, false);
        } else if (phone) {
          tg.href = `https://t.me/+${phone}`;
          setDisabledAnchor(tg, false);
        }

        // Max: –∞–Ω–∞–ª–æ–≥ WhatsApp ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤–µ–±-–∫–ª–∏–µ–Ω—Ç; –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ deep-link –ø–æ–¥–º–µ–Ω–∏–º —Ç—É—Ç
        mx.href = `https://web.max.ru/`;
        setDisabledAnchor(mx, false);

        if (mail) {
          em.href = `mailto:${encodeURIComponent(mail)}`;
          setDisabledAnchor(em, false);
        }

        if (hint) {
          const parts = [];
          if (phonePlus) parts.push(phonePlus);
          if (mail) parts.push(mail);
          hint.textContent = parts.join(" ‚Ä¢ ");
        }
      } catch {}
    }
    // –ø—Ä–∏ —Å–º–µ–Ω–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å
    qm.patient?.addEventListener("change", () =>
      fillContactBar(qm.patient.value)
    );
    // --- —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∏–∑ –º–æ–¥–∞–ª–∫–∏ ---
    qm.patientAddBtn?.addEventListener("click", () => {
      qm.patientNewRow.style.display = "block";
      qm.newFullName?.focus();
    });
    qm.patientCancelBtn?.addEventListener("click", () => {
      qm.patientNewRow.style.display = "none";
      if (qm.newFullName) qm.newFullName.value = "";
      if (qm.newPhone) qm.newPhone.value = "";
      if (qm.newBirth) qm.newBirth.value = "";
    });
    qm.patientSaveBtn?.addEventListener("click", async () => {
      const full_name = (qm.newFullName?.value || "").trim();
      const phone = (qm.newPhone?.value || "").trim();
      const birth_date = (qm.newBirth?.value || "").trim();
      if (!full_name) {
        showToast("–£–∫–∞–∂–∏ –§–ò–û –ø–∞—Ü–∏–µ–Ω—Ç–∞", "error");
        return;
      }
      try {
        const r = await fetch("/api/patients", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ full_name, phone, birth_date }),
        });
        const data = await r.json().catch(() => ({}));
        if (!r.ok || !data.ok) {
          showToast(
            data?.error || `–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è (HTTP ${r.status})`,
            "error"
          );
          return;
        }
        const opt = document.createElement("option");
        opt.value = data.id;
        opt.textContent = data.full_name || full_name;
        qm.patient?.appendChild(opt);
        qm.patient.value = data.id;
        qm.newFullName.value = "";
        qm.newPhone.value = "";
        qm.newBirth.value = "";
        qm.patientNewRow.style.display = "none";
        if (window.__DICT_CACHE__) {
          window.__DICT_CACHE__.patients.unshift({
            id: data.id,
            name: data.full_name || full_name,
          });
        }
        showToast("–ü–∞—Ü–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω", "ok");
      } catch {
        showToast("–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞", "error");
      }
    });

    function isValidSelectValue(v) {
      return v && v !== "undefined" && v !== "null";
    }
    function updateFirstFreeBtnState() {
      const enable =
        isValidSelectValue(qm.room?.value) &&
        isValidSelectValue(qm.service?.value) &&
        !!qm.start?.value;
      if (qm.btnFirstFree) {
        qm.btnFirstFree.disabled = !enable;
        qm.btnFirstFree.style.opacity = enable ? "1" : "0.6";
        qm.btnFirstFree.style.pointerEvents = enable ? "auto" : "none";
      }
    }
    [qm.room, qm.service, qm.start].forEach((el) =>
      el?.addEventListener("change", updateFirstFreeBtnState)
    );

    const qmTitle = document.querySelector("#quickModal h3");
    const qmDeleteBtn = document.getElementById("qmDelete");
    function setModalMode(mode) {
      hideNewPatientRow(); // –ø—Ä–∏ –ª—é–±–æ–º —Ä–µ–∂–∏–º–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –∏ —á–∏—Å—Ç–∏–º –º–∏–Ω–∏-—Ñ–æ—Ä–º—É
      if (!qmTitle) return;
      if (mode === "create") {
        qmTitle.textContent = "–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å";
        qmDeleteBtn?.setAttribute("disabled", "disabled");
        qmDeleteBtn?.classList.add("disabled");
      } else {
        qmTitle.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å";
        qmDeleteBtn?.removeAttribute("disabled");
        qmDeleteBtn?.classList.remove("disabled");
      }
    }
    function openModal() {
      if (qm.modal) qm.modal.style.display = "block";
    }
    function closeModal() {
      if (qm.modal) qm.modal.style.display = "none";
    }
    qm.close?.addEventListener("click", closeModal);
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });

    // –≤—Ä–µ–º—è
    function setStartEnd(ns, ne) {
      if (qm.start) qm.start.value = fmtISO(ns);
      if (qm.end) qm.end.value = fmtISO(ne);
    }
    function shiftAppointment(minutes) {
      if (!qm.start?.value) return;
      const s = new Date(qm.start.value);
      const e = qm.end?.value ? new Date(qm.end.value) : s;
      const dur = Math.max(5, Math.round((e - s) / 60000));
      const ns = addMin(s, minutes),
        ne = addMin(ns, dur);
      setStartEnd(ns, ne);
    }
    qm.btnPlus15?.addEventListener("click", () => shiftAppointment(15));
    qm.btnPlus30?.addEventListener("click", () => shiftAppointment(30));
    qm.btnPlus60?.addEventListener("click", () => shiftAppointment(60));
    qm.btnTomorrow?.addEventListener("click", () => {
      if (!qm.start?.value) return;
      const s = new Date(qm.start.value);
      const e = qm.end?.value ? new Date(qm.end.value) : s;
      const dur = Math.max(5, Math.round((e - s) / 60000));
      s.setDate(s.getDate() + 1);
      setStartEnd(s, addMin(s, dur));
    });

    // –ø–µ—Ä–≤—ã–π —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç –≤ –∫–∞–±–∏–Ω–µ—Ç–µ
    async function moveToFirstFreeInRoom() {
      const roomId = qm.room?.value,
        sid = qm.service?.value;
      if (
        !isValidSelectValue(roomId) ||
        !isValidSelectValue(sid) ||
        !qm.start?.value
      ) {
        showToast("–í—ã–±–µ—Ä–∏ –∫–∞–±–∏–Ω–µ—Ç, —É—Å–ª—É–≥—É –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞", "error");
        updateFirstFreeBtnState();
        return;
      }
      const d = await loadDictsOnce();
      const sRec = d.services.find((x) => x.id === sid);
      const dur = parseInt(sRec?.duration_min ?? 30, 10);

      let cursor = new Date(qm.start.value);
      const limit = new Date();
      limit.setDate(limit.getDate() + 7);

      while (cursor < limit) {
        const day = `${cursor.getFullYear()}-${String(
          cursor.getMonth() + 1
        ).padStart(2, "0")}-${String(cursor.getDate()).padStart(2, "0")}`;
        const resp = await fetch(
          `/api/rooms/busy?room_id=${encodeURIComponent(roomId)}&date=${day}`
        );
        if (!resp.ok) {
          showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–Ω—è—Ç–æ—Å—Ç—å –∫–∞–±–∏–Ω–µ—Ç–∞", "error");
          return;
        }
        const data = await resp.json();
        if (!data.ok) {
          showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–Ω—è—Ç–æ—Å—Ç—å –∫–∞–±–∏–Ω–µ—Ç–∞", "error");
          return;
        }

        const busy = (data.items || [])
          .map((i) => {
            const [sh, sm] = i.start.split(":").map(Number),
              [eh, em] = i.end.split(":").map(Number);
            return { s: sh * 60 + sm, e: eh * 60 + em };
          })
          .sort((a, b) => a.s - b.s);

        const st = cursor.getHours() * 60 + cursor.getMinutes(),
          en = st + dur;
        const overlap = busy.some((b) => !(en <= b.s || st >= b.e));
        if (!overlap) {
          setStartEnd(cursor, addMin(cursor, dur));
          return;
        }
        cursor = addMin(cursor, 5);
      }
      showToast("–ù–µ –Ω–∞–π–¥–µ–Ω —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç –≤ –±–ª–∏–∂–∞–π—à–∏–µ 7 –¥–Ω–µ–π", "error");
    }
    qm.btnFirstFree?.addEventListener("click", moveToFirstFreeInRoom);

    // –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å/–ø–æ–¥—Å–∫–∞–∑–∫–∞
    async function recalcEndByService() {
      if (!qm.service?.value || !qm.start?.value) return;
      const d = await loadDictsOnce();
      const srv = d.services.find((s) => s.id === qm.service.value);
      const dur = parseInt(srv?.duration_min ?? 30, 10);
      const s = new Date(qm.start.value),
        e = addMin(s, isFinite(dur) ? dur : 30);
      if (qm.end) qm.end.value = fmtISO(e);
      if (qm.serviceHint)
        qm.serviceHint.textContent = `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å–ª—É–≥–∏: ${
          isFinite(dur) ? dur : 30
        } –º–∏–Ω.`;
    }

    // –º—è–≥–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –≤—Ä–∞—á–∞
    async function checkDoctorWorking() {
      const start = qm.start?.value;
      if (!qm.doctor?.value || !start) {
        qm.warn && (qm.warn.style.display = "none");
        return;
      }
      try {
        const r = await fetch("/api/doctor_schedule", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ doctor_id: qm.doctor.value }),
        });
        if (!r.ok) {
          qm.warn && (qm.warn.style.display = "none");
          return;
        }
        const data = await r.json();
        const sched = data?.schedule || {};
        const s = new Date(start);
        const e = qm.end?.value ? new Date(qm.end.value) : new Date(start);
        const dow = (s.getDay() + 6) % 7;
        const day = sched[String(dow)];
        if (!day || !day.start || !day.end) {
          qm.warn && (qm.warn.style.display = "none");
          return;
        }
        const hm2m = (hm) => {
          const [h, m] = hm.split(":").map(Number);
          return h * 60 + m;
        };
        const st = s.getHours() * 60 + s.getMinutes(),
          en = e.getHours() * 60 + e.getMinutes();
        const outside = st < hm2m(day.start) || en > hm2m(day.end);
        if (outside) {
          qm.warn.textContent = `–í—Ä–µ–º—è –≤–Ω–µ –≥—Ä–∞—Ñ–∏–∫–∞ –≤—Ä–∞—á–∞ (${day.start}‚Äì${day.end}). –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ.`;
          qm.warn.style.display = "block";
        } else {
          qm.warn.style.display = "none";
        }
      } catch {
        qm.warn && (qm.warn.style.display = "none");
      }
    }

    // ---------- FullCalendar ----------
    // –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –ø–∞—Ü–∏–µ–Ω—Ç—É (–º–∏–Ω–∏-–ø–æ–∏—Å–∫ –Ω–∞–≤–µ—Ä—Ö—É)
    window.psSelectedPatientId = window.psSelectedPatientId || "";
    const calEl = document.getElementById("calendar");
    const calendar = new FullCalendar.Calendar(calEl, {
      initialView: "timeGridWeek",
      locale: "ru",
      buttonText: {
        today: "—Å–µ–≥–æ–¥–Ω—è",
        month: "–º–µ—Å—è—Ü",
        week: "–Ω–µ–¥–µ–ª—è",
        day: "–¥–µ–Ω—å",
      },
      allDayText: "–í–µ—Å—å –¥–µ–Ω—å",
      timeZone: "local",
      firstDay: 1,
      height: "auto",
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay",
      },
      slotDuration: "00:15:00",
      snapDuration: "00:15:00",
      slotMinTime: "09:00:00",
      slotMaxTime: "21:00:00",
      businessHours: {
        daysOfWeek: [1, 2, 3, 4, 5, 6],
        startTime: "09:00",
        endTime: "21:00",
      },

      editable: true,
      eventDurationEditable: true,
      eventStartEditable: true,
      eventOverlap: true,

      // –ó–ê–ì–†–£–ó–ö–ê –°–û–ë–´–¢–ò–ô
      events: (fetchInfo, success, failure) => {
        const params = new URLSearchParams({
          start: fetchInfo.startStr,
          end: fetchInfo.endStr,
        });

        const doctorSel = document.querySelector("#doctorFilter");
        const serviceSel = document.querySelector("#serviceFilter");
        const cabinetSel = document.querySelector("#cabinetFilter");

        if (doctorSel?.value) params.set("doctor_id", doctorSel.value);
        if (serviceSel?.value) params.set("service_id", serviceSel.value);
        if (cabinetSel?.value) params.set("room_name", cabinetSel.value);

        // ‚ú¶ –Ω–∞—à —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–∞—Ü–∏–µ–Ω—Ç—É (—É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ)
        (function () {
          const psInput = document.getElementById("psInput");
          const a = (psInput?.dataset?.selId || "").trim();
          const b = (window.__PS_SELECTED_PATIENT_ID__ || "").trim();
          const c = (window.psSelectedPatientId || "").trim();
          const pid = a || b || c;
          if (pid) params.set("patient_id", pid);
        })();

        fetch("/api/events?" + params.toString())
          .then((r) => r.json())
          .then((data) => success(data))
          .catch((err) => {
            console.error("events load error", err);
            failure(err);
          });
      },

      eventDidMount(info) {
        const status = info.event.extendedProps.status || "scheduled";
        const colors = {
          scheduled: "#0d6efd",
          arrived: "#198754",
          completed: "#6c757d",
          cancelled: "#dc3545",
          no_show: "#fd7e14",
        };
        if (colors[status]) {
          info.el.style.backgroundColor = colors[status];
          info.el.style.borderColor = colors[status];
        }

        const p = info.event.extendedProps || {};
        info.el.title = [p.service, p.patient, p.status]
          .filter(Boolean)
          .join(" ‚Ä¢ ");

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–û–ø–ª–∞—Ç–∏—Ç—å"
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –≤—Å–µ—Ö –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
        if (p.status !== "paid") {
          const payBtn = document.createElement("button");
          payBtn.innerHTML = "üí≥";
          payBtn.title = "–û–ø–ª–∞—Ç–∏—Ç—å";
          payBtn.style.cssText =
            "position:absolute;top:2px;right:2px;background:#10b981;color:white;border:none;border-radius:3px;padding:2px 4px;font-size:10px;cursor:pointer;z-index:1000;";

          payBtn.onclick = (e) => {
            e.stopPropagation();
            window.open(
              `/finance/add?appointment_id=${info.event.id}`,
              "_blank"
            );
          };

          info.el.appendChild(payBtn);
        }
      },

      eventDrop: saveMoveOrResize,
      eventResize: saveMoveOrResize,

      eventClick: async (info) => {
        await openStatusModal(info.event);
      },

      dateClick: async (arg) => {
        try {
          const d = await loadDictsOnce();
          const doctorSel = document.getElementById("doctorFilter");
          fillOptions(qm.doctor, d.doctors, doctorSel?.value || "");
          fillOptions(qm.patient, d.patients);
          fillOptions(qm.service, d.services);
          fillOptions(qm.room, d.rooms);
          await fillContactBar(qm.patient?.value || "");

          hideNewPatientRow(); // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–æ; –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–µ ¬´+ –ù–æ–≤—ã–π¬ª

          const roundTo = 15;
          const s = new Date(arg.date);
          s.setMinutes(Math.round(s.getMinutes() / roundTo) * roundTo, 0, 0);
          const e = addMin(s, 30);

          if (qm.id) qm.id.value = "";
          if (qm.start) qm.start.value = fmtISO(s);
          if (qm.end) qm.end.value = fmtISO(e);

          updateFirstFreeBtnState();
          await recalcEndByService().catch(() => {});
          await checkDoctorWorking().catch(() => {});

          setModalMode("create");
          openModal();
        } catch (e) {
          console.error(e);
          showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è", "error");
        }
      },
    });

    calendar.render();
    window._calendar = calendar;
    window.calendar = calendar;

    // === [PATCH] –§–∏–ª—å—Ç—Ä—ã —Å–≤–µ—Ä—Ö—É: –ø–æ–¥–≥—Ä—É–∑–∫–∞ —É—Å–ª—É–≥ + —Ä–µ—Ñ–µ—Ç—á ===
    (async function initTopFilters() {
      const doctorSel = document.getElementById("doctorFilter");
      const serviceSel = document.getElementById("serviceFilter");
      const cabinetSel = document.getElementById("cabinetFilter");

      try {
        const d = await loadDictsOnce();

        if (doctorSel) {
          doctorSel.innerHTML =
            '<option value="">–í—Å–µ –≤—Ä–∞—á–∏</option>' +
            (d.doctors || [])
              .map(
                (x) =>
                  `<option value="${x.id}">${x.full_name || x.name}</option>`
              )
              .join("");
        }

        if (serviceSel) {
          serviceSel.innerHTML =
            '<option value="">–í—Å–µ —É—Å–ª—É–≥–∏</option>' +
            (d.services || [])
              .map((s) => `<option value="${s.id}">${s.name}</option>`)
              .join("");
        }

        if (cabinetSel) {
          const names = Array.from(
            new Set((d.rooms || []).map((r) => r.name).filter(Boolean))
          );
          cabinetSel.innerHTML =
            '<option value="">–í—Å–µ –∫–∞–±–∏–Ω–µ—Ç—ã</option>' +
            names.map((n) => `<option value="${n}">${n}</option>`).join("");
        }
      } catch (e) {
        console.warn("dicts load failed", e);
      }

      [doctorSel, serviceSel, cabinetSel].forEach((el) => {
        el &&
          el.addEventListener("change", () =>
            window.calendar?.refetchEvents?.()
          );
      });
    })();

    // === [PATCH] –ö–Ω–æ–ø–∫–∞ "–°–±—Ä–æ—Å–∏—Ç—å" ===
    (function initResetButton() {
      const btn = document.getElementById("btnResetFilters");
      const doctorSel = document.getElementById("doctorFilter");
      const serviceSel = document.getElementById("serviceFilter");
      const cabinetSel = document.getElementById("cabinetFilter");
      const psInput = document.getElementById("psInput");

      btn &&
        btn.addEventListener("click", () => {
          if (doctorSel) doctorSel.value = "";
          if (serviceSel) serviceSel.value = "";
          if (cabinetSel) cabinetSel.value = "";

          // –°–±—Ä–æ—Å –º–∏–Ω–∏-–ø–æ–∏—Å–∫–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞ (–æ–±–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Ñ–ª–∞–≥–∞ + dataset + –≤–∏–∑—É–∞–ª—å–Ω–æ)
          if (psInput) {
            delete psInput.dataset.selId;
            psInput.value = "";
          }
          window.__PS_SELECTED_PATIENT_ID__ = "";
          window.psSelectedPatientId = "";

          window.calendar?.refetchEvents?.();
        });
    })();

    /* === HOVER –ü–û –ö–ê–ë–ò–ù–ï–¢–£: –ø–æ–∫–∞–∑–∞—Ç—å –±–ª–∏–∂–∞–π—à–∏–µ —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã (stable + –±–µ–∑ –ø—Ä–æ—à–µ–¥—à–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏) === */
    (function initRoomHoverFreeSlots() {
      const container = document.getElementById("roomsBar");
      if (!container) return;

      const tip = document.createElement("div");
      tip.id = "roomTip";
      tip.style.cssText = [
        "position:fixed",
        "z-index:9999",
        "display:none",
        "max-width:420px",
        "padding:10px 12px",
        "border-radius:10px",
        "box-shadow:0 8px 24px rgba(0,0,0,.18)",
        "background:#fff",
        "font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial",
        "pointer-events:auto",
        "cursor:pointer",
      ].join(";");
      document.body.appendChild(tip);

      let hideTimer = null,
        abortCtrl = null,
        lastRoom = "",
        lastRoomEl = null;

      function fmtYMD(d) {
        const y = d.getFullYear(),
          m = String(d.getMonth() + 1).padStart(2, "0"),
          day = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
      }
      function showTip(html, rect) {
        tip.innerHTML = html;
        tip.style.left = Math.round(rect.left) + "px";
        tip.style.top = Math.round(rect.bottom + 6 + window.scrollY) + "px";
        tip.style.display = "block";
      }
      function hideLater() {
        if (hideTimer) clearTimeout(hideTimer);
        hideTimer = setTimeout(() => {
          tip.style.display = "none";
          if (abortCtrl) abortCtrl.abort();
          abortCtrl = null;
        }, 320);
      }

      tip.addEventListener("mouseenter", () => {
        if (hideTimer) {
          clearTimeout(hideTimer);
          hideTimer = null;
        }
      });
      tip.addEventListener("mouseleave", hideLater);
      tip.addEventListener("click", (e) => {
        e.stopPropagation();
        if (!lastRoom || !lastRoomEl) return;
        document.dispatchEvent(
          new CustomEvent("open-room-today", {
            detail: { roomEl: lastRoomEl, roomName: lastRoom },
          })
        );
      });

      const $doctor = document.getElementById("doctorFilter");
      const $service = document.getElementById("serviceFilter");

      container.querySelectorAll("[data-room-name]").forEach((el) => {
        el.addEventListener("mouseenter", async () => {
          lastRoomEl = el;
          lastRoom =
            el.dataset.roomName || el.getAttribute("data-room-name") || "";
          const rect = el.getBoundingClientRect();

          if (!$doctor || !$doctor.value) {
            showTip("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞ –≤ —Ñ–∏–ª—å—Ç—Ä–µ ‚Üë", rect);
            return;
          }

          let durMin = 30;
          try {
            const dicts = await loadDictsOnce?.();
            const sId = $service?.value || "";
            const svc = (dicts?.services || []).find(
              (x) => String(x.id) === String(sId)
            );
            durMin = svc?.duration_min || 30;
          } catch {}

          const viewDate = window.calendar?.getDate
            ? window.calendar.getDate()
            : new Date();
          const day = fmtYMD(viewDate);
          const today = fmtYMD(new Date());
          const isToday = day === today;
          const nowHM = new Date().toTimeString().slice(0, 5); // "HH:MM"

          try {
            if (abortCtrl) abortCtrl.abort();
            abortCtrl = new AbortController();
            showTip("–ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤‚Ä¶", rect);

            const r = await fetch(ROUTES.freeSlots, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                doctor_id: $doctor.value,
                room_name: lastRoom,
                date: day,
                duration_min: durMin,
              }),
              signal: abortCtrl.signal,
            });
            const data = await r.json();

            const min = (
              window.calendar?.getOption?.("slotMinTime") || "09:00:00"
            ).slice(0, 5);
            const max = (
              window.calendar?.getOption?.("slotMaxTime") || "21:00:00"
            ).slice(0, 5);

            const slots = (data?.slots || [])
              .filter((t) => t >= min && t < max)
              .filter((t) => !isToday || t >= nowHM)
              .slice(0, 8);

            const title = `<div style="font-weight:600;margin-bottom:4px;">${lastRoom}</div>`;
            const body = slots.length
              ? `–°–≤–æ–±–æ–¥–Ω–æ: <b>${slots.join("</b>, <b>")}</b>`
              : "–°–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –Ω–µ—Ç";
            const hint = `<div style="margin-top:8px;opacity:.7;font-size:12px;">–ö–ª–∏–∫ ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç ¬´${lastRoom} ‚Äî —Å–µ–≥–æ–¥–Ω—è¬ª</div>`;
            showTip(`${title}<div>${body}</div>${hint}`, rect);
          } catch (e) {
            if (e.name !== "AbortError") showTip("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", rect);
          }
        });
        el.addEventListener("mouseleave", hideLater);
      });

      window.addEventListener("scroll", () => {
        if (tip.style.display === "block") tip.style.display = "none";
      });
      window.addEventListener("resize", () => {
        if (tip.style.display === "block") tip.style.display = "none";
      });
    })();

    /* === LIVE rooms bar: status + next slot === */
    (function initRoomsBarLive() {
      const bar = document.getElementById("roomsBar");
      if (!bar) return;

      function render(data) {
        bar.querySelectorAll("[data-room-name]").forEach((el) => {
          const name =
            el.dataset.roomName || el.getAttribute("data-room-name") || "";
          const nfo = data && data[name];
          if (!nfo) return;

          // —á–∏—Å—Ç–∏–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏ —Å–æ–±–∏—Ä–∞–µ–º –∑–∞–Ω–æ–≤–æ (–Ω–µ –±—É–¥–µ—Ç –¥—É–±–ª–µ–π)
          el.textContent = "";

          // –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–µ –∏–º—è –∫–∞–±–∏–Ω–µ—Ç–∞ (—É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–æ–Ω—É –∫–ª–∏–∫–∞)
          const nameSpan = document.createElement("span");
          nameSpan.className = "room-name";
          nameSpan.textContent = name;
          nameSpan.style.cursor = "pointer";
          el.appendChild(nameSpan);

          // –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å (–∑–µ–ª—ë–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
          const state = document.createElement("span");
          state.className = "room-state";
          state.textContent = " ‚Äî " + (nfo.text || "");
          state.style.marginLeft = "2px";
          state.style.fontWeight = "600";
          state.style.color = nfo.color || "#2e7d32";
          el.appendChild(state);

          // –±–ª–∏–∂–∞–π—à–∏–π —Å–ª–æ—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)
          if (
            nfo.next &&
            (nfo.next.start || nfo.next.patient || nfo.next.service)
          ) {
            const next = document.createElement("span");
            next.className = "room-next";
            const hhmm = String(nfo.next.start || "").slice(-5);
            next.textContent = ` ¬∑ –ë–ª–∏–∂–∞–π—à–∏–π: ${hhmm}${
              nfo.next.patient ? ` ‚Äî ${nfo.next.patient}` : ""
            }`;

            el.appendChild(next);
            el.title = `–°–ª–µ–¥—É—é—â–∏–π: ${hhmm} ¬∑ ${(
              nfo.next.service || ""
            ).trim()} ¬∑ ${(nfo.next.patient || "").trim()}`;
          } else {
            el.title = (nfo.text || "").trim();
          }
        });
      }

      async function tick() {
        try {
          const r = await fetch("/api/rooms/status_now");
          render(await r.json());
        } catch (e) {
          /* noop */
        }
        setTimeout(tick, 60000);
      }
      tick();
    })();

    /* === Click room -> today details popup (toggle + outside close) === */
    (function initRoomClickTodayDetails() {
      const bar = document.getElementById("roomsBar");
      if (!bar) return;

      const pop = document.createElement("div");
      pop.id = "roomDayPopup";
      pop.style.cssText =
        "position:fixed;z-index:5000;display:none;min-width:320px;max-width:420px;background:#fff;border:1px solid #dbeafd;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:10px 12px;font-size:.95rem;line-height:1.35;";
      document.body.appendChild(pop);

      let openedRoom = "";

      function hide() {
        pop.style.display = "none";
        openedRoom = "";
      }
      function showNear(el) {
        const rect = el.getBoundingClientRect();
        pop.style.left = Math.round(rect.left) + "px";
        pop.style.top = Math.round(rect.bottom + 6 + window.scrollY) + "px";
        pop.style.display = "block";
      }
      async function renderRoomToday(name) {
        try {
          const url =
            (window.ROUTES?.todayDetailsApi || "/api/rooms/today_details") +
            "?room=" +
            encodeURIComponent(name);

          const r = await fetch(url, {
            headers: { accept: "application/json" },
          });
          const ct = r.headers.get("content-type") || "";

          if (ct.includes("json")) {
            const data = await r.json();
            const now = new Date();
            const nowHHMM = (() => {
              const d = new Date();
              return `${String(d.getHours()).padStart(2, "0")}:${String(
                d.getMinutes()
              ).padStart(2, "0")}`;
            })();

            // —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ –¥–æ—Å—Ç–∞—ë–º HH:MM (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è "HH:MM", –∏ –¥–ª—è "YYYY-MM-DDTHH:MM")
            const hhmm = (s) => String(s || "").slice(-5);

            const visible = (data.items || []).filter((x) => {
              // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ (is_now) –∏ –±—É–¥—É—â–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
              return x.is_now || hhmm(x.end) >= nowHHMM;
            });

            const rows =
              visible
                .map((x) => {
                  const hh1 = hhmm(x.start);
                  const hh2 = hhmm(x.end);
                  const who = [x.service, x.patient]
                    .filter(Boolean)
                    .join(" ‚Äî ");
                  return `<div style="padding:4px 0;border-bottom:1px dashed #eef2ff;">
          <b>${hh1}‚Äì${hh2}</b>${who ? ` ¬∑ ${who}` : ""}
        </div>`;
                })
                .join("") || "<i>–ù–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç</i>";

            pop.innerHTML = `
            <div style="font-weight:600;margin-bottom:6px;">${name} ‚Äî —Å–µ–≥–æ–¥–Ω—è</div>
            ${rows}
          `;
          } else {
            // –ª–µ–≥–∞—Å–∏: —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏—Å–ª–∞–ª –≥–æ—Ç–æ–≤—ã–π HTML
            pop.innerHTML =
              (await r.text()).trim() || "<i>–ù–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç</i>";
          }
        } catch (e) {
          pop.innerHTML = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
        }
      }

      // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–ø–∞–ø–∞ –∏–∑ —Ç—É–ª—Ç–∏–ø–∞
      window.openRoomTodayFromTip = async function (roomEl, roomName) {
        // –ø–æ–≥–∞—Å–∏–º —Ç—É–ª—Ç–∏–ø, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç
        const tip = document.getElementById("roomTip");
        if (tip) tip.style.display = "none";

        // toggle: –µ—Å–ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç —ç—Ç–æ—Ç –∂–µ –∫–∞–±–∏–Ω–µ—Ç ‚Äî –∑–∞–∫—Ä—ã—Ç—å
        if (pop.style.display === "block" && openedRoom === roomName) {
          hide();
          return;
        }

        openedRoom = roomName;
        showNear(roomEl);
        pop.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
        await renderRoomToday(roomName);
      };

      // –û–¢–ö–†–´–¢–ò–ï/–ó–ê–ö–†–´–¢–ò–ï: –∫–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ –∫–∞–±–∏–Ω–µ—Ç–∞ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)

      document.addEventListener("click", async (e) => {
        const el = e.target.closest("#roomsBar [data-room-name]");
        if (!el) return;

        // —É–±–∏—Ä–∞–µ–º hover-tooltip
        const tip = document.getElementById("roomTip");
        if (tip) tip.style.display = "none";

        const name =
          el.dataset.roomName || el.getAttribute("data-room-name") || "";

        // –µ—Å–ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç —ç—Ç–æ—Ç –∂–µ –∫–∞–±–∏–Ω–µ—Ç ‚Äî —Å—á–∏—Ç–∞–µ–º –∫–∞–∫ toggle –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º
        if (pop.style.display === "block" && openedRoom === name) {
          hide();
          return;
        }

        openedRoom = name;
        showNear(el);
        pop.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
        await renderRoomToday(name);
      });

      // —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ —è–∫–æ—Ä—è –ø–æ –∏–º–µ–Ω–∏ –∫–∞–±–∏–Ω–µ—Ç–∞
      function findRoomAnchor(name) {
        if (!name) return null;
        const esc = CSS && CSS.escape ? CSS.escape(name) : name;
        return (
          document.querySelector(`[data-room="${esc}"]`) ||
          document.querySelector(`[data-open-room="${esc}"]`) ||
          document.querySelector(`[data-room-name="${esc}"]`) ||
          [...document.querySelectorAll(".ps-room, .ps-rooms-item")].find(
            (el) => (el.textContent.split("‚Äî")[0] || "").trim() === name
          ) ||
          null
        );
      }

      // –û–¢–ö–†–´–¢–ò–ï –ø–æ ¬´—Å–∏–≥–Ω–∞–ª—É¬ª –∏–∑ —Ç—É–ª—Ç–∏–ø–∞ / –∏–∑ –ª—é–±–æ–≥–æ –º–µ—Å—Ç–∞
      document.addEventListener("open-room-today", async (e) => {
        let { roomEl, roomName } = (e && e.detail) || {};
        if (!roomName) return;
        roomEl = roomEl || findRoomAnchor(roomName); // <-- –í–ê–ñ–ù–û
        if (!roomEl) return;
        const tip = document.getElementById("roomTip");
        if (tip) tip.style.display = "none";
        if (pop.style.display === "block" && openedRoom === roomName) {
          hide();
          return;
        }
        openedRoom = roomName;
        showNear(roomEl);
        pop.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
        await renderRoomToday(roomName);
      });

      // –∫–ª–∏–∫ –≤–Ω–µ –ø–æ–ø–∞–ø–∞ ‚Äî –ù–ï –∑–∞–∫—Ä—ã–≤–∞—Ç—å, –µ—Å–ª–∏ –∫–ª–∏–∫ –ø–æ —Ç—É–ª—Ç–∏–ø—É
      document.addEventListener("click", (e) => {
        if (pop.style.display !== "block") return;
        if (pop.contains(e.target)) return;
        if (e.target.closest("#roomsBar")) return;
        if (e.target.closest("#roomTip")) return; // <-- –í–ê–ñ–ù–û
        hide();
      });

      // Esc / scroll / resize ‚Äî –∑–∞–∫—Ä—ã—Ç—å
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") hide();
      });
      window.addEventListener("scroll", hide);
      window.addEventListener("resize", hide);
    })();

    async function saveMoveOrResize(info) {
      const payload = {
        id: info.event.id,
        start: info.event.startStr,
        end: info.event.endStr || info.event.startStr,
      };
      try {
        const r = await fetch("/api/appointments/update_time", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await r.json();
        if (!data.ok) {
          alert(
            data.error === "room_conflict"
              ? "–ö–æ–Ω—Ñ–ª–∏–∫—Ç: –∫–∞–±–∏–Ω–µ—Ç –∑–∞–Ω—è—Ç"
              : "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"
          );
          info.revert();
          return;
        }
        calendar.refetchEvents();
      } catch {
        alert("–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞");
        info.revert();
      }
    }

    // –æ—Ç–∫—Ä—ã—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é
    async function openQuickModal(id) {
      try {
        const d = await loadDictsOnce();
        fillOptions(qm.doctor, d.doctors);
        fillOptions(qm.patient, d.patients);
        fillOptions(qm.service, d.services);
        fillOptions(qm.room, d.rooms);

        hideNewPatientRow(); // –≤—Å–µ–≥–¥–∞ —Å–∫—Ä—ã–≤–∞–µ–º ¬´–ù–æ–≤—ã–π –ø–∞—Ü–∏–µ–Ω—Ç¬ª –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

        const r = await fetch(`/api/appointments/${id}`);
        const data = await r.json();
        if (!data.ok) {
          showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∑–∞–ø–∏—Å—å", "error");
          return;
        }
        const it = data.item;

        if (qm.id) qm.id.value = it.id || "";
        if (qm.doctor) qm.doctor.value = it.doctor_id || "";
        if (qm.patient) qm.patient.value = it.patient_id || "";
        await fillContactBar(qm.patient?.value || "");
        if (qm.service) qm.service.value = it.service_id || "";
        if (qm.room) qm.room.value = it.room_id || "";
        if (qm.start) qm.start.value = (it.start || "").slice(0, 16);
        if (qm.end) qm.end.value = (it.end || "").slice(0, 16);
        if (qm.status) qm.status.value = it.status_key || "scheduled";
        if (qm.comment) qm.comment.value = it.comment || "";

        qm.service?.addEventListener(
          "change",
          () => {
            recalcEndByService();
            checkDoctorWorking();
          },
          { once: true }
        );
        qm.start?.addEventListener(
          "change",
          () => {
            recalcEndByService();
            checkDoctorWorking();
          },
          { once: true }
        );
        qm.end?.addEventListener("change", checkDoctorWorking, { once: true });
        qm.doctor?.addEventListener("change", checkDoctorWorking, {
          once: true,
        });

        await recalcEndByService();
        await checkDoctorWorking();
        setModalMode("edit");
        openModal();
      } catch (e) {
        console.error(e);
        showToast("–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏", "error");
      }
    }

    // submit / delete
    qm.form?.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      // [MP] –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ (–µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω –±–ª–æ–∫ "–ù–æ–≤—ã–π")
      async function mpEnsurePatientSelected() {
        let patientId = (qm.patient?.value || "").trim();
        const full_name = (qm.newFullName?.value || "").trim();
        const phone = (qm.newPhone?.value || "").trim();
        const birth_date = (qm.newBirth?.value || "").trim();

        // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á—Ç–æ-—Ç–æ –≤–≤—ë–ª –≤ "–ù–æ–≤—ã–π –ø–∞—Ü–∏–µ–Ω—Ç"
        if (full_name) {
          const needCreate =
            !patientId ||
            confirm(
              `–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ¬´${full_name}¬ª –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤–º–µ—Å—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ?`
            );
          if (needCreate) {
            try {
              const r = await fetch("/api/patients", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ full_name, phone, birth_date }),
              });
              const data = await r.json().catch(() => ({}));
              if (!r.ok || !(data.ok ?? true) || !data.id) {
                showToast(
                  data?.error || `–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞ (HTTP ${r.status})`,
                  "error"
                );
                return null; // –æ—Ç–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
              }
              // –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å–µ–ª–µ–∫—Ç –∏ –≤—ã–±—Ä–∞—Ç—å
              const opt = document.createElement("option");
              opt.value = data.id;
              opt.textContent = data.full_name || full_name;
              qm.patient?.appendChild(opt);
              qm.patient.value = data.id;
              patientId = data.id;

              // –æ–±–Ω–æ–≤–∏—Ç—å –∫—ç—à, –æ—á–∏—Å—Ç–∏—Ç—å –∏ —Å–∫—Ä—ã—Ç—å –±–ª–æ–∫ "–ù–æ–≤—ã–π"
              if (window.__DICT_CACHE__) {
                window.__DICT_CACHE__.patients?.unshift({
                  id: data.id,
                  name: data.full_name || full_name,
                });
              }
              if (qm.patientNewRow) qm.patientNewRow.style.display = "none";
              if (qm.newFullName) qm.newFullName.value = "";
              if (qm.newPhone) qm.newPhone.value = "";
              if (qm.newBirth) qm.newBirth.value = "";
              showToast("–ü–∞—Ü–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω", "ok");
            } catch {
              showToast("–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞)", "error");
              return null; // –æ—Ç–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            }
          }
        }
        return patientId;
      }

      const ensuredPatientId = await mpEnsurePatientSelected();
      if (!ensuredPatientId) return; // –æ—à–∏–±–∫–∞/–æ—Ç–º–µ–Ω–∞ ‚Äî –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

      const base = {
        doctor_id: qm.doctor?.value || "",
        patient_id: ensuredPatientId,
        service_id: qm.service?.value || "",
        room_id: qm.room?.value || "",
        start: qm.start?.value || "",
        end: qm.end?.value || "",
        status_key: qm.status?.value || "scheduled",
        comment: qm.comment?.value || "",
      };

      // CREATE
      if (!qm.id?.value) {
        if (
          !base.doctor_id ||
          !base.patient_id ||
          !base.service_id ||
          !base.room_id
        ) {
          showToast("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è: –≤—Ä–∞—á, –ø–∞—Ü–∏–µ–Ω—Ç, —É—Å–ª—É–≥–∞, –∫–∞–±–∏–Ω–µ—Ç", "error");
          return;
        }
        const payload = {
          start: base.start,
          end: base.end,
          room_id: base.room_id,
          doctor_id: base.doctor_id,
          patient_id: base.patient_id,
          service_id: base.service_id,
          note: base.comment || "",
        };
        let ok = false,
          lastErr = "";
        const endpoints = [
          "/api/appointments",
          "/api/appointments/create",
          "/schedule/api/create",
        ];
        for (const url of endpoints) {
          try {
            const r = await fetch(url, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            const data = await r.json().catch(() => ({}));
            if (
              r.status === 409 ||
              data?.error === "conflict" ||
              data?.error === "room_conflict"
            ) {
              showToast("–ö–æ–Ω—Ñ–ª–∏–∫—Ç: –∫–∞–±–∏–Ω–µ—Ç/–≤—Ä–∞—á –∑–∞–Ω—è—Ç", "error");
              return;
            }
            if (r.ok && (data?.ok ?? true)) {
              ok = true;
              break;
            }
            lastErr = data?.error || `HTTP ${r.status}`;
          } catch {
            lastErr = "network";
          }
        }
        if (!ok) {
          showToast(
            `–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è${lastErr ? ` (${lastErr})` : ""}`,
            "error"
          );
          return;
        }
        showToast("–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞", "ok");
      }
      // UPDATE
      else {
        const r = await fetch(`/api/appointments/${qm.id.value}/update`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(base),
        });
        const data = await r.json();
        if (!r.ok || !data.ok) {
          const err =
            data?.error === "room_conflict"
              ? "–ö–æ–Ω—Ñ–ª–∏–∫—Ç: –∫–∞–±–∏–Ω–µ—Ç –∑–∞–Ω—è—Ç"
              : "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è";
          showToast(err, "error");
          return;
        }
        showToast("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã", "ok");
      }

      closeModal();
      calendar.refetchEvents();
    });

    // —É–¥–∞–ª–µ–Ω–∏–µ
    qm.btnDel?.addEventListener("click", async () => {
      const id = qm.id?.value;
      if (!id) {
        showToast("–≠—Ç–∞ –∑–∞–ø–∏—Å—å –µ—â—ë –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞", "error");
        return;
      }
      if (!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?")) return;
      const candidates = [
        { url: "/schedule/api/delete", body: { id } },
        { url: "/api/appointments/delete", body: { id } },
        {
          url: `/api/appointments/${encodeURIComponent(id)}`,
          method: "DELETE",
          body: {},
        },
      ];
      let ok = false;
      for (const c of candidates) {
        try {
          const r = await fetch(c.url, {
            method: c.method || "POST",
            headers: { "Content-Type": "application/json" },
            body: Object.keys(c.body || {}).length
              ? JSON.stringify(c.body)
              : undefined,
          });
          const data = await r.json().catch(() => ({}));
          if (r.ok && (data.ok ?? true)) {
            ok = true;
            break;
          }
        } catch {}
      }
      if (!ok) {
        showToast("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å", "error");
        return;
      }
      closeModal();
      calendar.refetchEvents();
      showToast("–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞", "ok");
    });
  }); // DOMContentLoaded
</script>

<script>
  // === MINI SEARCH (patients) ‚Äî –µ–¥–∏–Ω—ã–π —Ä–∞–±–æ—á–∏–π –≤–∞—Ä–∏–∞–Ω—Ç =========================
  (function () {
    const psInput = document.getElementById("psInput");
    const psDrop = document.getElementById("psDrop");
    if (!psInput || !psDrop) return;

    // –ì–ª–æ–±–∞–ª–∫–∞, –∫–æ—Ç–æ—Ä—É—é —á–∏—Ç–∞–µ—Ç –ª–æ–∞–¥–µ—Ä —Å–æ–±—ã—Ç–∏–π
    window.__PS_SELECTED_PATIENT_ID__ = window.__PS_SELECTED_PATIENT_ID__ || "";

    psDrop.style.zIndex = "4000";
    psDrop.style.pointerEvents = "auto";

    function debounce(fn, ms = 220) {
      let t;
      return (...a) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...a), ms);
      };
    }
    function hideDrop() {
      psDrop.style.display = "none";
      psDrop.innerHTML = "";
    }
    function showDrop() {
      psDrop.style.display = "block";
    }

    function renderDrop(items) {
      if (!items?.length) {
        hideDrop();
        return;
      }
      psDrop.innerHTML = items
        .map(
          (i) => `
      <div class="ps-item" data-id="${i.id}" data-name="${i.name}"
           style="padding:8px 10px; cursor:pointer; border-top:1px solid #f0f2f5;">
        <div style="display:flex; justify-content:space-between; gap:8px;">
          <span class="ps-name">${i.name}</span>
          <small style="opacity:.6">${i.birthdate || ""}${
            i.card_no ? " ¬∑ #" + i.card_no : ""
          }</small>
        </div>
      </div>`
        )
        .join("");
      showDrop();
    }

    function applyPatientFilter(id, name) {
      const selId = (id || "").trim();
      const selName = (name || "").trim();

      // 1) dataset —É –∏–Ω–ø—É—Ç–∞
      psInput.dataset.selId = selId;

      // 2) –æ–±–µ –≥–ª–æ–±–∞–ª–∫–∏ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –ª—é–±—ã–º–∏ —á–∏—Ç–∞—Ç–µ–ª—è–º–∏)
      window.__PS_SELECTED_PATIENT_ID__ = selId;
      window.psSelectedPatientId = selId;

      // 3) –≤–∏–¥–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è
      psInput.value = selName;

      hideDrop();

      // 4) —Ä–µ—Ñ–µ—Ç—á —Å–æ–±—ã—Ç–∏–π
      if (window.calendar?.refetchEvents) window.calendar.refetchEvents();
      else setTimeout(() => window.calendar?.refetchEvents?.(), 0);

      // 5) ¬´–ø—Ä–∏–∫–ª–µ–π–∫–∞¬ª –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ—Å–ª–µ –≤–æ–∑–º–æ–∂–Ω–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
      setTimeout(() => {
        psInput.value = selName;
      }, 0);
    }

    const search = debounce(async () => {
      const q = (psInput.value || "").trim();
      if (q.length < 2) {
        hideDrop();
        return;
      }
      try {
        // –∫–æ—Ä–æ—Ç–∫–∏–π –ø–æ–∏—Å–∫ (–±—ç–∫–µ–Ω–¥ —É–∂–µ –µ—Å—Ç—å)
        const r = await fetch(
          `/api/patients/min?q=${encodeURIComponent(q)}&limit=8`,
          { cache: "no-store" }
        );

        const data = await r.json().catch(() => ({}));
        if (!r.ok || !data?.ok) {
          hideDrop();
          return;
        }
        renderDrop(data.items || []);
      } catch {
        hideDrop();
      }
    }, 220);

    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
    psInput.addEventListener("input", search);
    psInput.addEventListener("focus", search);

    // –í—ã–±–æ—Ä –î–û blur: –Ω–∞ mousedown
    psDrop.addEventListener("mousedown", (e) => {
      const item = e.target.closest(".ps-item");
      if (!item) return;
      // –í–ê–ñ–ù–û: –æ—Ç–∫–ª—é—á–∞–µ–º bubbling –∏ blur –¥–æ –∫–æ–Ω—Ü–∞ —Ü–∏–∫–ª–∞
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();

      applyPatientFilter(
        item.dataset.id,
        item.dataset.name || item.querySelector(".ps-name")?.textContent || ""
      );
    });

    // Enter ‚Äî –≤—ã–±—Ä–∞—Ç—å –ø–µ—Ä–≤—ã–π
    psInput.addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      const first = psDrop.querySelector(".ps-item");
      if (!first) return;
      e.preventDefault();
      first.dispatchEvent(
        new MouseEvent("mousedown", { bubbles: true, cancelable: true })
      );
    });

    // –ö–ª–∏–∫ –≤–Ω–µ ‚Äî –∑–∞–∫—Ä—ã—Ç—å
    document.addEventListener("click", (e) => {
      if (e.target === psInput) return;
      if (psDrop.contains(e.target)) return;
      hideDrop();
    });

    // ¬´–°–±—Ä–æ—Å–∏—Ç—å¬ª ‚Äî –æ—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –∏ —Ä–µ—Ñ–µ—Ç—á
    document
      .getElementById("btnResetFilters")
      ?.addEventListener("click", () => {
        delete psInput.dataset.selId;
        window.__PS_SELECTED_PATIENT_ID__ = "";
        window.psSelectedPatientId = ""; // ‚Üê –¥–æ–±–∞–≤–∏–ª–∏ –æ—á–∏—Å—Ç–∫—É 2-–π –≥–ª–æ–±–∞–ª–∫–∏
        psInput.value = "";
        hideDrop();
        window.calendar?.refetchEvents?.();
      });
  })();
</script>

<!-- MP-CONTACTS: JS -->
<script>
    async function mpOpenContact(type, patientId) {
      function normPhone(s) {
        const d = (s || "").replace(/\D+/g, "");
        if (!d) return "";
        // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫ —Ñ–æ—Ä–º–∞—Ç—É 7xxxxxxxxxx
        if (d.startsWith("8") && d.length === 11) return "7" + d.slice(1);
        if (d.startsWith("7") && d.length === 11) return d;
        if (d.length === 10) return "7" + d; // –±–µ–∑ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã
        return d;
      }
      function buildLink(t, contacts, linksFromServer) {
        // –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏—Å–ª–∞–ª –≥–æ—Ç–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
        if (linksFromServer && linksFromServer[t]) return linksFromServer[t];

        const phone = normPhone(contacts?.phone || contacts?.whatsapp || "");
        const tg = (contacts?.telegram || "").replace(/^@/, "");
        const mail = (contacts?.email || "").trim();
        const max = (contacts?.max || "").trim();

        switch (t) {
          case "tel":
            return phone ? `tel:+${phone}` : null;
          case "wa":
            return phone ? `https://wa.me/${phone}` : null;
          case "tg":
            // –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∏–∫ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ –Ω–∏–∫—É, –∏–Ω–∞—á–µ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
            return tg
              ? `https://t.me/${encodeURIComponent(tg)}`
              : phone
              ? `https://t.me/+${phone}`
              : null;
          case "mail":
            return mail ? `mailto:${mail}` : null;
          case "max":
            // –ú–∞–∫—Å ¬´–∫–∞–∫ WhatsApp¬ª: –ø—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å web.max.ru —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º,
            // –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é
            if (phone) return `https://web.max.ru/?phone=${phone}`;
            return `https://web.max.ru/`;
          default:
            return null;
        }
      }

      try {
        if (!patientId) {
          const sel = document.getElementById("patient"); // <select id="patient"> –≤ –º–æ–¥–∞–ª–∫–µ
          if (sel) patientId = sel.value;
        }
        if (!patientId) {
          alert("–ù–µ –≤—ã–±—Ä–∞–Ω –ø–∞—Ü–∏–µ–Ω—Ç");
          return;
        }

        const res = await fetch(
          `/api/patients/${encodeURIComponent(patientId)}/contacts`,
          { cache: "no-store" }
        );
        if (!res.ok) {
          alert("–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã");
          return;
        }

        const j = await res.json().catch(() => ({}));
        if (!j.ok) {
          alert("–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
          return;
        }

        const url = buildLink(type, j.contacts || {}, j.links || null);
        if (!url) {
          alert("–ù–µ—Ç —Å—Å—ã–ª–∫–∏ –¥–ª—è: " + type);
          return;
        }

        window.open(url, "_blank", "noopener");
      } catch (e) {
        console.error(e);
        alert("–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞");
      }
    }

    try {
      window._calendar &&
        typeof window._calendar.render === "function" &&
        window._calendar.render();
    } catch (e) {}


  let currentAppointmentId = null;
  let currentEvent = null; // –•—Ä–∞–Ω–∏–º –ø–æ–ª–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ

  async function openStatusModal(event) {
    currentAppointmentId = event.id;
    currentEvent = event; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
    const extendedProps = event.extendedProps || {};
    const status = extendedProps.status || 'scheduled';

    const info = document.getElementById('statusInfo');
    const buttons = document.getElementById('statusButtons');

    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–ø–∏—Å–∏
    info.innerHTML = `
      <p><strong>–ü–∞—Ü–∏–µ–Ω—Ç:</strong> ${extendedProps.patient_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
      <p><strong>–í—Ä–∞—á:</strong> ${extendedProps.doctor_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
      <p><strong>–£—Å–ª—É–≥–∞:</strong> ${extendedProps.service_name || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
      <p><strong>–í—Ä–µ–º—è:</strong> ${event.start.toLocaleString('ru-RU')}</p>
      <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="badge bg-${getStatusColor(status)}">${getStatusText(status)}</span></p>
    `;

    // –ö–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
    if (status === 'scheduled') {
      buttons.innerHTML = `
        <button class="btn btn-success w-100 mb-2" onclick="arriveAppointment()">
          <i class="fa fa-check"></i> –ü–∞—Ü–∏–µ–Ω—Ç –ø—Ä–∏—à—ë–ª
        </button>
        <button class="btn btn-warning w-100 mb-2" onclick="noShowAppointment()">
          <i class="fa fa-times"></i> –ù–µ —è–≤–∏–ª—Å—è
        </button>
        <button class="btn btn-secondary w-100" onclick="editAppointment()">
          <i class="fa fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </button>
      `;
    } else if (status === 'arrived') {
      buttons.innerHTML = `
        <button class="btn btn-primary w-100 mb-2" onclick="showCompleteModal()">
          <i class="fa fa-check-circle"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–∏—ë–º
        </button>
        <button class="btn btn-danger w-100" onclick="cancelAppointment()">
          <i class="fa fa-ban"></i> –û—Ç–º–µ–Ω–∏—Ç—å
        </button>
      `;
    } else if (status === 'completed') {
      buttons.innerHTML = `
        <button class="btn btn-info w-100 mb-2" onclick="viewDetails()">
          <i class="fa fa-info-circle"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
        </button>
        <button class="btn btn-success w-100" onclick="repeatAppointment()">
          <i class="fa fa-redo"></i> –ó–∞–ø–∏—Å–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
        </button>
      `;
    } else {
      buttons.innerHTML = `<p class="text-muted">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π</p>`;
    }

    new bootstrap.Modal(document.getElementById('statusModal')).show();
  }

  function getStatusColor(status) {
    const colors = {
      'scheduled': 'primary',
      'arrived': 'success',
      'completed': 'secondary',
      'cancelled': 'danger',
      'no_show': 'warning'
    };
    return colors[status] || 'secondary';
  }

  function getStatusText(status) {
    const texts = {
      'scheduled': '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ',
      'arrived': '–ü–∞—Ü–∏–µ–Ω—Ç –ø—Ä–∏—à—ë–ª',
      'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
      'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–æ',
      'no_show': '–ù–µ —è–≤–∏–ª—Å—è'
    };
    return texts[status] || status;
  }

  async function arriveAppointment() {
    const res = await fetch(`/appointments/${currentAppointmentId}/arrive`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'}
    });
    const data = await res.json();

    if (data.success) {
      bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();
      calendar.refetchEvents();
      showToast('–ü–∞—Ü–∏–µ–Ω—Ç –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –ø—Ä–∏—à–µ–¥—à–∏–π', 'success');
    }
  }

  async function noShowAppointment() {
    if (!confirm('–û—Ç–º–µ—Ç–∏—Ç—å —á—Ç–æ –ø–∞—Ü–∏–µ–Ω—Ç –Ω–µ —è–≤–∏–ª—Å—è?')) return;

    const res = await fetch(`/appointments/${currentAppointmentId}/no-show`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'}
    });
    const data = await res.json();

    if (data.success) {
      bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();
      calendar.refetchEvents();
      showToast('–û—Ç–º–µ—á–µ–Ω–æ: –ø–∞—Ü–∏–µ–Ω—Ç –Ω–µ —è–≤–∏–ª—Å—è', 'warning');
    }
  }

  function showCompleteModal() {
    bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();
    const modal = new bootstrap.Modal(document.getElementById('completeModal'));
    modal.show();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∞
    const followupCheckbox = document.getElementById('needsFollowup');
    const followupFields = document.getElementById('followupFields');

    if (followupCheckbox && followupFields) {
      // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –µ—Å–ª–∏ –±—ã–ª
      followupCheckbox.replaceWith(followupCheckbox.cloneNode(true));
      const newCheckbox = document.getElementById('needsFollowup');

      newCheckbox.addEventListener('change', function() {
        followupFields.style.display = this.checked ? 'block' : 'none';
      });
    }
  }

  async function completeAppointment() {
    const comment = document.getElementById('visitComment').value;
    if (!comment.trim()) {
      alert('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω!');
      return;
    }

    const data = {
      visit_comment: comment,
      visit_number: parseInt(document.getElementById('visitNumber').value),
      total_visits: parseInt(document.getElementById('totalVisits').value),
      needs_repeat: document.getElementById('needsFollowup').checked
    };

    const res = await fetch(`/appointments/${currentAppointmentId}/complete`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    const result = await res.json();

    if (result.success) {
      const resultDiv = document.getElementById('completeResult');
      resultDiv.innerHTML = `
        <div class="alert alert-success">
          <strong>–ü—Ä–∏—ë–º –∑–∞–≤–µ—Ä—à—ë–Ω!</strong><br>
          –°–æ–∑–¥–∞–Ω –¥–æ–ª–≥: ${result.debt_created}‚ÇΩ<br>
          –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –¥–µ–ø–æ–∑–∏—Ç–∞: ${result.deposit_used}‚ÇΩ
        </div>
      `;

      setTimeout(() => {
        bootstrap.Modal.getInstance(document.getElementById('completeModal')).hide();
        calendar.refetchEvents();
      }, 2000);
    }
  }

  function editAppointment() {
    bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é openQuickModal
    if (typeof openQuickModal === 'function') {
      openQuickModal(currentAppointmentId);
    } else {
      alert('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
    }
  }

  function viewDetails() {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ–±—ã—Ç–∏—è
    if (currentEvent && currentEvent.extendedProps && currentEvent.extendedProps.patient_id) {
      window.location.href = `/patients/${currentEvent.extendedProps.patient_id}`;
    } else {
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–∞—Ü–∏–µ–Ω—Ç–∞');
    }
  }

  function repeatAppointment() {
    if (!currentEvent || !currentEvent.extendedProps) {
      alert('–î–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
      return;
    }

    const props = currentEvent.extendedProps;

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();

    // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ —Å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    if (typeof openQuickModal === 'function') {
      // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë
      setTimeout(() => {
        openQuickModal(null, {
          patient_id: props.patient_id,
          patient_name: props.patient_name,
          doctor_id: props.doctor_id,
          doctor_name: props.doctor_name,
          service_id: props.service_id,
          service_name: props.service_name,
          room_id: props.room_id
        });
      }, 300);
    } else {
      alert('–§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
    }
  }

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
        bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();

        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ —Å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é openQuickModal
        // –∏–ª–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

        const params = new URLSearchParams({
          patient_id: appt.patient_id,
          doctor_id: appt.doctor_id,
          service_id: appt.service_id,
          room_id: appt.room_id || '',
          repeat: true
        });

        // –í–∞—Ä–∏–∞–Ω—Ç 1: –û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
        window.open(`/calendar?${params.toString()}`, '_blank');

        // –í–∞—Ä–∏–∞–Ω—Ç 2: –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è openQuickModal, –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –µ—ë
        // openQuickModal(null, appt);
      }
    } catch (e) {
      console.error(e);
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
    }
  }

  function showToast(message, type) {
    // –ü—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ toast)
    alert(message);
  }
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å—å—é -->
<div class="modal fade" id="statusModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—å—é</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div id="statusInfo"></div>
        <div id="statusButtons" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–∏—ë–º–∞ -->
<div class="modal fade" id="completeModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–∏—ë–º</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label"
            >–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –≤–∏–∑–∏—Ç—É <span class="text-danger">*</span></label
          >
          <textarea
            id="visitComment"
            class="form-control"
            rows="3"
            required
          ></textarea>
        </div>
        <!-- –ë–ª–æ–∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–ø–∏—Å–∏ -->
        <div class="mb-3">
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="needsFollowup"
            />
            <label class="form-check-label" for="needsFollowup">
              ‚úÖ –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤–∏–∑–∏—Ç
            </label>
          </div>
        </div>

        <!-- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –ø–ª–∞–Ω–∞ –≤–∏–∑–∏—Ç–æ–≤ -->
        <div id="followupFields" style="display: none">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">–ù–æ–º–µ—Ä –≤–∏–∑–∏—Ç–∞:</label>
              <input
                type="number"
                class="form-control"
                id="visitNumber"
                min="1"
                value="1"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">–í—Å–µ–≥–æ –≤–∏–∑–∏—Ç–æ–≤:</label>
              <input
                type="number"
                class="form-control"
                id="totalVisits"
                min="1"
                value="1"
              />
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          –û—Ç–º–µ–Ω–∞
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="completeAppointment()"
        >
          –ó–∞–≤–µ—Ä—à–∏—Ç—å
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
