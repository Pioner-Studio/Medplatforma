{% extends "base.html" %}
{% block content %}
<h2 style="margin:8px 0 14px;">Добавить запись</h2>

<form method="post" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;max-width:900px;">
  <!-- Врач -->
  <label>
    <div>Врач</div>
    <select name="doctor_id" required style="width:100%;padding:8px;border:1px solid #dbeafd;border-radius:8px;">
      <option value="">— выберите —</option>
      {% for d in doctors %}
        <option value="{{ d._id }}">{{ d.full_name }}</option>
      {% endfor %}
    </select>
  </label>

  <!-- Пациент -->
  <label>
    <div>Пациент</div>
    <select name="patient_id" required style="width:100%;padding:8px;border:1px solid #dbeafd;border-radius:8px;">
      <option value="">— выберите —</option>
      {% for p in patients %}
        <option value="{{ p._id }}">{{ p.full_name }}</option>
      {% endfor %}
    </select>
  </label>

  <!-- Услуга -->
  <label>
    <div>Услуга</div>
    <select id="service_id" name="service_id" required style="width:100%;padding:8px;border:1px solid #dbeafd;border-radius:8px;">
      <option value="">— выберите —</option>
      {% for s in services %}
        <option value="{{ s._id }}" data-dur="{{ s.duration_min or 30 }}">{{ s.name }}</option>
      {% endfor %}
    </select>
    <small id="service_hint" style="opacity:.7;"></small>
  </label>

  <!-- Кабинет -->
  <label>
    <div>Кабинет</div>
    <select id="room_id" name="room_id" required style="width:100%;padding:8px;border:1px solid #dbeafd;border-radius:8px;">
      <option value="">— выберите —</option>
      {% for r in rooms %}
        <option value="{{ r._id }}">{{ r.name }}</option>
      {% endfor %}
    </select>
    <small id="busy_hint" style="opacity:.75;"></small>
  </label>

  <!-- Начало -->
  <label>
    <div>Начало</div>
    <input id="start" type="datetime-local" name="start" required step="300"
           style="width:100%;padding:8px;border:1px solid #dbeafd;border-radius:8px;">
  </label>

  <!-- Конец (ставим автоматом, можно поправить) -->
  <label>
    <div>Конец</div>
    <input id="end" type="datetime-local" name="end" step="300"
           style="width:100%;padding:8px;border:1px solid #dbeafd;border-radius:8px;">
    <small style="opacity:.7;">Если не укажете, подставится длительность услуги.</small>
  </label>

  <!-- Статус -->
  <label>
    <div>Статус</div>
    <select name="status_key" style="width:100%;padding:8px;border:1px solid #dbeafd;border-radius:8px;">
      <option value="scheduled">Запланирован</option>
      <option value="arrived">Прибыл</option>
      <option value="done">Завершён</option>
      <option value="cancelled">Отменён</option>
    </select>
  </label>

  <!-- Комментарий -->
  <label style="grid-column:1/-1;">
    <div>Комментарий</div>
    <textarea name="comment" rows="3" style="width:100%;padding:8px;border:1px solid #dbeafd;border-radius:8px;"></textarea>
  </label>

  <div style="grid-column:1/-1;display:flex;gap:12px;">
    <button type="submit" class="btn-main" style="background:#1976d2;color:#fff;border-radius:8px;padding:10px 18px;">Создать</button>
    <a href="{{ url_for('calendar_view') }}" class="btn" style="padding:10px 14px;border:1px solid #dbeafd;border-radius:8px;">Отмена</a>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const serviceSel = document.getElementById('service_id');
  const startInp   = document.getElementById('start');
  const endInp     = document.getElementById('end');
  const hint       = document.getElementById('service_hint');
  const roomSel    = document.getElementById('room_id');
  const busyHint   = document.getElementById('busy_hint');

  function isoLocal(dt){
    // YYYY-MM-DDTHH:MM
    const pad = n => String(n).padStart(2,'0');
    return dt.getFullYear()+"-"+pad(dt.getMonth()+1)+"-"+pad(dt.getDate())+"T"+pad(dt.getHours())+":"+pad(dt.getMinutes());
  }

  function addMinutes(dt, m){ return new Date(dt.getTime() + m*60000); }

  function recalcEnd(){
    const sId = serviceSel.value;
    const sVal = startInp.value;
    if (!sId || !sVal) return;
    const durAttr = serviceSel.selectedOptions[0]?.getAttribute('data-dur');
    const dur = parseInt(durAttr || '30', 10);
    const start = new Date(sVal);
    const end = addMinutes(start, dur);
    endInp.value = isoLocal(end);
    hint.textContent = `Длительность: ${dur} мин. Конец: ${endInp.value.split('T')[1]}`;
  }

  serviceSel?.addEventListener('change', recalcEnd);
  startInp?.addEventListener('change', recalcEnd);

  // Подсказка занятых интервалов по кабинету и дате
  function refreshBusy(){
    const roomId = roomSel.value;
    const sVal = startInp.value;
    if (!roomId || !sVal) { busyHint.textContent = ''; return; }
    const date = sVal.split('T')[0];
    fetch(`/api/rooms/busy?room_id=${encodeURIComponent(roomId)}&date=${date}`)
      .then(r => r.json())
      .then(data => {
        if (!data.ok) { busyHint.textContent = 'Не удалось загрузить занятость'; return; }
        if (!data.items.length) { busyHint.textContent = 'Свободно весь день'; return; }
        const txt = data.items.map(i => `${i.start}–${i.end}`).join(', ');
        busyHint.textContent = `Занято: ${txt}`;
      })
      .catch(()=> busyHint.textContent = 'Ошибка сети');
  }

  roomSel?.addEventListener('change', refreshBusy);
  startInp?.addEventListener('change', refreshBusy);

})();
</script>
{% endblock %}
