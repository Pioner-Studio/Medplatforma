{% extends "base.html" %} {% block content %}
<h2 style="margin: 8px 0 14px">Добавить запись</h2>

<form
  method="post"
  style="
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    max-width: 900px;
  "
>
  <!-- Врач -->
  <label>
    <div>Врач</div>
    <select
      name="doctor_id"
      required
      style="
        width: 100%;
        padding: 8px;
        border: 1px solid #dbeafd;
        border-radius: 8px;
      "
    >
      <option value="">— выберите —</option>
      {% for d in doctors %}
      <option value="{{ d._id }}">{{ d.full_name }}</option>
      {% endfor %}
    </select>
  </label>

  <!-- Пациент -->
  <label>
    <div>Пациент</div>
    <select
      name="patient_id"
      id="patient_id"
      required
      style="
        width: 100%;
        padding: 8px;
        border: 1px solid #dbeafd;
        border-radius: 8px;
      "
    >
      <option value="">— выберите —</option>
      {% for p in patients %}
      <option value="{{ p._id }}">{{ p.full_name }}</option>
      {% endfor %}
    </select>
  </label>

<!-- Кнопка быстрого создания пациента -->
<div class="mt-2">
  <a href="/add_patient?return_to=add_event" class="btn btn-sm btn-success w-100">
    <i class="bi bi-person-plus-fill"></i> ➕ Создать нового пациента
  </a>
  <small class="text-muted d-block mt-1">
    После создания вы вернётесь к этой форме
  </small>
</div>

  <!-- Услуга -->
  <label>
    <div>Услуга</div>
    <select
      id="service_id"
      name="service_id"
      required
      style="
        width: 100%;
        padding: 8px;
        border: 1px solid #dbeafd;
        border-radius: 8px;
      "
    >
      <option value="">— выберите —</option>
      {% for s in services %}
      <option value="{{ s._id }}" data-dur="{{ s.duration_min or 30 }}">
        {{ s.name }}
      </option>
      {% endfor %}
    </select>
    <small id="service_hint" style="opacity: 0.7"></small>
  </label>

  <!-- Кабинет -->
  <label>
    <div>Кабинет</div>
    <select
      id="room_id"
      name="room_id"
      required
      style="
        width: 100%;
        padding: 8px;
        border: 1px solid #dbeafd;
        border-radius: 8px;
      "
    >
      <option value="">— выберите —</option>
      {% for r in rooms %}
      <option value="{{ r._id }}">{{ r.name }}</option>
      {% endfor %}
    </select>
    <small id="busy_hint" style="opacity: 0.75"></small>
  </label>

  <!-- Начало -->
  <label>
    <div>Начало</div>
    <input
      id="start"
      type="datetime-local"
      name="start"
      required
      step="900"
      style="
        width: 100%;
        padding: 8px;
        border: 1px solid #dbeafd;
        border-radius: 8px;
      "
    />
    <div
      style="
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 3px;
        margin-top: 4px;
      "
    >
      <button
        type="button"
        onclick="setQuickTime('start', '09:00')"
        class="hour-btn"
      >
        09:00
      </button>
      <button
        type="button"
        onclick="setQuickTime('start', '10:00')"
        class="hour-btn"
      >
        10:00
      </button>
      <button
        type="button"
        onclick="setQuickTime('start', '11:00')"
        class="hour-btn"
      >
        11:00
      </button>
      <button
        type="button"
        onclick="setQuickTime('start', '12:00')"
        class="hour-btn"
      >
        12:00
      </button>
      <button
        type="button"
        onclick="setQuickTime('start', '13:00')"
        class="hour-btn"
      >
        13:00
      </button>
      <button
        type="button"
        onclick="setQuickTime('start', '14:00')"
        class="hour-btn"
      >
        14:00
      </button>
      <button
        type="button"
        onclick="setQuickTime('start', '15:00')"
        class="hour-btn"
      >
        15:00
      </button>
      <button
        type="button"
        onclick="setQuickTime('start', '16:00')"
        class="hour-btn"
      >
        16:00
      </button>
      <button
        type="button"
        onclick="setQuickTime('start', '17:00')"
        class="hour-btn"
      >
        17:00
      </button>
      <button
        type="button"
        onclick="setQuickTime('start', '18:00')"
        class="hour-btn"
      >
        18:00
      </button>
      <button
        type="button"
        onclick="setQuickTime('start', '19:00')"
        class="hour-btn"
      >
        19:00
      </button>
      <button
        type="button"
        onclick="setQuickTime('start', '20:00')"
        class="hour-btn"
      >
        20:00
      </button>
      <button
        type="button"
        onclick="setQuickTime('start', '21:00')"
        class="hour-btn"
      >
        21:00
      </button>
    </div>
  </label>

  <!-- Конец -->
  <label>
    <div>Конец</div>
    <input
      id="end"
      type="datetime-local"
      name="end"
      step="900"
      style="
        width: 100%;
        padding: 8px;
        border: 1px solid #dbeafd;
        border-radius: 8px;
      "
    />
    <small style="opacity: 0.7"
      >Если не укажете, подставится длительность услуги.</small
    >
  </label>

  <!-- Комментарий -->
  <label style="grid-column: 1/-1">
    <div>Комментарий</div>
    <textarea
      name="comment"
      rows="3"
      style="
        width: 100%;
        padding: 8px;
        border: 1px solid #dbeafd;
        border-radius: 8px;
      "
    ></textarea>
  </label>

  <!-- Кнопки -->
  <div style="grid-column: 1/-1; display: flex; gap: 12px; margin-top: 16px">
    <button
      type="submit"
      style="
        background: #1976d2;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 10px 18px;
        cursor: pointer;
      "
    >
      Создать
    </button>
    <a
      href="{{ url_for('calendar_view') }}"
      style="
        padding: 10px 14px;
        border: 1px solid #dbeafd;
        border-radius: 8px;
        text-decoration: none;
        color: #333;
      "
    >
      Отмена
    </a>
  </div>
</form>

{% endblock %} {% block scripts %}
<script>
  (function () {
    const serviceSel = document.getElementById("service_id");
    const startInp = document.getElementById("start");
    const endInp = document.getElementById("end");
    const hint = document.getElementById("service_hint");
    const roomSel = document.getElementById("room_id");
    const busyHint = document.getElementById("busy_hint");

    function isoLocal(dt) {
      const pad = (n) => String(n).padStart(2, "0");
      return (
        dt.getFullYear() +
        "-" +
        pad(dt.getMonth() + 1) +
        "-" +
        pad(dt.getDate()) +
        "T" +
        pad(dt.getHours()) +
        ":" +
        pad(dt.getMinutes())
      );
    }

    function addMinutes(dt, m) {
      return new Date(dt.getTime() + m * 60000);
    }

    function recalcEnd() {
      const sId = serviceSel.value;
      const sVal = startInp.value;
      if (!sId || !sVal) return;
      const durAttr = serviceSel.selectedOptions[0]?.getAttribute("data-dur");
      const dur = parseInt(durAttr || "30", 10);
      const start = new Date(sVal);
      const end = addMinutes(start, dur);
      endInp.value = isoLocal(end);
      hint.textContent = `Длительность: ${dur} мин. Конец: ${
        endInp.value.split("T")[1]
      }`;
    }

    serviceSel?.addEventListener("change", recalcEnd);
    startInp?.addEventListener("change", recalcEnd);

    function refreshBusy() {
      const roomId = roomSel.value;
      const sVal = startInp.value;
      if (!roomId || !sVal) {
        busyHint.textContent = "";
        return;
      }
      const date = sVal.split("T")[0];
      fetch(
        `/api/rooms/busy?room_id=${encodeURIComponent(roomId)}&date=${date}`
      )
        .then((r) => r.json())
        .then((data) => {
          if (!data.ok) {
            busyHint.textContent = "Не удалось загрузить занятость";
            return;
          }
          if (!data.items.length) {
            busyHint.textContent = "Свободно весь день";
            return;
          }
          const txt = data.items.map((i) => `${i.start}–${i.end}`).join(", ");
          busyHint.textContent = `Занято: ${txt}`;
        })
        .catch(() => (busyHint.textContent = "Ошибка сети"));
    }

    roomSel?.addEventListener("change", refreshBusy);
    startInp?.addEventListener("change", refreshBusy);

    window.setQuickTime = function (fieldId, time) {
      const field = document.getElementById(fieldId);
      const today = new Date();
      const dateStr =
        today.getFullYear() +
        "-" +
        String(today.getMonth() + 1).padStart(2, "0") +
        "-" +
        String(today.getDate()).padStart(2, "0");
      field.value = dateStr + "T" + time;

      if (fieldId === "start") {
        recalcEnd();
        refreshBusy();
      }
    };
  })();

// Автовыбор пациента если пришли с ?patient_id=...
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const patientId = urlParams.get('patient_id');

  if (patientId) {
    const patientSelect = document.getElementById('patient_id');
    if (patientSelect) {
      // Выбираем пациента в списке
      patientSelect.value = patientId;

      // Показываем уведомление
      const alert = document.createElement('div');
      alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
      alert.style.zIndex = '9999';
      alert.innerHTML = `
        <strong>✅ Пациент создан!</strong> Теперь можете создать для него запись.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(alert);

      // Скроллим к началу
      window.scrollTo({top: 0, behavior: 'smooth'});

      // Автоудаление через 5 секунд
      setTimeout(() => alert.remove(), 5000);
    }
  }
});

</script>
{% endblock %}
