{% extends 'base.html' %}
{% block title %}Карточка пациента{% endblock %}
{% block content %}
<div style="max-width:720px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 6px 32px rgba(20,40,80,.08);padding:36px;">
    <h2 style="font-size:1.3rem;font-weight:700;margin-bottom:12px;">Карточка пациента: <span style="color:#445be2;">{{ patient.full_name }}</span></h2>
    <div style="margin-bottom:18px;">
        <b>Долг:</b> <span style="color:{{ 'red' if debt > 0 else '#25c045' }};">{{ debt|round(2) }} ₽</span>
        &nbsp; | &nbsp; <b>Депозит:</b> <span style="color:#2590c0;">{{ deposit|round(2) }} ₽</span>
        &nbsp; | &nbsp; <b>Партнёр:</b> {{ partner }}
    </div>
    <hr style="margin:18px 0;">

    <h3>Внести оплату</h3>
    <form method="POST" style="margin-bottom:18px;">
        <input name="amount" type="number" step="0.01" placeholder="Сумма" required style="width:110px;padding:8px;margin-right:12px;">
        <input name="comment" placeholder="Комментарий (например: оплата/зачёт депозита/частичная оплата)" style="padding:8px;width:240px;margin-right:12px;">
        <button type="submit" style="background:#25c045;color:#fff;border:none;border-radius:8px;padding:9px 19px;font-weight:700;cursor:pointer;">Добавить</button>
    </form>

    <h3>История платежей</h3>
    {% if payments and payments|length > 0 %}
    <ul style="margin-bottom:18px;">
        {% for pay in payments %}
        <li>{{ pay.datetime }} — <b>{{ pay.amount|round(2) }} ₽</b> {% if pay.comment %}({{ pay.comment }}){% endif %}</li>
        {% endfor %}
    </ul>
    {% else %}
    <p>Нет платежей</p>
    {% endif %}

    <hr style="margin:18px 0;">
    <h3>История посещений</h3>
    {% if history and history|length > 0 %}
    <ul>
        {% for h in history %}
        <li>
            {{ h.datetime }} — {{ h.done }}<br>
            {% if h.services %}
                <ul>
                {% for s in h.services %}
                    <li>{{ s.name }} ({{ s.qty }} x {{ s.price }} ₽ = {{ s.total }} ₽)</li>
                {% endfor %}
                </ul>
                <b>Сумма: {{ h.total_sum }} ₽</b>
            {% endif %}
            {% if h.plan %}<br><i>План: {{ h.plan }}</i>{% endif %}
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p>Нет посещений</p>
    {% endif %}
</div>
{% endblock %}
