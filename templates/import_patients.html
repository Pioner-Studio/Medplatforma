<h2>Импорт пациентов</h2>

<a href="{{ url_for('import_template_patients') }}" class="btn" style="margin-bottom:15px;display:inline-block;">
  Скачать шаблон CSV для импорта пациентов
</a>

<form method="post" enctype="multipart/form-data" style="margin-top:10px;">
    <label for="file">Выберите CSV-файл:</label>
    <input type="file" name="file" id="file" required>
    <button type="submit">Импортировать</button>
</form>

{% if preview_data %}
  <h3>Предпросмотр данных</h3>
  <form method="post" action="{{ url_for('import_patients_confirm') }}">
    <input type="hidden" name="csv_data" value="{{ request.files['file'].stream.read().decode('utf-8-sig') | tojson }}">
    <table border="1" cellpadding="3">
      <tr>
        <th>ФИО</th>
        <th>Дата рождения</th>
        <th>Телефон</th>
        <th>Email</th>
        <th>Долг</th>
        <th>Депозит</th>
        <th>Ошибки</th>
      </tr>
      {% for item in preview_data %}
        <tr {% if item.errors %} style="background:#ffb3b3"{% endif %}>
          <td>{{ item.row.full_name }}</td>
          <td>{{ item.row.dob }}</td>
          <td>{{ item.row.phone }}</td>
          <td>{{ item.row.email }}</td>
          <td>{{ item.row.debt }}</td>
          <td>{{ item.row.deposit }}</td>
          <td>
            {% if item.errors %}
              <span style="color:red">{{ item.errors|join(', ') }}</span>
            {% else %}
              -
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </table>
    {% if show_confirm %}
      <button type="submit">Подтвердить импорт</button>
    {% endif %}
  </form>
{% endif %}

{% if message %}
  <div class="alert">{{ message }}</div>
{% endif %}

<p>
  <b>Внимание:</b> Используйте шаблон, чтобы не было ошибок. <br>
  Допустимые поля: <br>
  <code>full_name, dob, phone, passport, email, referral, debt, deposit, partner_points</code>
</p>
