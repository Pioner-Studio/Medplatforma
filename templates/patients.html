{% extends "base.html" %}
{% block content %}
<div class="page-header">
  <h2>–ü–∞—Ü–∏–µ–Ω—Ç—ã</h2>
  <div style="display:flex;gap:10px;align-items:center;">
    <form method="get" action="{{ url_for('patients_list') }}" style="display:flex;gap:5px;">
      <input type="text" name="q" value="{{ search or '' }}" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û, —Ç–µ–ª–µ—Ñ–æ–Ω—É, email">
      <button type="submit">–ü–æ–∏—Å–∫</button>
    </form>
    <a href="{{ url_for('add_patient') }}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞</a>
  </div>
</div>

{% if items %}
  <table class="table" style="margin-top:15px;">
    <thead>
      <tr>
        <th>–ê–≤–∞—Ç–∞—Ä</th>
        <th>–§–ò–û</th>
        <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
        <th>–ê–¥—Ä–µ—Å</th>
        <th>–í–∏–∑–∏—Ç–æ–≤</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody>
      {% for p in items %}
        {% set contacts = p.get('contacts', {}) %}
        {% set phone = contacts.get('phone', '') %}
        {% set email = contacts.get('email', '') %}
        {% set wa = contacts.get('whatsapp', '') %}
        {% set tg = contacts.get('telegram', '') %}
        {% set addr = p.get('address', {}) %}
        {% set city = addr.get('city', '') %}
        {% set street = addr.get('street', '') %}
        {% set zipc = addr.get('zip', '') %}
        {% set avatar = p.get('avatar', '/static/avatars/patients/default.jpg') %}

        <tr>
          <td>
            <img src="{{ avatar }}" alt="avatar" style="width:40px;height:40px;border-radius:50%;">
          </td>
          <td>{{ p.get('full_name', '‚Äî') }}</td>
          <td>
            <div>üìû {{ phone or '‚Äî' }}</div>
            <div>‚úâÔ∏è {{ email or '‚Äî' }}</div>
            <div>üü¢ WA: {{ wa or '‚Äî' }}</div>
            <div>üí¨ TG: {{ tg or '‚Äî' }}</div>
          </td>
          <td>
            {{ city }}{% if city and street %}, {% endif %}{{ street }}{% if zipc %}, {{ zipc }}{% endif %}
          </td>
          <td>{{ appts_count.get(p['_id'], 0) }}</td>
          <td>
            <a href="{{ url_for('patient_card', id=p['_id']) }}">–ö–∞—Ä—Ç–æ—á–∫–∞</a> |
            <a href="{{ url_for('edit_patient', id=p['_id']) }}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a> |
            <form method="post" action="{{ url_for('delete_patient', id=p['_id']) }}" style="display:inline;">
              <button type="submit" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞?')">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>–ü–∞—Ü–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
{% endif %}
{% endblock %}
