{% extends "base.html" %} {% block title %}{{ patient.full_name }} - –ö–∞—Ä—Ç–æ—á–∫–∞
–ø–∞—Ü–∏–µ–Ω—Ç–∞{% endblock %} {% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-8">
    <!-- –¢–ê–ë–´ (–í–ö–õ–ê–î–ö–ò) -->
    <ul class="nav nav-tabs mb-3" id="patientTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="info-tab" data-bs-toggle="tab"
                    data-bs-target="#info" type="button" role="tab">
            <i class="fas fa-user"></i> –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="current-visit-tab" data-bs-toggle="tab"
                    data-bs-target="#current-visit" type="button" role="tab">
            <i class="fas fa-stethoscope"></i> –¢–µ–∫—É—â–∏–π –ø—Ä–∏—ë–º
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-bs-toggle="tab"
                    data-bs-target="#history" type="button" role="tab">
            <i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π
            </button>
        </li>
    </ul>

<div class="tab-content" id="patientTabsContent">

      <!-- –í–∫–ª–∞–¥–∫–∞: –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
      <div class="tab-pane fade show active" id="info" role="tabpanel">
      <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
      <div class="card mb-4">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0">{{ patient.full_name }}</h5>
          <div>
            <button
              class="btn btn-sm btn-outline-primary"
              onclick="editPatient()"
            >
              <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <button
              class="btn btn-sm btn-outline-success"
              onclick="createAppointment()"
            >
              <i class="fas fa-calendar-plus"></i> –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å
            </button>

            <!-- –ö–Ω–æ–ø–∫–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –∞–Ω–∫–µ—Ç—ã -->
            {% if patient.get('questionnaire_filled', False) %}
            <a
              href="{{ url_for('patient_questionnaire', patient_id=patient._id) }}"
              class="btn btn-sm btn-success"
            >
              <i class="fas fa-file-medical-alt"></i> –ê–Ω–∫–µ—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞
            </a>
            {% else %}
            <a
              href="{{ url_for('patient_questionnaire', patient_id=patient._id) }}"
              class="btn btn-sm btn-warning"
            >
              <i class="fas fa-exclamation-triangle"></i> –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É
            </a>
            {% endif %}
          </div>
        </div>

        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ patient.phone or '‚Äî' }}</p>
              <p><strong>Email:</strong> {{ patient.email or '‚Äî' }}</p>
              <div class="mb-3">
                <div class="form-check">
                  <input
                    type="checkbox"
                    class="form-check-input"
                    id="use_preferential"
                    {%
                    if
                    patient.use_preferential_pricing
                    %}checked{%
                    endif
                    %}
                    onchange="updatePreferentialPricing('{{ patient._id }}')"
                  />
                  <label class="form-check-label" for="use_preferential">
                    üéÅ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—å–≥–æ—Ç–Ω—ã–π –ø—Ä–∞–π—Å
                  </label>
                </div>
                <small class="text-muted">–î–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤/–¥—Ä—É–∑–µ–π –∫–ª–∏–Ω–∏–∫–∏</small>
              </div>
              <p>
                <strong>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> {{ patient.birthdate or '‚Äî' }}
              </p>
            </div>
            <div class="col-md-6">
              <p><strong>–ö–∞—Ä—Ç–∞ ‚Ññ:</strong> {{ patient.card_no or '‚Äî' }}</p>
              <p>
                <strong>–°–æ–∑–¥–∞–Ω:</strong> {{
                patient.created_at.strftime('%d.%m.%Y') if patient.created_at
                else '‚Äî' }}
              </p>
            </div>
          </div>

          {% if patient.notes %}
          <div class="mt-3">
            <strong>–ó–∞–º–µ—Ç–∫–∏:</strong>
            <p class="text-muted">{{ patient.notes }}</p>
          </div>
          {% endif %}
        </div>
      </div>
      </div>
      <!-- –ö–æ–Ω–µ—Ü –≤–∫–ª–∞–¥–∫–∏: –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->

      <!-- –í–∫–ª–∞–¥–∫–∞: –¢–µ–∫—É—â–∏–π –ø—Ä–∏—ë–º -->
      <div class="tab-pane fade" id="current-visit" role="tabpanel">
          <div class="card">
              <div class="card-header">
                  <h5 class="mb-0">
                      <i class="fas fa-stethoscope"></i> –¢–µ–∫—É—â–∏–π –ø—Ä–∏—ë–º
                      {% if current_appointment %}
                        - {{ current_appointment.start.strftime('%d.%m.%Y %H:%M') if current_appointment.start else '' }}
                      {% endif %}
                  </h5>
              </div>
              <div class="card-body">

                  {# –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ä–æ–ª—å: —Å–Ω–∞—á–∞–ª–∞ user_role –∏–∑ view, –∑–∞—Ç–µ–º session['role'], –∑–∞—Ç–µ–º session['user']['role'] #}
                  {% set role = (user_role | default(session.get('role') or session.get('user', {}).get('role') or '', true) | trim | lower) %}

                  {% if role not in ['doctor', 'chief_doctor'] %}
                      <div class="alert alert-warning">
                          <i class="fas fa-lock"></i>
                          –¢–æ–ª—å–∫–æ –≤—Ä–∞—á–∏ –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç–µ–∫—É—â–∏–º –ø—Ä–∏—ë–º–æ–º
                      </div>
                  {% else %}

                      {% if not current_appointment %}
                          <div class="alert alert-info">
                              <i class="fas fa-info-circle"></i>
                              –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
                          </div>
                      {% else %}

                          <form id="current-visit-form" method="POST" action="/patients/{{ patient._id }}/current-visit/complete">
                              <!-- –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —É—Å–ª—É–≥–∞ -->
                              {% if current_appointment.service_id %}
                              <h6 class="mb-3">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ:</h6>
                              <div class="form-check mb-3 p-3 border rounded">
                                  <input class="form-check-input" type="checkbox"
                                        name="service_ids[]"
                                        value="{{ current_appointment.service_id }}"
                                        id="svc-planned"
                                        checked>
                                  <label class="form-check-label w-100" for="svc-planned">
                                      <strong>{{ current_appointment.service_name }}</strong>
                                      {% if role in ['admin', 'chief_doctor'] %}
                                          <span class="badge bg-success float-end">
                                              {{ "{:,}".format(current_appointment.service_price|int).replace(',', ' ') }} ‚ÇΩ
                                          </span>
                                      {% endif %}
                                      <div class="mt-2">
                                          <input type="text" class="form-control form-control-sm"
                                                name="comment_{{ current_appointment.service_id }}"
                                                placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                                      </div>
                                  </label>
                              </div>
                              {% else %}
                              <p class="text-muted">–£—Å–ª—É–≥–∞ –Ω–µ –±—ã–ª–∞ –≤—ã–±—Ä–∞–Ω–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏</p>
                              {% endif %}

                              <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥ -->
                              <button type="button" class="btn btn-outline-primary btn-sm mb-3"
                                      data-bs-toggle="modal" data-bs-target="#addServiceModal">
                                  <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É –∏–∑ –ø—Ä–∞–π—Å–∞
                              </button>

                              <!-- –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏ -->
                              <div id="added-services-container"></div>

                              <hr class="my-4">

                              <!-- –ò—Ç–æ–≥–æ -->
                              {% if role in ['admin', 'chief_doctor'] %}
                              <div class="d-flex justify-content-between align-items-center mb-3">
                                  <h5 class="mb-0">–ò—Ç–æ–≥–æ –∑–∞ —Å–µ–≥–æ–¥–Ω—è:</h5>
                                  <h5 class="mb-0 text-success" id="total-amount">0 ‚ÇΩ</h5>
                              </div>
                              {% endif %}

                              <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è -->
                              <button type="submit" class="btn btn-success btn-lg w-100">
                                  <i class="fas fa-check"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏
                              </button>
                          </form>

                      {% endif %}

                  {% endif %}

              </div>
          </div>
      </div>
      <!-- –ö–æ–Ω–µ—Ü –≤–∫–ª–∞–¥–∫–∏: –¢–µ–∫—É—â–∏–π –ø—Ä–∏—ë–º -->

      <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∏ -->
      <div class="modal fade" id="addServiceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <input type="text" class="form-control mb-3" id="service-search"
                    placeholder="–ü–æ–∏—Å–∫ —É—Å–ª—É–≥–∏...">
              <div id="services-list" style="max-height: 400px; overflow-y: auto;">
                {% for svc in all_services %}
                  <div class="service-item border-bottom p-2 hover-bg" style="cursor: pointer;"
                      data-service-id="{{ svc._id }}"
                      data-service-name="{{ svc.name }}"
                      data-service-price="{{ svc.price }}">
                    <strong>{{ svc.name }}</strong>
                    {% if role in ['admin', 'chief_doctor'] %}
                      <span class="badge bg-info float-end">
                        {{ "{:,}".format(svc.price|int).replace(',', ' ') }} ‚ÇΩ
                      </span>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞: –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π -->
      <div class="tab-pane fade" id="history" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π</h6>
          </div>
          <div class="card-body">
            {% if appointments %}
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>–î–∞—Ç–∞</th>
                    <th>–í—Ä–µ–º—è</th>
                    <th>–í—Ä–∞—á</th>
                    <th>–£—Å–ª—É–≥–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                  </tr>
                </thead>
                <tbody>
                  {% for appt in appointments %}
                  <tr>
                    <td>
                      {{ appt.start.strftime('%d.%m.%Y') if appt.start else '‚Äî' }}
                    </td>
                    <td>
                      {{ appt.start.strftime('%H:%M') if appt.start else '‚Äî' }}
                    </td>
                    <td>{{ appt.doctor_name or '‚Äî' }}</td>
                    <td>{{ appt.service_name or '‚Äî' }}</td>
                    <td>
                      <span
                        class="badge bg-{{ 'success' if appt.status_key == 'paid' else 'primary' if appt.status_key == 'confirmed' else 'secondary' }}"
                      >
                        {{ appt.status_title or appt.status_key or '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞' }}
                      </span>
                    </td>
                    <td>{{ appt.cost or '‚Äî' }}‚ÇΩ</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <p class="text-muted">–ó–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
            {% endif %}
          </div>
        </div>
      </div>
      <!-- –ö–æ–Ω–µ—Ü –≤–∫–ª–∞–¥–∫–∏: –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π -->

    <div class="col-md-4">
      <!-- –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
      <div class="card mb-4">
        <div class="card-header">
          <h6 class="mb-0">–§–∏–Ω–∞–Ω—Å—ã</h6>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6">
              <div class="border-end">
                <h4 class="text-success mb-0">
                  {{ finance.total_paid or 0 }}‚ÇΩ
                </h4>
                <small class="text-muted">–û–ø–ª–∞—á–µ–Ω–æ</small>
              </div>
            </div>
            <div class="col-6">
              <h4 class="text-danger mb-0">{{ finance.total_debt or 0 }}‚ÇΩ</h4>
              <small class="text-muted">–î–æ–ª–≥</small>
            </div>
          </div>

          {% if finance.total_debt > 0 %}
          <div class="mt-3">
            <button
              class="btn btn-success btn-sm w-100"
              onclick="processPayment()"
            >
              <i class="fas fa-credit-card"></i> –û–ø–ª–∞—Ç–∏—Ç—å –¥–æ–ª–≥
            </button>
          </div>
          {% endif %}
        </div>
      </div>

      <div class="card mb-4">
        <div
          class="card-header"
          style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
          "
        >
          <h6 class="mb-0">üéÅ –ë–æ–Ω—É—Å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h6>
        </div>
        <div class="card-body">
          <!-- –ë–∞–ª–∞–Ω—Å –±–æ–Ω—É—Å–æ–≤ -->
          <div class="text-center mb-3">
            <div style="font-size: 14px; color: #6c757d; margin-bottom: 8px">
              –î–æ—Å—Ç—É–ø–Ω–æ –±–æ–Ω—É—Å–æ–≤
            </div>
            <h2 class="mb-0" style="color: #667eea; font-weight: 700">
              {{ patient.bonus_balance|default(0) }} ‚ÇΩ
            </h2>
          </div>

          <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
          <div class="d-grid gap-2 mb-3">
            <button class="btn btn-sm btn-outline-success" onclick="addBonus()">
              <i class="fas fa-plus-circle"></i> –ù–∞—á–∏—Å–ª–∏—Ç—å –±–æ–Ω—É—Å—ã
            </button>
            <button
              class="btn btn-sm btn-outline-warning"
              onclick="withdrawBonus()"
            >
              <i class="fas fa-minus-circle"></i> –°–ø–∏—Å–∞—Ç—å –±–æ–Ω—É—Å—ã
            </button>
            <button
              class="btn btn-sm btn-outline-info"
              onclick="transferBonus()"
            >
              <i class="fas fa-exchange-alt"></i> –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥—Ä—É–≥–æ–º—É
            </button>
          </div>

          <!-- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
          <div style="padding-top: 12px; border-top: 1px solid #e9ecef">
            {% if patient.referred_by_patient_id or patient.referred_by_name %}
            <p class="mb-2" style="font-size: 13px">
              <strong>–ö—Ç–æ –ø—Ä–∏–≤—ë–ª:</strong>
              {% if patient.referred_by_patient_id %}
              <a href="/patients/{{ patient.referred_by_patient_id }}"
                >{{ patient.referred_by_name or '–ü–∞—Ü–∏–µ–Ω—Ç' }}</a
              >
              {% else %} {{ patient.referred_by_name }} {% endif %}
            </p>
            {% endif %} {% if referred_patients_count > 0 %}
            <p class="mb-0" style="font-size: 13px">
              <strong>–ü—Ä–∏–≤—ë–ª –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤:</strong> {{ referred_patients_count }}
              <a
                href="#"
                onclick="showReferredPatients(); return false;"
                style="margin-left: 8px"
                >(–ø–æ–∫–∞–∑–∞—Ç—å)</a
              >
            </p>
            {% endif %}
          </div>

          <!-- –ò—Å—Ç–æ—Ä–∏—è –±–æ–Ω—É—Å–æ–≤ (—Å–≤–µ—Ä–Ω—É—Ç–∞—è) -->
          <div style="margin-top: 12px">
            <a
              href="#"
              onclick="toggleBonusHistory(); return false;"
              class="text-decoration-none"
              style="font-size: 13px"
            >
              <i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –±–æ–Ω—É—Å–æ–≤
            </a>
            <div
              id="bonusHistory"
              style="
                display: none;
                margin-top: 12px;
                max-height: 200px;
                overflow-y: auto;
              "
            >
              <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∏—Å—Ç–æ—Ä–∏—è —á–µ—Ä–µ–∑ JS -->
              <div class="text-center">
                <div class="spinner-border spinner-border-sm"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button
              class="btn btn-outline-primary btn-sm"
              onclick="callPatient()"
            >
              <i class="fas fa-phone"></i> –ü–æ–∑–≤–æ–Ω–∏—Ç—å
            </button>
            <button class="btn btn-outline-info btn-sm" onclick="sendMessage()">
              <i class="fas fa-sms"></i> SMS
            </button>
            <button
              class="btn btn-outline-success btn-sm"
              onclick="sendWhatsApp()"
            >
              <i class="fab fa-whatsapp"></i> WhatsApp
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // helpers ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
  const $id = (s) => document.getElementById(s);
  const on  = (id, type, fn, opts) => { const el = $id(id); if (el) el.addEventListener(type, fn, opts||false); };
  const setOnClick = (id, fn) => { const el = $id(id); if (el) el.onclick = fn; }; // –æ—Å—Ç–∞–≤–∏–ª –∏ onclick-–≤–µ—Ä—Å–∏—é –Ω–∞ –≤—Å—è–∫–∏–π
</script>


<script>
        function editPatient() {
            window.location.href = '/patients/{{ patient._id }}/edit';
        }

        function createAppointment() {
            window.location.href = '/calendar?patient_id={{ patient._id }}';
        }

        function processPayment() {
            window.location.href = '/finance/add?patient_id={{ patient._id }}&type=income';
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–∞–º–∏
        function addBonus() {
            const amount = prompt('–°—É–º–º–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤:');
            if (!amount || isNaN(amount)) return;

            const comment = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):') || '–†—É—á–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ';

            fetch('/api/patients/{{ patient._id }}/bonus/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({amount: parseInt(amount), comment: comment})
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    alert('–ë–æ–Ω—É—Å—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã!');
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            });
        }

        function withdrawBonus() {
            const currentBalance = {{ patient.bonus_balance|default(0) }};
            const amount = prompt('–°—É–º–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è –±–æ–Ω—É—Å–æ–≤ (–¥–æ—Å—Ç—É–ø–Ω–æ: ' + currentBalance + '‚ÇΩ):');
            if (!amount || isNaN(amount)) return;

            if (parseInt(amount) > currentBalance) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–Ω—É—Å–æ–≤!');
                return;
            }

            const comment = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):') || '–†—É—á–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ';

            fetch('/api/patients/{{ patient._id }}/bonus/withdraw', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({amount: parseInt(amount), comment: comment})
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    alert('–ë–æ–Ω—É—Å—ã —Å–ø–∏—Å–∞–Ω—ã!');
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            });
        }

        function transferBonus() {
            alert('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }

        function toggleBonusHistory() {
            const el = document.getElementById('bonusHistory');
            if (el.style.display === 'none') {
                el.style.display = 'block';
                loadBonusHistory();
            } else {
                el.style.display = 'none';
            }
        }

        function loadBonusHistory() {
            fetch('/api/patients/{{ patient._id }}/bonus/history')
                .then(r => r.json())
                .then(data => {
                    const el = document.getElementById('bonusHistory');
                    if (data.items && data.items.length > 0) {
                        el.innerHTML = data.items.map(function(h) {
                            return '<div style="padding: 8px; border-bottom: 1px solid #f1f3f5; font-size: 13px;">' +
                                '<div style="display: flex; justify-content: space-between;">' +
                                    '<span>' + h.date + '</span>' +
                                    '<span style="color: ' + (h.amount > 0 ? '#28a745' : '#dc3545') + '; font-weight: 600;">' +
                                        (h.amount > 0 ? '+' : '') + h.amount + '‚ÇΩ' +
                                    '</span>' +
                                '</div>' +
                                '<div style="color: #6c757d; font-size: 12px;">' + h.comment + '</div>' +
                            '</div>';
                        }).join('');
                    } else {
                        el.innerHTML = '<p class="text-muted text-center">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>';
                    }
                });
        }

        function showReferredPatients() {
            alert('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }

        function callPatient() {
            {% if patient.phone %}
            window.location.href = 'tel:{{ patient.phone }}';
            {% else %}
            alert('–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω');
            {% endif %}
        }

        function sendMessage() {
            {% if patient.phone %}
            window.location.href = 'sms:{{ patient.phone }}';
            {% else %}
            alert('–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω');
            {% endif %}
        }

        function sendWhatsApp() {
            {% if patient.phone %}
            const phone = '{{ patient.phone }}'.replace(/\D/g, '');
            window.open('https://wa.me/' + phone, '_blank');
            {% else %}
            alert('–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω');
            {% endif %}
        }

        function updatePreferentialPricing(patientId) {
            const checked = document.getElementById('use_preferential').checked;

            fetch('/api/patients/' + patientId + '/update_info', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({use_preferential_pricing: checked})
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    const msg = checked ? '–õ—å–≥–æ—Ç–Ω—ã–π –ø—Ä–∞–π—Å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∞–π—Å';
                    alert(msg);
                }
            });
        }

        // ========== –¢–ï–ö–£–©–ò–ô –ü–†–ò–Å–ú ==========
        document.addEventListener('DOMContentLoaded', function() {

            // –ü–æ–∏—Å–∫ —É—Å–ª—É–≥ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            const serviceSearch = document.getElementById('service-search');
            if (serviceSearch) {
                serviceSearch.addEventListener('input', function(e) {
                    const search = e.target.value.toLowerCase();
                    document.querySelectorAll('.service-item').forEach(function(item) {
                        const name = item.dataset.serviceName.toLowerCase();
                        item.style.display = name.includes(search) ? 'block' : 'none';
                    });
                });
            }

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏ –∏–∑ –ø—Ä–∞–π—Å–∞
            document.querySelectorAll('.service-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    const id = this.dataset.serviceId;
                    const name = this.dataset.serviceName;
                    const price = this.dataset.servicePrice;

                    if (document.querySelector('#added-svc-' + id)) {
                        alert('–≠—Ç–∞ —É—Å–ª—É–≥–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                        return;
                    }

                    const container = document.getElementById('added-services-container');
                    if (!container) return;

                    const div = document.createElement('div');
                    div.id = 'added-svc-' + id;
                    div.className = 'form-check mb-3 p-3 border rounded bg-light';

                    const userRole = '{{ role }}';
                    const priceDisplay = (userRole === 'admin' || userRole === 'chief_doctor')
                        ? '<span class="badge bg-success float-end">' + parseInt(price).toLocaleString('ru-RU') + ' ‚ÇΩ</span>'
                        : '';

                    div.innerHTML =
                        '<input class="form-check-input service-checkbox" type="checkbox" name="service_ids[]" ' +
                            'value="' + id + '" id="svc-' + id + '" checked data-price="' + price + '">' +
                        '<label class="form-check-label w-100" for="svc-' + id + '">' +
                            '<strong>' + name + '</strong>' +
                            priceDisplay +
                            '<div class="mt-2">' +
                                '<input type="text" class="form-control form-control-sm" ' +
                                    'name="comment_' + id + '" ' +
                                    'placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">' +
                            '</div>' +
                            '<button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeService(\'' + id + '\')">' +
                                '<i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å' +
                            '</button>' +
                        '</label>';

                    container.appendChild(div);

                    div.querySelector('.service-checkbox').addEventListener('change', updateTotal);

                    const modalEl = document.getElementById('addServiceModal');
                    if (modalEl) {
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        if (modal) modal.hide();
                    }

                    updateTotal();
                });
            });

            updateTotal();

            document.querySelectorAll('input[name="service_ids[]"]').forEach(function(cb) {
                cb.addEventListener('change', updateTotal);
            });

        });

        function removeService(serviceId) {
            const element = document.getElementById('added-svc-' + serviceId);
            if (element) {
                element.remove();
                updateTotal();
            }
        }

        function updateTotal() {
            const userRole = '{{ role }}';
            if (userRole !== 'admin' && userRole !== 'chief_doctor') return;

            let total = 0;
            document.querySelectorAll('input[name="service_ids[]"]:checked').forEach(function(checkbox) {
                const priceAttr = checkbox.dataset.price;
                const badgeEl = checkbox.closest('.form-check, .border').querySelector('.badge');
                const priceText = badgeEl ? badgeEl.textContent.replace(/\D/g, '') : '';
                const price = parseInt(priceAttr || priceText || 0);
                total += price;
            });

            const totalElement = document.getElementById('total-amount');
            if (totalElement) {
                totalElement.textContent = total.toLocaleString('ru-RU') + ' ‚ÇΩ';
            }
        }
</script>

{% endblock %}
