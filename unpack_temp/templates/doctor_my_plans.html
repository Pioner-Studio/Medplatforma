{% extends "base.html" %} {% block title %}Мои планы лечения{% endblock %} {%
block content %}
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-clipboard2-pulse"></i> Мои планы лечения</h2>
  </div>

  <!-- Фильтры по статусам -->
  <div class="btn-group mb-3" role="group">
    <button
      type="button"
      class="btn btn-outline-secondary active"
      onclick="filterPlans('all')"
    >
      Все ({{ plans|length }})
    </button>
    <button
      type="button"
      class="btn btn-outline-warning"
      onclick="filterPlans('pending_approval')"
    >
      На согласовании
    </button>
    <button
      type="button"
      class="btn btn-outline-success"
      onclick="filterPlans('approved')"
    >
      Утверждённые
    </button>
    <button
      type="button"
      class="btn btn-outline-secondary"
      onclick="filterPlans('draft')"
    >
      Черновики
    </button>
    <button
      type="button"
      class="btn btn-outline-danger"
      onclick="filterPlans('rejected')"
    >
      Отклонённые
    </button>
  </div>

  {% if plans %}
  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Дата создания</th>
          <th>Пациент</th>
          <th>Количество услуг</th>
          <th>Сумма</th>
          <th>Статус</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody id="plansTableBody">
        {% for plan in plans %}
        <tr data-status="{{ plan.status }}"
            {% if plan.status == 'needs_revision' and not plan.get('comments_viewed_by_doctor', False) %}
            class="table-warning"
            {% endif %}>
          <td>
            {{ plan.created_at.strftime("%d.%m.%Y %H:%M") if plan.created_at
            else "-" }}
          </td>
          <td>
            <a
              href="/patients/{{ plan.patient_id }}"
              class="text-decoration-none"
            >
              {{ plan.patient_name }}
            </a>
          </td>
          <td>{{ plan.services|length }} услуг(и)</td>
          <td>
            <strong
              >{{ "{:,}".format(plan.total_amount).replace(",", " ") }}
              ₽</strong
            >
          </td>
          <td>
            {% if plan.status == 'draft' %}
            <span class="badge bg-secondary">Черновик</span>
            {% elif plan.status == 'pending_approval' %}
            <span class="badge bg-warning">На согласовании</span>
            {% elif plan.status == 'approved' %}
            <span class="badge bg-success">Утверждён</span>
            {% elif plan.status == 'rejected' %}
            <span class="badge bg-danger">Отклонён</span>
            {% elif plan.status == 'needs_revision' %}
            <span class="badge bg-warning text-dark"
              ><i class="bi bi-arrow-counterclockwise"></i> Требует
              доработки</span
            >
            {% endif %}
          </td>
          <td>
            <div class="btn-group" role="group">
              <button class="btn btn-sm btn-info" onclick="showPlanDetails('{{ plan._id }}')">
                <i class="bi bi-eye"></i> Подробнее
              </button>
              {% if plan.status == 'draft' or plan.status == 'needs_revision' %}
              <a href="/patients/{{ plan.patient_id }}/treatment-plan/{{ plan._id }}/edit" class="btn btn-sm btn-warning">
                <i class="bi bi-pencil"></i>
              </a>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="alert alert-info">
    <i class="bi bi-info-circle"></i> У вас пока нет планов лечения
  </div>
  {% endif %}
</div>

<!-- Модальное окно деталей -->
<div class="modal fade" id="planDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Детали плана лечения</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body" id="planDetailsContent">Загрузка...</div>
    </div>
  </div>
</div>

<script>
  function filterPlans(status) {
    const rows = document.querySelectorAll("#plansTableBody tr");
    const buttons = document.querySelectorAll(".btn-group button");

    buttons.forEach((btn) => btn.classList.remove("active"));
    event.target.classList.add("active");

    rows.forEach((row) => {
      if (status === "all" || row.dataset.status === status) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  }

  function showPlanDetails(planId) {
    fetch(`/chief/plan-details/${planId}`)
      .then((r) => r.json())
      .then((data) => {
        let commentsHtml = "";
        if (data.plan_comments && data.plan_comments.length > 0) {
          commentsHtml = `
          <div class="alert alert-warning mt-3">
            <h6><i class="bi bi-chat-left-text"></i> Комментарии главврача:</h6>
            ${data.plan_comments
              .map(
                (c) => `
              <div class="border-start border-3 border-warning ps-3 mb-2">
                <small class="text-muted">${c.author_name} (${
                  c.author_role
                })</small><br>
                <strong>${c.text}</strong>
                <br><small class="text-muted">${new Date(
                  c.created_at
                ).toLocaleString("ru-RU")}</small>
              </div>
            `
              )
              .join("")}
          </div>
        `;
        }

        document.getElementById("planDetailsContent").innerHTML = `
        <h6>Пациент: ${data.patient_name}</h6>
        <hr>
        <h6>Услуги:</h6>
        <table class="table table-sm">
          <thead><tr><th>Услуга</th><th>Цена</th><th>Комментарий</th></tr></thead>
          <tbody>
            ${data.services
              .map(
                (s) => `
              <tr>
                <td>${s.service_name}</td>
                <td>${s.price.toLocaleString()} ₽</td>
                <td>${s.comment || "-"}</td>
              </tr>
            `
              )
              .join("")}
          </tbody>
        </table>
        <h5 class="mt-3">Итого: ${data.total_amount.toLocaleString()} ₽</h5>
        ${
          data.notes
            ? `<p class="mt-3"><strong>Примечания:</strong><br>${data.notes}</p>`
            : ""
        }
        ${commentsHtml}
      `;
        new bootstrap.Modal(document.getElementById("planDetailsModal")).show();
      });
  }

// Автоперезагрузка после закрытия модального окна с комментариями
document.getElementById("planDetailsModal").addEventListener('hidden.bs.modal', function () {
  location.reload();
});
</script>
{% endblock %}
