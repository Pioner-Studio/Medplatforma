{% extends "base.html" %}
{% block title %}–°–ø–∏—Å–æ–∫ –¥–æ–ª–∂–Ω–∏–∫–æ–≤{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2><i class="fa fa-exclamation-circle text-danger"></i> –°–ø–∏—Å–æ–∫ –¥–æ–ª–∂–Ω–∏–∫–æ–≤</h2>
          <p class="text-muted">–ü–∞—Ü–∏–µ–Ω—Ç—ã —Å –Ω–µ–ø–æ–≥–∞—à–µ–Ω–Ω–æ–π –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å—é</p>
        </div>
        <div class="text-end">
          <div class="fs-5 text-muted">–í—Å–µ–≥–æ –¥–æ–ª–∂–Ω–∏–∫–æ–≤:</div>
          <div class="fs-3 fw-bold text-danger">{{ count }}</div>
          <div class="fs-6 text-muted">–Ω–∞ —Å—É–º–º—É <strong>{{ "{:,}".format(total_debt).replace(',', ' ') }} ‚ÇΩ</strong></div>
        </div>
      </div>
    </div>
  </div>

  {% if debtors %}
  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="bg-light">
            <tr>
              <th class="px-4 py-3">‚Ññ</th>
              <th>–ü–∞—Ü–∏–µ–Ω—Ç</th>
              <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
              <th>–ö–∞—Ä—Ç–∞ ‚Ññ</th>
              <th class="text-end">–°—É–º–º–∞ –¥–æ–ª–≥–∞</th>
              <th class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody>
            {% for debtor in debtors %}
            <tr>
              <td class="px-4">{{ loop.index }}</td>
              <td>
                <a href="/patients/{{ debtor._id }}" class="text-decoration-none fw-semibold">
                  {{ debtor.full_name }}
                </a>
              </td>
              <td>{{ debtor.phone or '‚Äî' }}</td>
              <td><span class="badge bg-secondary">{{ debtor.card_no }}</span></td>
              <td class="text-end">
                <span class="badge bg-danger fs-6">{{ "{:,}".format(debtor.debt_balance).replace(',', ' ') }} ‚ÇΩ</span>
              </td>
              <td class="text-center">
                <a href="/patients/{{ debtor._id }}" class="btn btn-sm btn-outline-primary">
                  <i class="fa fa-eye"></i> –ö–∞—Ä—Ç–∞
                </a>
                <button class="btn btn-sm btn-success" onclick="payDebt('{{ debtor._id }}', '{{ debtor.full_name }}', {{ debtor.debt_balance }})">
                  <i class="fa fa-money-bill"></i> –ü–æ–≥–∞—Å–∏—Ç—å
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% else %}
  <div class="alert alert-success text-center py-5">
    <i class="fa fa-check-circle fa-3x mb-3"></i>
    <h4>–î–æ–ª–∂–Ω–∏–∫–æ–≤ –Ω–µ—Ç!</h4>
    <p class="mb-0">–í—Å–µ –ø–∞—Ü–∏–µ–Ω—Ç—ã –ø–æ–≥–∞—Å–∏–ª–∏ —Å–≤–æ–∏ –¥–æ–ª–≥–∏ üéâ</p>
  </div>
  {% endif %}
</div>

<script>
function payDebt(patientId, patientName, debtAmount) {
  if (confirm(`–ü–æ–≥–∞—Å–∏—Ç—å –¥–æ–ª–≥ ${debtAmount}‚ÇΩ –¥–ª—è ${patientName}?`)) {
    window.location.href = `/finance/add?patient_id=${patientId}&amount=${debtAmount}&kind=debt_payment`;
  }
}
</script>
{% endblock %}
