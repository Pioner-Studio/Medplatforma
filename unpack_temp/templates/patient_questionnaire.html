{% extends "base.html" %} {% block title %}Медицинская анкета - {{
patient.full_name }}{% endblock %} {% block content %}
<div class="container-fluid">
  <!-- Хлебные крошки -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{{ url_for('patients_list') }}">Пациенты</a>
      </li>
      <li class="breadcrumb-item">
        <a href="/patients/{{ patient._id }}">{{ patient.full_name }}</a>
      </li>
      <li class="breadcrumb-item active">Медицинская анкета</li>
    </ol>
  </nav>

  <!-- Заголовок -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="fas fa-file-medical me-2"></i>Медицинская анкета</h2>
      <p class="text-muted mb-0">
        Пациент: <strong>{{ patient.full_name }}</strong>
      </p>
    </div>
    <div>
      {% if patient.get('questionnaire_filled', False) %}
      <span class="badge bg-success fs-6">
        <i class="fas fa-check-circle me-1"></i>Анкета заполнена
      </span>
      {% else %}
      <span class="badge bg-warning fs-6">
        <i class="fas fa-exclamation-triangle me-1"></i>Анкета не заполнена
      </span>
      {% endif %}
    </div>
  </div>

  <!-- Форма анкеты -->
  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-clipboard-list me-2"></i>Медицинские данные
          </h5>
        </div>
        <div class="card-body">
          <form method="POST" id="questionnaireForm">
            <!-- 1. Аллергии -->
            <div class="mb-4">
              <h6 class="text-primary mb-3">
                <i class="fas fa-allergies me-2"></i>1. Аллергические реакции
              </h6>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox"
                id="has_allergies" name="has_allergies" {% if
                questionnaire.get('allergies', {}).get('has_allergies')
                %}checked{% endif %} />
                <label class="form-check-label fw-bold" for="has_allergies">
                  Есть аллергические реакции на медикаменты
                </label>
              </div>
              <div class="mb-3">
                <label for="allergies_details" class="form-label"
                  >Если да, то на какие:</label
                >
                <textarea
                  class="form-control"
                  id="allergies_details"
                  name="allergies_details"
                  rows="2"
                  placeholder="Укажите медикаменты и тип реакции"
                >
{{ questionnaire.get('allergies', {}).get('details', '') }}</textarea
                >
              </div>
            </div>

            <hr />

            <!-- 2. Сердечно-сосудистые заболевания -->
            <div class="mb-4">
              <h6 class="text-primary mb-3">
                <i class="fas fa-heartbeat me-2"></i>2. Сердечно-сосудистая
                система
              </h6>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox"
                id="has_heart_conditions" name="has_heart_conditions" {% if
                questionnaire.get('heart_conditions', {}).get('has_conditions')
                %}checked{% endif %} />
                <label
                  class="form-check-label fw-bold"
                  for="has_heart_conditions"
                >
                  Есть заболевания сердечно-сосудистой системы
                </label>
              </div>
              <div class="mb-3">
                <label for="heart_conditions_details" class="form-label"
                  >Если да, то какие:</label
                >
                <textarea
                  class="form-control"
                  id="heart_conditions_details"
                  name="heart_conditions_details"
                  rows="2"
                  placeholder="Укажите заболевания, принимаемые препараты"
                >
{{ questionnaire.get('heart_conditions', {}).get('details', '') }}</textarea
                >
              </div>
            </div>

            <hr />

            <!-- 3. Хронические заболевания -->
            <div class="mb-4">
              <h6 class="text-primary mb-3">
                <i class="fas fa-notes-medical me-2"></i>3. Хронические
                заболевания
              </h6>
              <div class="row">
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox"
                    id="diabetes" name="diabetes" {% if
                    questionnaire.get('chronic_diseases', {}).get('diabetes')
                    %}checked{% endif %} />
                    <label class="form-check-label" for="diabetes"
                      >Сахарный диабет</label
                    >
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="asthma"
                    name="asthma" {% if questionnaire.get('chronic_diseases',
                    {}).get('asthma') %}checked{% endif %} />
                    <label class="form-check-label" for="asthma"
                      >Бронхиальная астма</label
                    >
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox"
                    id="oncology" name="oncology" {% if
                    questionnaire.get('chronic_diseases', {}).get('oncology')
                    %}checked{% endif %} />
                    <label class="form-check-label" for="oncology"
                      >Онкологические заболевания</label
                    >
                  </div>
                </div>
              </div>
            </div>

            <hr />

            <!-- 4. Беременность -->
            <div class="mb-4">
              <h6 class="text-primary mb-3">
                <i class="fas fa-female me-2"></i>4. Женское здоровье
              </h6>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="pregnancy"
                name="pregnancy" {% if questionnaire.get('pregnancy')
                %}checked{% endif %} />
                <label class="form-check-label fw-bold" for="pregnancy"
                  >Беременность</label
                >
              </div>
            </div>

            <hr />

            <!-- 5. Травмы челюстно-лицевой области -->
            <div class="mb-4">
              <h6 class="text-primary mb-3">
                <i class="fas fa-head-side-mask me-2"></i>5. Стоматологический
                анамнез
              </h6>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox"
                id="has_dental_trauma" name="has_dental_trauma" {% if
                questionnaire.get('dental_trauma', {}).get('has_trauma')
                %}checked{% endif %} />
                <label class="form-check-label fw-bold" for="has_dental_trauma">
                  Травмы челюстно-лицевой области
                </label>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <label for="dental_trauma_when" class="form-label"
                    >Когда:</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="dental_trauma_when"
                    name="dental_trauma_when"
                    value="{{ questionnaire.get('dental_trauma', {}).get('when', '') }}"
                    placeholder="Дата или период"
                  />
                </div>
                <div class="col-md-6">
                  <label for="dental_trauma_details" class="form-label"
                    >Характер травмы:</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="dental_trauma_details"
                    name="dental_trauma_details"
                    value="{{ questionnaire.get('dental_trauma', {}).get('details', '') }}"
                    placeholder="Описание травмы"
                  />
                </div>
              </div>
            </div>

            <hr />

            <!-- 6. Курение -->
            <div class="mb-4">
              <h6 class="text-primary mb-3">
                <i class="fas fa-smoking-ban me-2"></i>6. Вредные привычки
              </h6>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="smokes"
                name="smokes" {% if questionnaire.get('smoking',
                {}).get('smokes') %}checked{% endif %} />
                <label class="form-check-label fw-bold" for="smokes"
                  >Курение</label
                >
              </div>
              <div class="mb-3">
                <label for="smoking_duration" class="form-label"
                  >Стаж курения:</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="smoking_duration"
                  name="smoking_duration"
                  value="{{ questionnaire.get('smoking', {}).get('duration', '') }}"
                  placeholder="Например: 5 лет, пачка в день"
                />
              </div>
            </div>

            <hr />

            <!-- 7. Дополнительные сведения (Прочее) -->
            <div class="mb-4">
              <h6 class="text-primary mb-3">
                <i class="fas fa-notes-medical me-2"></i>7. Дополнительные
                сведения
              </h6>
              <div class="mb-3">
                <label for="other_notes" class="form-label">
                  Прочие важные сведения о здоровье, не вошедшие в предыдущие
                  разделы:
                </label>
                <textarea
                  class="form-control"
                  id="other_notes"
                  name="other_notes"
                  rows="4"
                  placeholder="Например: особенности психологического состояния, специфические пожелания, рекомендации других специалистов, непереносимость определенных материалов и т.д."
                >
>{{ patient.get('medical_questionnaire', {}).get('other_notes', '') }}</textarea
                >
                <small class="form-text text-muted">
                  Любая дополнительная информация, которая может быть важна для
                  вашего лечения
                </small>
              </div>
            </div>

            <!-- 8. Согласие и подпись -->
            <div class="mb-4">
              <h6 class="text-primary mb-3">
                <i class="fas fa-signature me-2"></i>8. Согласие и подпись
              </h6>
              <div class="alert alert-info">
                <small>
                  Подтверждаю, что предоставленная информация является
                  достоверной и полной. Даю согласие на обработку персональных
                  данных в медицинских целях.
                </small>
              </div>
              <div class="mb-3">
                <label for="signature" class="form-label"
                  >ФИО пациента или законного представителя:</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="signature"
                  name="signature"
                  required
                  value="{{ patient.get('questionnaire_signature', '') }}"
                  placeholder="Введите полное ФИО для подтверждения"
                />
              </div>
            </div>

            <!-- Кнопки -->
            <div class="d-flex justify-content-between">
              <a
                href="{{ url_for('patient_card', id=patient._id) }}"
                class="btn btn-secondary"
              >
                <i class="fas fa-arrow-left me-1"></i>Назад к карте
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i>Сохранить анкету
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Боковая панель с информацией -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">
          <h6 class="card-title mb-0">Информация о пациенте</h6>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <strong>ФИО:</strong><br />
            {{ patient.full_name }}
          </div>
          <div class="mb-3">
            <strong>Дата рождения:</strong><br />
            {{ patient.get('birthdate', '—') }}
          </div>
          <div class="mb-3">
            <strong>Телефон:</strong><br />
            {{ patient.get('phone', '—') }}
          </div>
          <div class="mb-3">
            <strong>Карта №:</strong><br />
            {{ patient.get('card_no', '—') }}
          </div>

          {% if patient.get('questionnaire_filled') and
          patient.get('questionnaire_date') %}
          <div class="alert alert-success">
            <small>
              <strong>Анкета заполнена:</strong><br />
              {{ patient.questionnaire_date.strftime('%d.%m.%Y %H:%M') if
              patient.questionnaire_date else 'Н/Д' }}
            </small>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Важная информация -->
      <div class="card mt-3">
        <div class="card-header bg-warning text-dark">
          <h6 class="card-title mb-0">
            <i class="fas fa-exclamation-triangle me-2"></i>Важно!
          </h6>
        </div>
        <div class="card-body">
          <small>
            • Заполните все значимые поля<br />
            • При аллергиях обязательно укажите детали<br />
            • Информация используется для безопасности лечения<br />
            • Данные защищены медицинской тайной
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const toggleFields = {
      has_allergies: "allergies_details",
      has_heart_conditions: "heart_conditions_details",
      has_dental_trauma: ["dental_trauma_when", "dental_trauma_details"],
      smokes: "smoking_duration",
    };

    Object.keys(toggleFields).forEach((checkboxId) => {
      const checkbox = document.getElementById(checkboxId);
      const fieldIds = Array.isArray(toggleFields[checkboxId])
        ? toggleFields[checkboxId]
        : [toggleFields[checkboxId]];

      function toggleVisibility() {
        fieldIds.forEach((fieldId) => {
          const field = document.getElementById(fieldId);
          if (field) {
            field.style.opacity = checkbox.checked ? "1" : "0.5";
            field.disabled = !checkbox.checked;
            if (!checkbox.checked) field.value = "";
          }
        });
      }

      checkbox.addEventListener("change", toggleVisibility);
      toggleVisibility();
    });

    document
      .getElementById("questionnaireForm")
      .addEventListener("submit", function (e) {
        const signature = document.getElementById("signature").value.trim();
        if (signature.length < 3) {
          e.preventDefault();
          alert("Пожалуйста, введите полное ФИО для подтверждения");
          document.getElementById("signature").focus();
        }
      });
  });
</script>
{% endblock %}
